<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS · Playbook</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob: https://*.amazonaws.com https://*.notion.so; connect-src 'self' https://notion-proxy.churan756.workers.dev https://api.anthropic.com; frame-ancestors 'none';">
<link rel="stylesheet" href="core/style.css">
<style>
.week-nav{display:flex;align-items:center;gap:12px;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:18px}
.wn-btn{background:var(--s2);border:1px solid var(--b2);border-radius:4px;color:var(--t2);font-size:.7rem;padding:6px 14px;cursor:pointer;transition:all .12s;font-family:var(--ff)}
.wn-btn:hover{border-color:var(--b3);color:var(--text)}.wn-btn:disabled{opacity:.35;cursor:default}
.wn-label{font-family:var(--fd);font-size:.75rem;font-weight:700;flex:1;text-align:center}
.wn-status{font-size:.48rem;color:var(--m2);letter-spacing:1px}
.lock-banner{background:rgba(245,166,35,.07);border:1px solid rgba(245,166,35,.2);border-radius:6px;padding:9px 14px;font-size:.56rem;color:var(--amber);margin-bottom:14px}
.review-score{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:14px}
.score-btn{padding:10px;border:1px solid var(--b2);border-radius:6px;background:var(--s2);font-family:var(--fd);font-size:1rem;font-weight:800;cursor:pointer;transition:all .12s;text-align:center}
.score-btn:hover{border-color:var(--b3)}
.score-btn.selected{border-color:var(--green);background:rgba(0,212,122,.1)}
.week-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
.chart-img-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.chart-img-card{border:1px solid var(--b2);border-radius:8px;overflow:hidden;cursor:pointer}
.chart-img-card img{width:100%;display:block}
.chart-img-lbl{font-size:.46rem;color:var(--m2);padding:5px 8px;background:var(--s2)}
</style>
</head>
<body>

<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR —</div>
    <div class="nav-px" id="np-xau">XAU —</div>
    <div class="nav-px" id="np-dxy">DXY —</div>
    <div class="nav-dot" id="nav-dot"></div>
  </div>
</nav>
<div id="alert-bar"></div>

<div id="token-screen">
  <div class="ts-logo">TRADE<span>OS</span></div>
  <div class="ts-box">
    <h2>Connect Notion</h2>
    <p>Enter your Notion integration token.<br>Get one at <strong>notion.so/my-integrations</strong></p>
    <input class="ts-inp" id="ts-inp" type="password" placeholder="ntn_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" onkeydown="if(event.key==='Enter')doSaveToken()">
    <label class="ts-remember"><input type="checkbox" id="ts-remember"> Remember on this device</label>
    <button class="ts-btn" onclick="doSaveToken()">CONNECT →</button>
    <div class="ts-note">Token validated · Clears on tab close unless remembered · Never sent to third parties</div>
  </div>
</div>

<div class="modal-ov" id="del-modal">
  <div class="modal-box" style="max-width:400px">
    <div class="modal-hdr"><div class="modal-title">Delete week?</div><button class="modal-close" onclick="document.getElementById('del-modal').classList.remove('open')">✕</button></div>
    <div style="font-size:.6rem;color:var(--t2);line-height:1.7;margin-bottom:18px">This archives the Notion page. The data won't be permanently deleted but will be hidden from TradeOS.</div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="document.getElementById('del-modal').classList.remove('open')">Cancel</button>
      <button class="btn btn-r" id="del-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<div class="wrap">

  <div class="shdr" style="margin-bottom:18px">
    <div class="shdr-title">Weekly Playbook</div>
    <div class="shdr-line"></div>
    <div class="shdr-sub" id="sync-status">Connecting…</div>
  </div>

  <div class="week-nav">
    <button class="wn-btn" onclick="weekNav(-1)">‹ Prev</button>
    <div class="wn-label" id="week-label">—</div>
    <div class="wn-status" id="week-status"></div>
    <button class="wn-btn" id="wn-next" onclick="weekNav(1)" disabled>Next ›</button>
  </div>

  <div id="lock-banner" class="lock-banner" style="display:none">Past week — plan is locked. Review is still editable.</div>

  <!-- Stats from journal for this week -->
  <div class="week-stats" id="week-stats" style="display:none">
    <div class="kpi"><div class="kpi-l">This Week R</div><div class="kpi-v" id="ws-r">—</div></div>
    <div class="kpi"><div class="kpi-l">Win Rate</div><div class="kpi-v" id="ws-wr">—</div></div>
    <div class="kpi"><div class="kpi-l">Trades</div><div class="kpi-v" id="ws-trades">—</div></div>
    <div class="kpi"><div class="kpi-l">Best Setup</div><div class="kpi-v" id="ws-grade">—</div></div>
  </div>

  <div class="tabs">
    <button class="tab on" onclick="setTab('plan',this)">Plan</button>
    <button class="tab" onclick="setTab('review',this)">Review</button>
    <button class="tab" onclick="setTab('charts',this)">Charts</button>
  </div>

  <!-- PLAN -->
  <div class="tab-panel show" id="tab-plan">
    <div class="row2">
      <div class="field"><label class="inp-label">Weekly Bias</label>
        <select class="inp" id="f-bias"><option value="">Select…</option><option>Bullish</option><option>Bearish</option><option>Neutral</option><option>Cautious</option></select></div>
      <div class="field"><label class="inp-label">DXY Outlook</label>
        <select class="inp" id="f-dxy"><option value="">Select…</option><option>DXY Bullish</option><option>DXY Bearish</option><option>DXY Neutral</option></select></div>
    </div>
    <div class="row3">
      <div class="field"><label class="inp-label">EUR/USD Key Levels</label><input class="inp" id="f-eur" placeholder="1.0820, 1.0750…"></div>
      <div class="field"><label class="inp-label">GBP/USD Key Levels</label><input class="inp" id="f-gbp" placeholder="1.2680, 1.2600…"></div>
      <div class="field"><label class="inp-label">XAU/USD Key Levels</label><input class="inp" id="f-xau" placeholder="2320, 2290…"></div>
    </div>
    <div class="field"><label class="inp-label">Weekly Narrative</label>
      <textarea class="inp" id="f-narrative" rows="4" placeholder="Key themes, central bank events, risk catalysts, session focus…"></textarea></div>
    <div class="field"><label class="inp-label">Pairs to Focus</label><input class="inp" id="f-pairs" placeholder="EUR/USD, XAU/USD…"></div>
    <div class="field"><label class="inp-label">Max Risk This Week (%)</label><input class="inp" id="f-maxrisk" type="number" placeholder="1.0" step="0.1" style="width:160px"></div>

    <div class="shdr" style="margin-top:6px"><div class="shdr-title" style="font-size:.65rem">Pre-Week Checklist</div><div class="shdr-line"></div></div>
    <div class="checklist">
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>Reviewed D1 & W1 structure for all focus pairs</label></div>
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>Identified key weekly POIs, discount/premium zones</label></div>
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>Checked economic calendar — marked high-impact times</label></div>
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>DXY analysis complete — direction clear</label></div>
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>Reviewed last week's trades and recurring mistakes</label></div>
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>Set price alerts for key levels in TradeOS</label></div>
      <div class="check-item" onclick="toggleCheck(this)"><input type="checkbox" onclick="event.stopPropagation()"><label>Confirmed risk per trade — no FOMO sizing</label></div>
    </div>

    <div class="save-bar">
      <button class="btn btn-g" onclick="savePlan()" id="save-plan-btn">Save to Notion</button>
      <button class="btn btn-r" onclick="document.getElementById('del-modal').classList.add('open')">Delete Week</button>
      <span class="save-msg" id="save-plan-msg"></span>
    </div>
  </div>

  <!-- REVIEW -->
  <div class="tab-panel" id="tab-review">
    <div class="field">
      <label class="inp-label" style="margin-bottom:10px">Week Grade</label>
      <div class="review-score" id="review-score">
        <div class="score-btn" onclick="selectGrade(this,'A')">A</div>
        <div class="score-btn" onclick="selectGrade(this,'B')">B</div>
        <div class="score-btn" onclick="selectGrade(this,'C')">C</div>
        <div class="score-btn" onclick="selectGrade(this,'D')">D</div>
        <div class="score-btn" onclick="selectGrade(this,'F')">F</div>
      </div>
    </div>
    <div class="field"><label class="inp-label">What worked this week</label>
      <textarea class="inp" id="r-worked" rows="3" placeholder="Setups, sessions, execution quality…"></textarea></div>
    <div class="field"><label class="inp-label">Mistakes / what broke the plan</label>
      <textarea class="inp" id="r-mistakes" rows="3" placeholder="FOMO, moving SL, off-session trades, sizing errors…"></textarea></div>
    <div class="field"><label class="inp-label">Key lesson — ONE thing to fix next week</label>
      <textarea class="inp" id="r-lesson" rows="2" placeholder="One focused improvement…"></textarea></div>

    <!-- AI Week Reviewer -->
    <div class="ai-panel" style="margin-top:16px">
      <div class="ai-hdr">◈ AI Weekly Reviewer</div>
      <div class="ai-chips">
        <span class="ai-chip" onclick="reviewAI('Review my week based on the journal data and give me specific improvements')">Review my week</span>
        <span class="ai-chip" onclick="reviewAI('What patterns are recurring in my losing trades?')">Recurring mistakes</span>
        <span class="ai-chip" onclick="reviewAI('Am I improving week over week based on my journal stats?')">Am I improving?</span>
      </div>
      <div class="ai-response loading" id="review-ai-response">Tap a question to get an AI review of your performance.</div>
    </div>

    <div class="save-bar">
      <button class="btn btn-g" onclick="saveReview()">Save Review</button>
      <span class="save-msg" id="save-review-msg"></span>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="tab-panel" id="tab-charts">
    <div id="charts-area"><div class="empty"><strong>No charts</strong>Attach screenshots to this week's Notion page to see them here.</div></div>
  </div>

</div>

<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-dxy"><span class="ps-sym">DXY</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-xau"><span class="ps-sym">XAU/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">○ Loading</span>
  </div>
</div>

<script src="core/config.js"></script>
<script src="core/security.js"></script>
<script src="core/state.js"></script>
<script src="core/api.js"></script>
<script src="core/engines.js"></script>
<script>
'use strict';
const PAGE_ID = 'playbook';
let _weekOffset = 0, _currentPageId = null, _selectedGrade = '';

function doSaveToken() {
  const val = document.getElementById('ts-inp').value.trim();
  const persist = document.getElementById('ts-remember').checked;
  if (!TokenStore.ok(val)) { const el=document.getElementById('ts-inp');el.style.borderColor='var(--red)';setTimeout(()=>el.style.borderColor='',1400);return; }
  TokenStore.set(val, persist);
  document.getElementById('token-screen').classList.remove('show');
  document.getElementById('ts-inp').value='';
  loadPlaybook();
}

function getWeekDates(offset=0) {
  const now=new Date(), dow=now.getDay();
  const mon=new Date(now); mon.setDate(now.getDate()-(dow===0?6:dow-1)+offset*7); mon.setHours(0,0,0,0);
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  return {
    mon, sun,
    key: mon.toISOString().slice(0,10),
    label: `${mon.toLocaleDateString('en-US',{month:'short',day:'numeric'})} – ${sun.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`,
    isPast: sun < new Date(),
  };
}

function weekNav(dir) {
  if(dir===1 && _weekOffset>=0) return;
  _weekOffset+=dir;
  document.getElementById('wn-next').disabled = _weekOffset>=0;
  loadPlaybook();
}

async function loadPlaybook() {
  if(!TokenStore.ok(TokenStore.get())) { document.getElementById('token-screen').classList.add('show'); return; }
  const {key,label,isPast} = getWeekDates(_weekOffset);
  document.getElementById('week-label').textContent = label;
  document.getElementById('week-status').textContent = 'Loading…';
  document.getElementById('sync-status').textContent = 'Syncing…';
  document.getElementById('lock-banner').style.display = isPast ? 'block' : 'none';
  const planInputs = ['f-bias','f-dxy','f-eur','f-gbp','f-xau','f-narrative','f-pairs','f-maxrisk'];
  planInputs.forEach(id => { const el=document.getElementById(id); if(el) el.disabled=isPast; });
  document.getElementById('save-plan-btn').disabled = isPast;

  try {
    const pages = await API.queryPlaybook();
    const match = pages.find(pg => {
      const props = pg.properties;
      const dateKey = Object.keys(props).find(k=>k.toLowerCase().includes('date')||k.toLowerCase().includes('week'));
      if(!dateKey) return false;
      const d = props[dateKey]?.date?.start || props[dateKey]?.rich_text?.[0]?.plain_text || '';
      return d.startsWith(key);
    });

    if(match) {
      _currentPageId = match.id;
      populateForm(match.properties);
      loadWeekStats(key);
      loadCharts(match.properties);
      document.getElementById('week-status').textContent = '● Synced';
      document.getElementById('sync-status').textContent = 'Notion · Synced';
    } else {
      _currentPageId = null;
      clearForm();
      document.getElementById('week-status').textContent = '○ New week';
      document.getElementById('sync-status').textContent = 'Notion · Connected';
    }
    document.getElementById('nav-dot').className='nav-dot on';
  } catch(e) {
    document.getElementById('week-status').textContent = '✕ '+e.message.slice(0,40);
    document.getElementById('sync-status').textContent = 'Error';
    document.getElementById('nav-dot').className='nav-dot err';
  }
}

function loadWeekStats(weekKey) {
  const stats = State.get('journalStats');
  if(!stats?.byDay) return;
  const w = getWeekDates(_weekOffset);
  const weekTrades = Object.entries(stats.byDay)
    .filter(([d])=>d>=w.key && d<=w.sun.toISOString().slice(0,10))
    .flatMap(([,t])=>t);
  if(!weekTrades.length) return;
  const wins=weekTrades.filter(t=>t.outcome==='Win');
  const r=weekTrades.reduce((s,t)=>s+(t.rMultiple||0),0);
  document.getElementById('week-stats').style.display='grid';
  document.getElementById('ws-r').textContent=(r>=0?'+':'')+r.toFixed(2)+'R';
  document.getElementById('ws-r').style.color=r>=0?'var(--green)':'var(--red)';
  document.getElementById('ws-wr').textContent=Math.round(wins.length/weekTrades.length*100)+'%';
  document.getElementById('ws-trades').textContent=weekTrades.length;
  const grades=weekTrades.reduce((acc,t)=>{acc[t.grade]=(acc[t.grade]||0)+1;return acc},{});
  document.getElementById('ws-grade').textContent=Object.entries(grades).sort((a,b)=>b[1]-a[1])[0]?.[0]||'—';
}

function getP(props, q, type) {
  const k=Object.keys(props).find(k=>k.toLowerCase().includes(q.toLowerCase()));
  if(!k)return'';const p=props[k];
  if(type==='select')return p.select?.name||'';
  if(type==='rich_text')return(p.rich_text||[]).map(r=>r.plain_text).join('');
  if(type==='title')return(p.title||[]).map(r=>r.plain_text).join('');
  return'';
}

function populateForm(props) {
  const s=(id,q,t)=>{const v=getP(props,q,t);const el=document.getElementById(id);if(el&&v)el.value=v;};
  s('f-bias','bias','select');s('f-dxy','dxy','select');
  s('f-eur','eur','rich_text');s('f-gbp','gbp','rich_text');s('f-xau','xau','rich_text');
  s('f-narrative','narrative','rich_text');s('f-pairs','pairs','rich_text');s('f-maxrisk','risk','rich_text');
  s('r-worked','worked','rich_text');s('r-mistakes','mistake','rich_text');s('r-lesson','lesson','rich_text');
  const grade=getP(props,'grade','select');
  if(grade){
    document.querySelectorAll('.score-btn').forEach(b=>{if(b.textContent===grade){b.classList.add('selected');_selectedGrade=grade;}});
  }
}

function clearForm() {
  ['f-bias','f-dxy','f-eur','f-gbp','f-xau','f-narrative','f-pairs','f-maxrisk','r-worked','r-mistakes','r-lesson'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.querySelectorAll('.check-item').forEach(el=>{el.classList.remove('checked');el.querySelector('input').checked=false;});
  document.querySelectorAll('.score-btn').forEach(b=>b.classList.remove('selected'));
  _selectedGrade='';
  document.getElementById('week-stats').style.display='none';
}

function loadCharts(props) {
  const area=document.getElementById('charts-area');
  const imgs=[];
  Object.values(props).forEach(p=>{if(p.type==='files')(p.files||[]).forEach(f=>{const url=f.file?.url||f.external?.url||'';if(url)imgs.push({name:f.name||'Chart',url:escUrl(url)});});});
  if(imgs.length){
    area.innerHTML=`<div class="chart-img-grid">${imgs.map(img=>`<div class="chart-img-card" onclick="window.open('${img.url}','_blank','noopener,noreferrer')"><img src="${img.url}" loading="lazy" onerror="this.parentElement.style.display='none'"><div class="chart-img-lbl">${esc(img.name)}</div></div>`).join('')}</div>`;
  } else {
    area.innerHTML='<div class="empty"><strong>No charts</strong>Attach screenshots to this Notion page to see them here.</div>';
  }
}

function buildProps(fields) {
  const {key,label}=getWeekDates(_weekOffset);
  const props={'Week':{title:[{text:{content:label}}]},'Date':{date:{start:key}}};
  const t=(name,val)=>{if(val)props[name]={rich_text:[{text:{content:val.slice(0,2000)}}]};};
  const s=(name,val)=>{if(val)props[name]={select:{name:val}};};
  if(fields.plan){
    s('Bias',document.getElementById('f-bias').value);s('DXY',document.getElementById('f-dxy').value);
    t('EUR/USD Levels',document.getElementById('f-eur').value);t('GBP/USD Levels',document.getElementById('f-gbp').value);
    t('XAU/USD Levels',document.getElementById('f-xau').value);t('Narrative',document.getElementById('f-narrative').value);
    t('Focus Pairs',document.getElementById('f-pairs').value);t('Max Risk',document.getElementById('f-maxrisk').value);
    const checked=[...document.querySelectorAll('.check-item.checked label')].map(l=>'✓ '+l.textContent).join('\n');
    if(checked)t('Checklist',checked);
  }
  if(fields.review){
    s('Review Grade',_selectedGrade);
    t('What Worked',document.getElementById('r-worked').value);
    t('Mistakes',document.getElementById('r-mistakes').value);
    t('Lesson',document.getElementById('r-lesson').value);
  }
  return props;
}

async function savePlan() {
  const btn=document.getElementById('save-plan-btn'),msg=document.getElementById('save-plan-msg');
  btn.disabled=true;msg.textContent='Saving…';msg.className='save-msg';
  try{
    const props=buildProps({plan:true});
    if(_currentPageId){await API.updatePage(_currentPageId,props);}
    else{const res=await API.createPage(Config.DB.PLAYBOOK,props);_currentPageId=res.id||null;}
    msg.className='save-msg ok';msg.textContent='✓ Saved';
  }catch(e){msg.className='save-msg err';msg.textContent='✕ '+e.message.slice(0,50);}
  btn.disabled=false;setTimeout(()=>msg.textContent='',3000);
}

async function saveReview() {
  const msg=document.getElementById('save-review-msg');
  msg.textContent='Saving…';msg.className='save-msg';
  try{
    const props=buildProps({review:true});
    if(_currentPageId){await API.updatePage(_currentPageId,props);}
    else{const res=await API.createPage(Config.DB.PLAYBOOK,props);_currentPageId=res.id||null;}
    msg.className='save-msg ok';msg.textContent='✓ Saved';
  }catch(e){msg.className='save-msg err';msg.textContent='✕ '+e.message.slice(0,50);}
  setTimeout(()=>msg.textContent='',3000);
}

async function confirmDelete() {
  if(!_currentPageId)return;
  const btn=document.getElementById('del-btn');btn.disabled=true;btn.textContent='Deleting…';
  try{
    await API.deletePage(_currentPageId);
    _currentPageId=null;clearForm();
    document.getElementById('week-status').textContent='○ Deleted';
    document.getElementById('del-modal').classList.remove('open');
  }catch(e){btn.textContent='Error';}
  btn.disabled=false;btn.textContent='Delete';
}

async function reviewAI(question) {
  const el=document.getElementById('review-ai-response');
  el.className='ai-response loading';el.textContent='Analysing…';
  try{const a=await AIEngine.ask(question,'reviewer');el.className='ai-response';el.textContent=a;}
  catch(e){el.className='ai-response';el.textContent='Error: '+e.message;}
}

function selectGrade(btn, grade) {
  document.querySelectorAll('.score-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected'); _selectedGrade=grade;
}

function setTab(id,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('show'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('tab-'+id).classList.add('show');btn.classList.add('on');
}

function toggleCheck(el){const cb=el.querySelector('input');cb.checked=!cb.checked;el.classList.toggle('checked',cb.checked);}

window.addEventListener('DOMContentLoaded', () => {
  NavEngine.init(PAGE_ID);
  PriceEngine.start();
  if(!TokenStore.ok(TokenStore.get())){ document.getElementById('token-screen').classList.add('show'); }
  else { loadPlaybook(); }
});
</script>
</body>
</html>
