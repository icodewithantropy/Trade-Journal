<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS · Analytics</title>

<!-- ── CSP: block XSS exfiltration even if injection occurs ── -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com;
  img-src 'self' data: blob: https://*.amazonaws.com https://*.notion.so;
  connect-src 'self' https://notion-proxy.churan756.workers.dev https://notion-proxy.icodewithantropy.workers.dev;
  frame-ancestors 'none';
">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
/* ══════════════════════════════════════════════════════════
   DESIGN SYSTEM — Suffocated Minimal
   Dense, dark, terminal precision. No decoration.
   Color = signal only. Space = intentional.
══════════════════════════════════════════════════════════ */
:root {
  --bg:    #04060a; --s1: #07090f; --s2: #0a0e17; --s3: #0e141f;
  --s4:    #121a26; --border: #182030; --b2: #1d2838; --b3: #243344;
  --text:  #d2d8e6; --t2: #9aaabb; --muted: #374a60; --m2: #546880;
  --green: #00d47a; --red: #ff2d55; --amber: #f5a623;
  --blue:  #3d8eff; --cyan: #00c4f5; --purple: #9b6bff;
  --nav-h: 46px; --strip-h: 32px;
  --ff: 'JetBrains Mono', monospace;
  --fd: 'Syne', sans-serif;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--ff);
  min-height: 100vh;
  overflow-x: hidden;
  padding-top: var(--nav-h);
  padding-bottom: var(--strip-h);
  opacity: 0;
  transition: opacity 220ms ease;
  /* Scanline */
  background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.05) 2px, rgba(0,0,0,.05) 4px);
}

/* ── NAV ──────────────────────────────────────────────────── */
#nav {
  position: fixed; top: 0; left: 0; right: 0; height: var(--nav-h);
  background: rgba(4,6,10,.96); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 20px; gap: 0; z-index: 1000;
}
.nav-brand { font-family: var(--fd); font-size: .68rem; font-weight: 800; letter-spacing: 3px; color: var(--text); white-space: nowrap; margin-right: 24px; flex-shrink: 0; }
.nav-brand span { color: var(--green); }
.nav-links { display: flex; gap: 2px; flex: 1; }
.nav-link {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 12px; font-size: .5rem; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--m2); border-radius: 3px; border: 1px solid transparent;
  cursor: pointer; transition: all .12s; user-select: none; white-space: nowrap;
}
.nav-link:hover { color: var(--t2); background: rgba(255,255,255,.03); border-color: var(--border); }
.nav-link.active { color: var(--text); background: rgba(255,255,255,.04); border-color: var(--b2); position: relative; }
.nav-link.active::after { content:''; position:absolute; bottom:-1px; left:25%; right:25%; height:1px; background:var(--green); }
.nav-right { margin-left: auto; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.nav-px { font-size:.46rem; color:var(--m2); background:var(--s2); border:1px solid var(--border); border-radius:3px; padding:3px 7px; transition:color .4s; white-space:nowrap; }
.nav-dot { width:6px; height:6px; border-radius:50%; background:var(--muted); transition:background .3s, box-shadow .3s; flex-shrink:0; }
.nav-dot.on { background:var(--green); box-shadow:0 0 5px var(--green); animation:pulse 2.5s infinite; }
.nav-dot.err { background:var(--red); }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.6)} }

/* ── PRICE STRIP (bottom) ─────────────────────────────────── */
#price-strip {
  position: fixed; bottom: 0; left: 0; right: 0; height: var(--strip-h);
  background: rgba(4,6,10,.97); border-top: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 16px; gap: 0; z-index: 900;
}
.ps-pair { display:flex; align-items:center; gap:7px; padding:0 14px; border-right:1px solid var(--border); height:100%; }
.ps-pair:first-child { padding-left:0; }
.ps-sym { font-size:.44rem; color:var(--m2); letter-spacing:1px; }
.ps-price { font-size:.6rem; font-weight:700; color:var(--text); letter-spacing:.5px; }
.ps-chg { font-size:.46rem; }
.strip-right { margin-left:auto; display:flex; align-items:center; gap:10px; }
.strip-ts { font-size:.42rem; color:var(--muted); }
.strip-src { font-size:.42rem; color:var(--green); letter-spacing:1px; }

/* ── ALERT BAR ────────────────────────────────────────────── */
#alert-bar { position:fixed; top:var(--nav-h); left:0; right:0; z-index:999; pointer-events:none; }
.alert-item {
  display:flex; align-items:center; gap:8px; padding:7px 18px;
  font-size:.56rem; pointer-events:all; animation:fadeIn .2s ease;
}
.alert-hit  { background:rgba(255,45,85,.14); border-bottom:1px solid rgba(255,45,85,.25); color:var(--red); }
.alert-near { background:rgba(245,166,35,.09); border-bottom:1px solid rgba(245,166,35,.18); color:var(--amber); }
.alert-close { margin-left:auto; background:none; border:none; color:inherit; cursor:pointer; font-size:.9rem; opacity:.6; padding:0 4px; }
.alert-close:hover { opacity:1; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

/* ── TOKEN SCREEN ─────────────────────────────────────────── */
#token-screen {
  display:none; position:fixed; inset:0; background:var(--bg); z-index:9000;
  align-items:center; justify-content:center; flex-direction:column; gap:28px; padding:40px;
}
#token-screen.show { display:flex; }
.ts-logo { font-family:var(--fd); font-size:1.3rem; font-weight:800; letter-spacing:3px; }
.ts-logo span { color:var(--green); }
.ts-box {
  background:var(--s1); border:1px solid var(--b2); border-radius:10px;
  padding:26px 30px; width:100%; max-width:400px;
}
.ts-box h2 { font-family:var(--fd); font-size:.85rem; font-weight:700; margin-bottom:8px; }
.ts-box p { font-size:.52rem; color:var(--t2); line-height:1.7; margin-bottom:16px; }
.ts-box p strong { color:var(--green); }
.ts-inp {
  width:100%; background:var(--s2); border:1px solid var(--b2);
  border-radius:4px; color:var(--text); font-family:var(--ff);
  font-size:.62rem; padding:9px 12px; outline:none; transition:border-color .15s;
}
.ts-inp:focus { border-color:var(--blue); }
.ts-inp::placeholder { color:var(--muted); }
.ts-remember { display:flex; align-items:center; gap:7px; margin:10px 0 14px; font-size:.48rem; color:var(--m2); cursor:pointer; }
.ts-remember input { accent-color:var(--green); }
.ts-btn {
  width:100%; padding:11px; background:rgba(0,212,122,.08); border:1px solid rgba(0,212,122,.3);
  border-radius:4px; color:var(--green); font-family:var(--fd); font-size:.68rem;
  font-weight:700; letter-spacing:2px; cursor:pointer; transition:all .15s;
}
.ts-btn:hover { background:rgba(0,212,122,.14); }
.ts-note { font-size:.44rem; color:var(--muted); text-align:center; margin-top:10px; line-height:1.6; border-top:1px solid var(--border); padding-top:10px; }

/* ── LOADER ───────────────────────────────────────────────── */
#loader {
  position:fixed; inset:0; background:var(--bg); z-index:8000;
  display:flex; align-items:center; justify-content:center; flex-direction:column; gap:16px;
  transition:opacity .3s;
}
#loader.out { opacity:0; pointer-events:none; }
.ld-logo { font-family:var(--fd); font-size:1.1rem; font-weight:800; letter-spacing:3px; color:var(--text); }
.ld-logo span { color:var(--green); }
.ld-bar-wrap { width:200px; height:2px; background:var(--s3); border-radius:1px; overflow:hidden; }
.ld-bar { height:100%; background:linear-gradient(90deg,var(--green),var(--cyan)); width:0%; transition:width .2s; }
.ld-msg { font-size:.48rem; color:var(--muted); letter-spacing:1.5px; }

/* ── MAIN LAYOUT ──────────────────────────────────────────── */
#app { display:none; }
#app.show { display:block; }
.wrap { max-width:1140px; margin:0 auto; padding:22px 20px; }

/* ── SECTION HEADER ───────────────────────────────────────── */
.shdr { display:flex; align-items:baseline; gap:10px; margin-bottom:16px; }
.shdr-title { font-family:var(--fd); font-size:.8rem; font-weight:700; }
.shdr-sub { font-size:.48rem; color:var(--m2); letter-spacing:2px; text-transform:uppercase; }
.shdr-line { flex:1; height:1px; background:var(--border); }

/* ── CARDS ────────────────────────────────────────────────── */
.card { background:var(--s1); border:1px solid var(--border); border-radius:10px; padding:15px; position:relative; overflow:hidden; }
.card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; }
.card.g::before { background:linear-gradient(90deg,transparent,var(--green),transparent); }
.card.b::before { background:linear-gradient(90deg,transparent,var(--blue),transparent); }
.card.a::before { background:linear-gradient(90deg,transparent,var(--amber),transparent); }
.card.r::before { background:linear-gradient(90deg,transparent,var(--red),transparent); }
.card.p::before { background:linear-gradient(90deg,transparent,var(--purple),transparent); }

/* ── KPI ROW ──────────────────────────────────────────────── */
.kpi-row { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:12px; }
@media(max-width:900px){.kpi-row{grid-template-columns:repeat(3,1fr);}}
@media(max-width:540px){.kpi-row{grid-template-columns:repeat(2,1fr);}}
.kpi { background:var(--s1); border:1px solid var(--border); border-radius:8px; padding:12px; }
.kpi-l { font-size:.44rem; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:5px; }
.kpi-v { font-family:var(--fd); font-size:1.35rem; font-weight:800; line-height:1; margin-bottom:3px; }
.kpi-s { font-size:.46rem; color:var(--m2); }

/* ── CHART GRID ───────────────────────────────────────────── */
.row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px; }
.row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px; }
@media(max-width:760px){.row2,.row3{grid-template-columns:1fr;}}
.chart-lbl { font-size:.44rem; color:var(--muted); letter-spacing:2px; text-transform:uppercase; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }

/* ── FILTER BAR ───────────────────────────────────────────── */
.filter-bar { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px; }
.filter-btn { padding:4px 10px; font-size:.48rem; letter-spacing:1px; text-transform:uppercase; border:1px solid var(--border); border-radius:3px; background:transparent; color:var(--m2); cursor:pointer; font-family:var(--ff); transition:all .12s; }
.filter-btn:hover,.filter-btn.on { border-color:var(--b3); color:var(--text); background:rgba(255,255,255,.04); }
.filter-inp { padding:4px 10px; font-size:.48rem; border:1px solid var(--border); border-radius:3px; background:var(--s2); color:var(--text); font-family:var(--ff); outline:none; width:120px; }
.filter-inp:focus { border-color:var(--blue); }

/* ── TRADES TABLE ─────────────────────────────────────────── */
.tbl { width:100%; border-collapse:collapse; font-size:.54rem; }
.tbl th { text-align:left; font-size:.42rem; letter-spacing:2px; text-transform:uppercase; color:var(--muted); padding:7px 9px; border-bottom:1px solid var(--border); font-weight:400; }
.tbl td { padding:8px 9px; border-bottom:1px solid rgba(255,255,255,.03); color:var(--t2); vertical-align:middle; }
.tbl tr:last-child td { border-bottom:none; }
.tbl tr:hover td { background:rgba(255,255,255,.015); }
.tbl tr { cursor:pointer; }

/* ── BADGES ───────────────────────────────────────────────── */
.badge { display:inline-block; font-size:.42rem; letter-spacing:1.5px; text-transform:uppercase; padding:2px 7px; border-radius:10px; }
.bg   { background:rgba(0,212,122,.1);  color:var(--green);  border:1px solid rgba(0,212,122,.2); }
.br   { background:rgba(255,45,85,.1);  color:var(--red);    border:1px solid rgba(255,45,85,.2); }
.ba   { background:rgba(245,166,35,.1); color:var(--amber);  border:1px solid rgba(245,166,35,.2); }
.bb   { background:rgba(61,142,255,.1); color:var(--blue);   border:1px solid rgba(61,142,255,.2); }
.bp   { background:rgba(155,107,255,.1);color:var(--purple); border:1px solid rgba(155,107,255,.2); }

/* ── TRADE MODAL ──────────────────────────────────────────── */
.modal-ov { display:none; position:fixed; inset:0; background:rgba(0,0,0,.78); backdrop-filter:blur(6px); z-index:2000; align-items:center; justify-content:center; padding:16px; }
.modal-ov.open { display:flex; }
.modal-box {
  background:var(--s1); border:1px solid var(--b2); border-radius:12px;
  width:100%; max-width:660px; max-height:88vh; overflow-y:auto; padding:22px;
  animation:slideUp .18s ease;
}
@keyframes slideUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.modal-hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.modal-title { font-family:var(--fd); font-size:.85rem; font-weight:700; }
.modal-close { background:none; border:none; color:var(--m2); cursor:pointer; font-size:1.1rem; padding:4px; transition:color .12s; }
.modal-close:hover { color:var(--text); }
.modal-meta { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
.setup-img { width:100%; border-radius:6px; display:block; border:1px solid var(--b2); margin-bottom:8px; }
.insight-box { background:rgba(155,107,255,.07); border:1px solid rgba(155,107,255,.18); border-radius:6px; padding:12px; font-size:.54rem; color:var(--t2); line-height:1.7; margin-bottom:12px; }

/* ── PAGINATION ───────────────────────────────────────────── */
.pagination { display:flex; align-items:center; justify-content:center; gap:6px; margin-top:14px; }
.pg-btn { padding:5px 11px; font-size:.48rem; border:1px solid var(--border); border-radius:3px; background:transparent; color:var(--m2); cursor:pointer; font-family:var(--ff); transition:all .12s; }
.pg-btn:hover,.pg-btn.on { border-color:var(--b3); color:var(--text); background:rgba(255,255,255,.04); }
.pg-info { font-size:.46rem; color:var(--muted); }

/* ── RANGE BUTTONS ────────────────────────────────────────── */
.range-btns { display:flex; gap:4px; }
.rb { padding:3px 8px; font-size:.44rem; border:1px solid var(--border); border-radius:3px; background:transparent; color:var(--m2); cursor:pointer; font-family:var(--ff); transition:all .1s; }
.rb.on { border-color:var(--green); color:var(--green); }

/* ── SVG charts ───────────────────────────────────────────── */
svg { display:block; width:100%; overflow:visible; }
</style>
</head>
<body>

<!-- ═══════════════════════ NAV ═══════════════════════════ -->
<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR —</div>
    <div class="nav-px" id="np-xau">XAU —</div>
    <div class="nav-px" id="np-dxy">DXY —</div>
    <div class="nav-dot" id="nav-dot"></div>
  </div>
</nav>

<!-- ═══════════════════ ALERT BAR ════════════════════════ -->
<div id="alert-bar"></div>

<!-- ═══════════════════ LOADER ═══════════════════════════ -->
<div id="loader">
  <div class="ld-logo">TRADE<span>OS</span></div>
  <div class="ld-bar-wrap"><div class="ld-bar" id="ld-bar"></div></div>
  <div class="ld-msg" id="ld-msg">INITIALISING</div>
</div>

<!-- ═══════════════════ TOKEN SCREEN ═════════════════════ -->
<div id="token-screen">
  <div class="ts-logo">TRADE<span>OS</span></div>
  <div class="ts-box">
    <h2>Connect Notion</h2>
    <p>Enter your Notion integration token to load your trade journal.<br>Get it at <strong>notion.so/my-integrations</strong></p>
    <input class="ts-inp" id="ts-inp" type="password" placeholder="ntn_xxxxxxxxxxxxxxxxxxxx"
           autocomplete="off" spellcheck="false"
           onkeydown="if(event.key==='Enter')saveToken()">
    <label class="ts-remember">
      <input type="checkbox" id="ts-remember">
      Remember on this device
    </label>
    <button class="ts-btn" onclick="saveToken()">CONNECT →</button>
    <div class="ts-note">Token validated before storage · Never sent to third parties · Clears on tab close unless remembered</div>
  </div>
</div>

<!-- ═══════════════════ TRADE MODAL ══════════════════════ -->
<div class="modal-ov" id="trade-modal">
  <div class="modal-box">
    <div class="modal-hdr">
      <div class="modal-title" id="modal-title">—</div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<!-- ═══════════════════ MAIN APP ══════════════════════════ -->
<div id="app">
<div class="wrap">

  <!-- KPIs -->
  <div class="kpi-row" id="kpi-row"></div>

  <!-- Equity + Calendar -->
  <div class="row2" style="margin-bottom:10px">
    <div class="card g">
      <div class="chart-lbl">
        <span>EQUITY CURVE</span>
        <div class="range-btns">
          <button class="rb on" onclick="setRange('all',this)">ALL</button>
          <button class="rb" onclick="setRange('3m',this)">3M</button>
          <button class="rb" onclick="setRange('1m',this)">1M</button>
        </div>
      </div>
      <svg id="eq-svg" viewBox="0 0 800 200" height="200"></svg>
    </div>
    <div class="card b">
      <div class="chart-lbl">
        <span>TRADE CALENDAR</span>
        <div style="display:flex;gap:8px">
          <button class="rb" onclick="calNav(-1)">‹</button>
          <span id="cal-month" style="font-size:.46rem;color:var(--t2)"></span>
          <button class="rb" onclick="calNav(1)">›</button>
        </div>
      </div>
      <div id="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;font-size:.42rem;"></div>
    </div>
  </div>

  <!-- Monthly R + W/L + Sessions -->
  <div class="row3" style="margin-bottom:10px">
    <div class="card a">
      <div class="chart-lbl">MONTHLY R</div>
      <svg id="monthly-svg" viewBox="0 0 380 120" height="120"></svg>
    </div>
    <div class="card b">
      <div class="chart-lbl">WIN · LOSS · BE</div>
      <svg id="wl-svg" viewBox="0 0 200 120" height="120"></svg>
    </div>
    <div class="card p">
      <div class="chart-lbl">SESSIONS</div>
      <svg id="sess-svg" viewBox="0 0 260 120" height="120"></svg>
    </div>
  </div>

  <!-- R Distribution + Grade + TF -->
  <div class="row3" style="margin-bottom:16px">
    <div class="card">
      <div class="chart-lbl">R DISTRIBUTION</div>
      <svg id="rdist-svg" viewBox="0 0 260 120" height="120"></svg>
    </div>
    <div class="card g">
      <div class="chart-lbl">SETUP GRADE</div>
      <div id="grade-summary" style="padding:4px 0"></div>
    </div>
    <div class="card">
      <div class="chart-lbl">ENTRY TIMEFRAME</div>
      <div id="tf-summary" style="padding:4px 0"></div>
    </div>
  </div>

  <!-- Trades Table -->
  <div class="shdr"><div class="shdr-title">All Trades</div><div class="shdr-line"></div><div class="shdr-sub" id="tbl-sub"></div></div>
  <div class="card" style="padding:0;margin-bottom:24px">
    <div style="padding:12px 14px;border-bottom:1px solid var(--border)">
      <div class="filter-bar">
        <input class="filter-inp" id="f-search" placeholder="Search pair / session…" oninput="filterTrades()">
        <select class="filter-inp" id="f-outcome" onchange="filterTrades()" style="width:auto">
          <option value="">All outcomes</option>
          <option>Win</option><option>Lose</option><option>Breakeven</option>
        </select>
        <select class="filter-inp" id="f-grade" onchange="filterTrades()" style="width:auto">
          <option value="">All grades</option>
          <option>A+</option><option>B</option><option>C</option>
        </select>
        <button class="filter-btn" onclick="filterTrades('reset')">Reset</button>
      </div>
    </div>
    <div style="overflow-x:auto">
      <table class="tbl">
        <thead><tr>
          <th>#</th><th>Date</th><th>Pair</th><th>Dir</th><th>Outcome</th>
          <th>R</th><th>Grade</th><th>Session</th><th>Confluences</th>
        </tr></thead>
        <tbody id="tbl-body"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

</div><!-- /wrap -->
</div><!-- /app -->

<!-- ═══════════════════ PRICE STRIP ══════════════════════ -->
<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-dxy"><span class="ps-sym">DXY</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-xau"><span class="ps-sym">XAU/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">○ Loading</span>
  </div>
</div>

<script>
'use strict';
// ══════════════════════════════════════════════════════════════
// SECURITY LAYER — defined first, used everywhere
// ══════════════════════════════════════════════════════════════

/** HTML-escape — call before ANY innerHTML insertion */
function esc(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                  .replace(/"/g,'&quot;').replace(/'/g,'&#x27;').replace(/\//g,'&#x2F;');
}

/** URL sanitiser — blocks javascript:/data:/vbscript: */
function escUrl(u) {
  if (!u) return '';
  const s = String(u).trim();
  return /^(javascript|data|vbscript):/i.test(s) ? '' : s;
}

/** Token store — sessionStorage default, localStorage only if user opts in */
const TokenStore = {
  _s: 'to_tok', _l: 'to_tok_p',
  get()          { return sessionStorage.getItem(this._s) || localStorage.getItem(this._l) || ''; },
  set(t, persist){ if (!this.ok(t)) return false; sessionStorage.setItem(this._s, t); persist ? localStorage.setItem(this._l, t) : localStorage.removeItem(this._l); return true; },
  clear()        { sessionStorage.removeItem(this._s); localStorage.removeItem(this._l); },
  ok(t)          { return typeof t === 'string' && (t.startsWith('ntn_') || t.startsWith('secret_')); },
  persisted()    { return !!localStorage.getItem(this._l); },
};

/** ApiKeyStore — session only, sent via header not URL */
const ApiKeyStore = {
  _s: 'to_ak',
  get()       { try { return JSON.parse(sessionStorage.getItem(this._s)||'{}'); } catch{ return {}; } },
  set(k)      { sessionStorage.setItem(this._s, JSON.stringify(k)); },
  td()        { return this.get().td   || ''; },
  fred()      { return this.get().fred || ''; },
};

// ══════════════════════════════════════════════════════════════
// CONFIG
// ══════════════════════════════════════════════════════════════
const WORKER     = 'https://notion-proxy.churan756.workers.dev/';
const DB_TRADES  = '1f8c2f0e01588051ac78f92b4aaf19f9';
const DB_PB      = '30fc2f0e0158808a9ce1cb7ff70ce3aa';
const PAGES      = [
  { id:'analytics', label:'Analytics',  file:'index.html'     },
  { id:'macro',     label:'Macro',      file:'macro.html'     },
  { id:'playbook',  label:'Playbook',   file:'playbook.html'  },
  { id:'news',      label:'News',       file:'news.html'      },
  { id:'simulator', label:'Simulator',  file:'simulator.html' },
];
const CURRENT_PAGE = 'analytics';

// State
let _trades = [], _filtered = [], _page = 1, _eqRange = 'all', _calOffset = 0;
const PER_PAGE = 20;

// ══════════════════════════════════════════════════════════════
// NAV — render + transitions
// ══════════════════════════════════════════════════════════════
function initNav() {
  document.getElementById('nav-links').innerHTML = PAGES.map(p => {
    const active = p.id === CURRENT_PAGE ? ' active' : '';
    const click  = p.id !== CURRENT_PAGE ? `onclick="navGo('${esc(p.file)}')"` : '';
    return `<div class="nav-link${active}" ${click}>${esc(p.label)}</div>`;
  }).join('');
  // Fade body in
  document.body.style.opacity = '1';
}

function navGo(file) {
  document.body.style.transition = 'opacity 130ms ease';
  document.body.style.opacity = '0';
  setTimeout(() => { window.location.href = file; }, 140);
}

// ══════════════════════════════════════════════════════════════
// WORKER FETCH — keys via header, never URL
// ══════════════════════════════════════════════════════════════
async function wFetch(action, params = {}, body = null) {
  const u = new URL(WORKER);
  u.searchParams.set('action', action);
  for (const [k, v] of Object.entries(params)) u.searchParams.set(k, v);

  const keys = ApiKeyStore.get();
  const hdrs = { 'Content-Type': 'application/json' };
  if (keys.td || keys.fred) hdrs['X-Api-Keys'] = JSON.stringify({ td: keys.td, fred: keys.fred });

  const opts = { method: body ? 'POST' : 'GET', headers: hdrs, signal: AbortSignal.timeout(14000) };
  if (body) opts.body = JSON.stringify(body);

  const res  = await fetch(u.toString(), opts);
  const data = await res.json();
  if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

async function nFetch(action, params = {}, body = null) {
  const tok = TokenStore.get();
  if (!TokenStore.ok(tok)) { showTokenScreen(); throw new Error('NO_TOKEN'); }
  return wFetch(action, { ...params, token: tok }, body);
}

// ══════════════════════════════════════════════════════════════
// LOADER
// ══════════════════════════════════════════════════════════════
function ldSet(pct, msg) {
  document.getElementById('ld-bar').style.width = pct + '%';
  document.getElementById('ld-msg').textContent = msg;
}
function showApp() {
  document.getElementById('loader').classList.add('out');
  document.getElementById('app').classList.add('show');
}

// ══════════════════════════════════════════════════════════════
// TOKEN SCREEN
// ══════════════════════════════════════════════════════════════
function showTokenScreen() {
  document.getElementById('loader').classList.add('out');
  document.getElementById('token-screen').classList.add('show');
  setTimeout(() => document.getElementById('ts-inp').focus(), 200);
}

function saveToken() {
  const val     = document.getElementById('ts-inp').value.trim();
  const persist = document.getElementById('ts-remember').checked;
  if (!TokenStore.ok(val)) {
    document.getElementById('ts-inp').style.borderColor = 'var(--red)';
    setTimeout(() => document.getElementById('ts-inp').style.borderColor = '', 1400);
    return;
  }
  TokenStore.set(val, persist);
  document.getElementById('token-screen').classList.remove('show');
  document.getElementById('ts-inp').value = '';
  ldSet(0, 'LOADING TRADES…');
  document.getElementById('loader').classList.remove('out');
  loadData();
}

// ══════════════════════════════════════════════════════════════
// NOTION — fetch all trades (paginated)
// ══════════════════════════════════════════════════════════════
async function fetchAll() {
  let all = [], cursor = null, page = 0;
  do {
    const params = { db: DB_TRADES };
    if (cursor) params.cursor = cursor;
    const data = await nFetch('query', params);
    all   = all.concat(data.results || []);
    cursor = data.next_cursor || null;
    page++;
    ldSet(20 + page * 15, `LOADING… ${all.length} TRADES`);
  } while (cursor && page < 20);
  return all;
}

// ══════════════════════════════════════════════════════════════
// PARSE TRADE — all Notion prop types handled
// ══════════════════════════════════════════════════════════════
function getProp(p, key, type) {
  const prop = p[key]; if (!prop) return null;
  if (type === 'select')      return prop.select?.name || null;
  if (type === 'multi_select')return (prop.multi_select || []).map(x => x.name);
  if (type === 'number')      return prop.number ?? null;
  if (type === 'date')        return prop.date?.start || null;
  if (type === 'rich_text')   return (prop.rich_text || []).map(r => r.plain_text).join('');
  if (type === 'title')       return (prop.title || []).map(r => r.plain_text).join('');
  if (type === 'files')       return (prop.files || []).map(f => f.file?.url || f.external?.url || '').filter(Boolean);
  return null;
}

function parseTrade(page) {
  const p    = page.properties;
  const keys = Object.keys(p);
  const find = (q, type) => { const k = keys.find(k => k.toLowerCase().includes(q.toLowerCase())); return k ? getProp(p, k, type) : null; };

  const rawOutcome = find('outcome', 'select') || '';
  const outcome    = /win/i.test(rawOutcome) ? 'Win' : /loss|lose/i.test(rawOutcome) ? 'Lose' : /be|break/i.test(rawOutcome) ? 'Breakeven' : rawOutcome;

  return {
    id:          page.id,
    date:        find('date', 'date'),
    pair:        find('pair', 'select') || find('pair', 'rich_text'),
    direction:   find('direction', 'select'),
    outcome,
    rMultiple:   find('multiple', 'number') ?? find('r multiple', 'number') ?? find('r-multiple', 'number'),
    session:     find('session', 'select'),
    htfContext:  find('htf', 'select'),
    entryTF:     find('entry time', 'select') || find('entry tf', 'select'),
    confluences: find('ltf', 'multi_select') || find('confluence', 'multi_select') || [],
    comment:     find('comment', 'rich_text') || find('note', 'rich_text'),
    images:      find('files', 'files') || find('chart', 'files') || [],
  };
}

// ══════════════════════════════════════════════════════════════
// GRADE TRADE
// ══════════════════════════════════════════════════════════════
function gradeTrade(t) {
  let s = 0;
  const conf    = t.confluences || [];
  const has     = (q) => conf.some(x => x.toLowerCase().includes(q.toLowerCase()));
  if (has('CISD') || has('CSID')) s += 2;
  if (has('Displacement'))        s += 2;
  if (has('Sweep'))               s += 2;
  if (has('SMT'))                 s += 2;
  if (has('Kill Zone') || has('KZ')) s += 1;
  if (t.session === 'London KZ')  s += 2;
  else if (t.session === 'OFF session') s += 1;
  if (t.htfContext)               s += 1;
  if (conf.length >= 4)           s += 2;
  else if (conf.length >= 3)      s += 1;
  return s >= 11 ? 'A+' : s >= 7 ? 'B' : 'C';
}

function gradeColor(g) {
  return g === 'A+' ? 'var(--green)' : g === 'B' ? 'var(--blue)' : 'var(--amber)';
}

// ══════════════════════════════════════════════════════════════
// ANALYZE
// ══════════════════════════════════════════════════════════════
function analyze(trades) {
  const valid = trades.filter(t => t.date).sort((a, b) => new Date(a.date) - new Date(b.date));
  valid.forEach(t => { t.grade = gradeTrade(t); });

  const wins   = valid.filter(t => t.outcome === 'Win');
  const losses = valid.filter(t => t.outcome === 'Lose');
  const bes    = valid.filter(t => t.outcome === 'Breakeven');

  let running = 0;
  valid.forEach(t => { running += t.rMultiple || 0; t.cumR = Math.round(running * 100) / 100; });

  const months = {};
  valid.forEach(t => {
    const d  = new Date(t.date);
    const k  = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if (!months[k]) months[k] = { label: d.toLocaleString('en-US',{month:'short',year:'2-digit'}), wins:0, losses:0, bes:0, r:0, order: d.getFullYear()*100+d.getMonth() };
    months[k].wins   += t.outcome === 'Win'       ? 1 : 0;
    months[k].losses += t.outcome === 'Lose'      ? 1 : 0;
    months[k].bes    += t.outcome === 'Breakeven' ? 1 : 0;
    months[k].r      += t.rMultiple || 0;
  });

  const sessions = {}, tfs = {}, byDay = {};
  valid.forEach(t => {
    const s = t.session || 'Unknown';
    if (!sessions[s]) sessions[s] = { wins:0, total:0 };
    sessions[s].total++; if (t.outcome === 'Win') sessions[s].wins++;
    const tf = t.entryTF || 'Unknown';
    if (!tfs[tf]) tfs[tf] = { wins:0, total:0 };
    tfs[tf].total++; if (t.outcome === 'Win') tfs[tf].wins++;
    const dk = t.date.slice(0, 10);
    if (!byDay[dk]) byDay[dk] = [];
    byDay[dk].push(t);
  });

  const peakR   = valid.length ? Math.max(...valid.map(t => t.cumR)) : 0;
  const curR    = valid.length ? valid[valid.length - 1].cumR : 0;
  const dd      = peakR > 0 ? Math.round((peakR - curR) / peakR * 100) : 0;
  const winRate = valid.length ? Math.round(wins.length / valid.length * 100) : 0;
  const avgWin  = wins.length  ? +(wins.reduce((s,t) => s + (t.rMultiple||0), 0) / wins.length).toFixed(2) : 0;
  const avgLoss = losses.length? +(losses.reduce((s,t) => s + Math.abs(t.rMultiple||0), 0) / losses.length).toFixed(2) : 0;
  const ev      = wins.length && losses.length ? +((winRate/100 * avgWin) - ((1-winRate/100) * avgLoss)).toFixed(3) : null;
  const sortedMonths = Object.values(months).sort((a,b) => a.order - b.order).map(m => ({...m, r: Math.round(m.r*100)/100}));

  return { valid, wins, losses, bes, winRate, avgWin, avgLoss, ev, peakR, curR, dd, sortedMonths, sessions, tfs, byDay };
}

// ══════════════════════════════════════════════════════════════
// RENDER — KPIs
// ══════════════════════════════════════════════════════════════
function renderKPIs(s) {
  const aplus  = s.valid.filter(t => t.grade === 'A+').length;
  const aPlusWR = s.valid.filter(t => t.grade === 'A+').length ?
    Math.round(s.valid.filter(t => t.grade === 'A+' && t.outcome === 'Win').length / aplus * 100) : 0;

  const kpis = [
    { l:'Total R',    v: (s.curR >= 0 ? '+' : '') + s.curR + 'R', c: s.curR >= 0 ? 'var(--green)' : 'var(--red)', sub: `Peak: +${s.peakR}R · DD: ${s.dd}%` },
    { l:'Win Rate',   v: s.winRate + '%',   c: s.winRate >= 55 ? 'var(--green)' : 'var(--amber)', sub: `${s.wins.length}W · ${s.losses.length}L · ${s.bes.length}BE` },
    { l:'Avg Win',    v: '+' + s.avgWin + 'R',  c: 'var(--green)', sub: `Avg Loss: −${s.avgLoss}R` },
    { l:'A+ Setups',  v: aplus,             c: 'var(--green)', sub: `${aPlusWR}% win rate on A+` },
    { l:'EV / Trade', v: s.ev !== null ? (s.ev >= 0 ? '+' : '') + s.ev + 'R' : '—', c: s.ev >= 0 ? 'var(--green)' : 'var(--red)', sub: s.ev >= 0.3 ? 'Elite edge' : s.ev >= 0 ? 'Positive edge' : 'Negative EV' },
  ];

  document.getElementById('kpi-row').innerHTML = kpis.map(k => `
    <div class="kpi">
      <div class="kpi-l">${esc(k.l)}</div>
      <div class="kpi-v" style="color:${k.c}">${esc(String(k.v))}</div>
      <div class="kpi-s">${esc(k.sub)}</div>
    </div>`).join('');
}

// ══════════════════════════════════════════════════════════════
// RENDER — Equity Curve SVG
// ══════════════════════════════════════════════════════════════
function renderEquity(s) {
  const svg = document.getElementById('eq-svg');
  let data  = s.valid;
  const now = new Date();
  if (_eqRange === '3m') { const c = new Date(now); c.setMonth(c.getMonth()-3); data = data.filter(t => new Date(t.date) >= c); }
  if (_eqRange === '1m') { const c = new Date(now); c.setMonth(c.getMonth()-1); data = data.filter(t => new Date(t.date) >= c); }
  if (!data.length) { svg.innerHTML = ''; return; }

  let run = 0;
  const pts = data.map(t => { run += t.rMultiple||0; return { ...t, dr: Math.round(run*100)/100 }; });

  const W=800,H=200,pL=40,pR=14,pT=18,pB=28;
  const w=W-pL-pR, h=H-pT-pB;
  const vals = pts.map(p => p.dr);
  const minV = Math.min(...vals, 0)-1, maxV = Math.max(...vals)+1;
  const n    = pts.length;
  const px   = i => pL + (i/(n-1||1))*w;
  const py   = v => pT + h - ((v-minV)/(maxV-minV||1))*h;
  const zY   = py(0);

  let linePath = pts.map((p,i) => `${i===0?'M':'L'}${px(i).toFixed(1)},${py(p.dr).toFixed(1)}`).join(' ');
  let areaPath = `${linePath} L${px(n-1).toFixed(1)},${zY.toFixed(1)} L${px(0).toFixed(1)},${zY.toFixed(1)} Z`;

  svg.innerHTML = `
    <defs>
      <linearGradient id="eg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--green)" stop-opacity=".22"/>
        <stop offset="100%" stop-color="var(--green)" stop-opacity=".02"/>
      </linearGradient>
      <clipPath id="eq-clip"><rect x="${pL}" y="${pT}" width="${w}" height="${h}"/></clipPath>
    </defs>
    <line x1="${pL}" x2="${W-pR}" y1="${zY}" y2="${zY}" stroke="rgba(255,255,255,.07)" stroke-width="1" stroke-dasharray="4 4"/>
    <path d="${areaPath}" fill="url(#eg)" clip-path="url(#eq-clip)"/>
    <path d="${linePath}" fill="none" stroke="var(--green)" stroke-width="1.5" stroke-linejoin="round" clip-path="url(#eq-clip)"/>
    <text x="${pL-4}" y="${pT+4}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono" text-anchor="end">${maxV.toFixed(1)}R</text>
    <text x="${pL-4}" y="${zY+3}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono" text-anchor="end">0</text>
    <text x="${pL-4}" y="${pT+h+4}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono" text-anchor="end">${minV.toFixed(1)}</text>`;

  // Month labels
  const monthsSeen = new Set();
  pts.forEach((p, i) => {
    const m = p.date?.slice(0,7);
    if (m && !monthsSeen.has(m)) {
      monthsSeen.add(m);
      const d = new Date(p.date);
      const lbl = d.toLocaleString('en-US',{month:'short'});
      svg.innerHTML += `<text x="${px(i).toFixed(1)}" y="${H-4}" fill="var(--muted)" font-size="7" font-family="JetBrains Mono" text-anchor="middle">${esc(lbl)}</text>`;
    }
  });
}

function setRange(r, btn) {
  _eqRange = r;
  document.querySelectorAll('.rb').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  if (window._lastStats) renderEquity(window._lastStats);
}

// ══════════════════════════════════════════════════════════════
// RENDER — Monthly R
// ══════════════════════════════════════════════════════════════
function renderMonthlyR(s) {
  const svg = document.getElementById('monthly-svg');
  const months = s.sortedMonths.slice(-12);
  if (!months.length) { svg.innerHTML=''; return; }
  const W=380,H=120,pL=30,pR=8,pT=14,pB=22;
  const w=W-pL-pR, h=H-pT-pB;
  const vals = months.map(m => m.r);
  const maxAbs = Math.max(...vals.map(Math.abs), 0.1);
  const bw = w/months.length - 2;
  const zY = pT + h/2;
  let out = `<line x1="${pL}" x2="${W-pR}" y1="${zY}" y2="${zY}" stroke="rgba(255,255,255,.07)" stroke-width="1"/>`;
  months.forEach((m, i) => {
    const x   = pL + i*(w/months.length) + 1;
    const pos = m.r >= 0;
    const bh  = Math.max((Math.abs(m.r)/maxAbs)*(h/2), 2);
    const by  = pos ? zY - bh : zY;
    const clr = pos ? 'var(--green)' : 'var(--red)';
    out += `<rect x="${x}" y="${by}" width="${bw}" height="${bh}" fill="${clr}" opacity=".85" rx="1"/>`;
    out += `<text x="${x+bw/2}" y="${H-5}" fill="var(--muted)" font-size="6" font-family="JetBrains Mono" text-anchor="middle">${esc(m.label.split(' ')[0])}</text>`;
  });
  svg.innerHTML = out;
}

// ══════════════════════════════════════════════════════════════
// RENDER — W/L Donut
// ══════════════════════════════════════════════════════════════
function renderWL(s) {
  const svg = document.getElementById('wl-svg');
  const total = s.valid.length; if (!total) { svg.innerHTML=''; return; }
  const cx=100,cy=60,r=48,iR=32;
  const segs = [
    { n:'Win',       v:s.wins.length,   c:'var(--green)' },
    { n:'Loss',      v:s.losses.length, c:'var(--red)'   },
    { n:'Breakeven', v:s.bes.length,    c:'var(--amber)'  },
  ];
  let angle = -Math.PI/2;
  let arcs  = '';
  segs.forEach(seg => {
    const frac = seg.v / total;
    const end  = angle + frac * 2 * Math.PI - 0.01;
    const large = frac > 0.5 ? 1 : 0;
    const x1  = cx + r*Math.cos(angle), y1 = cy + r*Math.sin(angle);
    const x2  = cx + r*Math.cos(end),   y2 = cy + r*Math.sin(end);
    const xi1 = cx + iR*Math.cos(end),  yi1= cy + iR*Math.sin(end);
    const xi2 = cx + iR*Math.cos(angle),yi2= cy + iR*Math.sin(angle);
    if (seg.v > 0) arcs += `<path d="M${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} L${xi1},${yi1} A${iR},${iR} 0 ${large} 0 ${xi2},${yi2} Z" fill="${seg.c}" opacity=".85"/>`;
    angle = end + 0.01;
  });
  // Legend
  let legend = '';
  segs.forEach((seg, i) => {
    const wr = total ? Math.round(seg.v/total*100) : 0;
    legend += `<text x="164" y="${14+i*18}" fill="${seg.c}" font-size="9" font-family="JetBrains Mono">${esc(seg.n)}: ${seg.v} (${wr}%)</text>`;
  });
  svg.innerHTML = arcs +
    `<text x="${cx}" y="${cy+4}" fill="var(--text)" font-size="13" font-family="Syne" text-anchor="middle" font-weight="800">${total}</text>
     <text x="${cx}" y="${cy+16}" fill="var(--muted)" font-size="7" font-family="JetBrains Mono" text-anchor="middle">TRADES</text>` +
    legend;
}

// ══════════════════════════════════════════════════════════════
// RENDER — Sessions bars
// ══════════════════════════════════════════════════════════════
function renderSessions(s) {
  const svg  = document.getElementById('sess-svg');
  const data = Object.entries(s.sessions).sort((a,b) => b[1].total - a[1].total).slice(0,5);
  if (!data.length) { svg.innerHTML=''; return; }
  const W=260,H=120,pL=80,pR=8,pT=8,pB=8;
  const w=W-pL-pR, h=H-pT-pB;
  const maxT = Math.max(...data.map(d => d[1].total));
  const rowH = h/data.length;
  let out = '';
  data.forEach(([name, d], i) => {
    const y  = pT + i*rowH;
    const bw = (d.total/maxT)*w;
    const wr = Math.round(d.wins/d.total*100);
    out += `<text x="${pL-6}" y="${y+rowH/2+4}" fill="var(--m2)" font-size="8" font-family="JetBrains Mono" text-anchor="end">${esc(name.replace(' KZ',''))}</text>`;
    out += `<rect x="${pL}" y="${y+4}" width="${bw}" height="${rowH-8}" fill="var(--blue)" opacity=".55" rx="2"/>`;
    out += `<text x="${pL+bw+4}" y="${y+rowH/2+4}" fill="var(--t2)" font-size="8" font-family="JetBrains Mono">${wr}%</text>`;
  });
  svg.innerHTML = out;
}

// ══════════════════════════════════════════════════════════════
// RENDER — Grade summary
// ══════════════════════════════════════════════════════════════
function renderGrade(s) {
  const grades = { 'A+': {wins:0,total:0}, B:{wins:0,total:0}, C:{wins:0,total:0} };
  s.valid.forEach(t => {
    if (grades[t.grade]) {
      grades[t.grade].total++;
      if (t.outcome === 'Win') grades[t.grade].wins++;
    }
  });
  document.getElementById('grade-summary').innerHTML = Object.entries(grades).map(([g, d]) => {
    const wr  = d.total ? Math.round(d.wins/d.total*100) : 0;
    const pct = s.valid.length ? Math.round(d.total/s.valid.length*100) : 0;
    return `<div style="display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid var(--border)">
      <span style="font-family:var(--fd);font-weight:700;color:${gradeColor(g)};min-width:26px;font-size:.75rem">${esc(g)}</span>
      <div style="flex:1;height:4px;background:var(--s3);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${gradeColor(g)};border-radius:2px"></div>
      </div>
      <span style="font-size:.5rem;color:var(--m2);min-width:60px">${d.total} trades · ${wr}% WR</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════════
// RENDER — Entry TF
// ══════════════════════════════════════════════════════════════
function renderTF(s) {
  const data = Object.entries(s.tfs).sort((a,b) => b[1].total - a[1].total).slice(0,6);
  document.getElementById('tf-summary').innerHTML = data.map(([tf, d]) => {
    const wr  = Math.round(d.wins/d.total*100);
    const pct = s.valid.length ? Math.round(d.total/s.valid.length*100) : 0;
    return `<div style="display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:.52rem;color:var(--text);min-width:40px">${esc(tf)}</span>
      <div style="flex:1;height:4px;background:var(--s3);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:var(--blue);border-radius:2px"></div>
      </div>
      <span style="font-size:.48rem;color:var(--m2);min-width:55px">${d.total}× · ${wr}%</span>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════════
// RENDER — R Distribution
// ══════════════════════════════════════════════════════════════
function renderRDist(s) {
  const svg  = document.getElementById('rdist-svg');
  const vals = s.valid.map(t => t.rMultiple || 0).filter(v => v !== 0);
  if (!vals.length) { svg.innerHTML=''; return; }
  const min = Math.floor(Math.min(...vals)), max = Math.ceil(Math.max(...vals));
  const bins = 12, bw = (max-min)/bins;
  const counts = new Array(bins).fill(0);
  vals.forEach(v => { const b = Math.min(bins-1, Math.floor((v-min)/bw)); counts[b]++; });
  const maxC = Math.max(...counts);
  const W=260,H=120,pL=8,pR=8,pT=8,pB=16;
  const w=W-pL-pR, h=H-pT-pB, barW=w/bins;
  let out = '';
  counts.forEach((c, i) => {
    const x   = pL + i*barW;
    const bh  = (c/maxC)*h;
    const y   = pT + h - bh;
    const pos = (min + i*bw) >= 0;
    out += `<rect x="${x+.5}" y="${y}" width="${barW-1}" height="${bh}" fill="${pos?'var(--green)':'var(--red)'}" opacity=".75" rx="1"/>`;
  });
  // X labels
  out += `<text x="${pL}" y="${H-2}" fill="var(--muted)" font-size="7" font-family="JetBrains Mono">${min}R</text>`;
  out += `<text x="${W-pR}" y="${H-2}" fill="var(--muted)" font-size="7" font-family="JetBrains Mono" text-anchor="end">${max}R</text>`;
  svg.innerHTML = out;
}

// ══════════════════════════════════════════════════════════════
// RENDER — Calendar
// ══════════════════════════════════════════════════════════════
function renderCalendar(s) {
  const now  = new Date();
  const year = now.getFullYear(), month = (now.getMonth() + _calOffset);
  const d    = new Date(year, month, 1);
  const days = new Date(year, month + 1, 0).getDate();
  const startDow = d.getDay();

  document.getElementById('cal-month').textContent =
    d.toLocaleString('en-US', { month: 'long', year: 'numeric' });

  const cells = [];
  const DOW = ['S','M','T','W','T','F','S'];
  DOW.forEach(d => cells.push(`<div style="font-size:.38rem;color:var(--muted);text-align:center;padding:2px">${esc(d)}</div>`));
  for (let i = 0; i < startDow; i++) cells.push('<div></div>');

  for (let day = 1; day <= days; day++) {
    const k    = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const ts   = s.byDay[k] || [];
    const wins = ts.filter(t => t.outcome === 'Win').length;
    const loss = ts.filter(t => t.outcome === 'Lose').length;
    const bg   = ts.length === 0 ? '' : wins > loss ? 'rgba(0,212,122,.18)' : loss > wins ? 'rgba(255,45,85,.18)' : 'rgba(245,166,35,.18)';
    const dot  = ts.length ? `<div style="width:4px;height:4px;border-radius:50%;background:${wins>loss?'var(--green)':loss>wins?'var(--red)':'var(--amber)'};margin:0 auto;margin-top:1px"></div>` : '';
    cells.push(`<div style="padding:3px;text-align:center;border-radius:3px;background:${bg};cursor:${ts.length?'pointer':'default'}"
      ${ts.length ? `onclick="openCalPopup('${esc(k)}')"` : ''}
      title="${ts.length?ts.length+' trade(s) — click to view':''}"
    ><div style="font-size:.46rem;color:${ts.length?'var(--text)':'var(--muted)'}">${day}</div>${dot}</div>`);
  }

  document.getElementById('cal-grid').innerHTML = cells.join('');
}

function calNav(d) { _calOffset += d; if (window._lastStats) renderCalendar(window._lastStats); }

function openCalPopup(key) {
  const ts = window._lastStats?.byDay?.[key];
  if (!ts?.length) return;
  openTradeModal(ts[0]);
}

// ══════════════════════════════════════════════════════════════
// TRADE MODAL — all Notion data escaped before DOM insertion
// ══════════════════════════════════════════════════════════════
function openTradeModal(trade) {
  if (!trade) return;
  const d      = new Date(trade.date);
  const rC     = (trade.rMultiple||0) >= 0 ? 'var(--green)' : 'var(--red)';
  const gC     = gradeColor(trade.grade);

  document.getElementById('modal-title').textContent =
    `${trade.pair || '—'} · ${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;

  // Images — escUrl prevents XSS via crafted Notion URLs
  const imgHtml = trade.images?.length
    ? trade.images.map(url => {
        const safe = escUrl(url);
        return safe ? `<img src="${safe}" class="setup-img" alt="Trade chart" loading="lazy" onerror="this.style.display='none'">` : '';
      }).join('')
    : `<div style="padding:16px;text-align:center;color:var(--muted);font-size:.54rem">No chart attached in Notion</div>`;

  // Confluences — esc() each tag
  const confHtml = (trade.confluences||[]).map(c =>
    `<span class="badge bg">${esc(c)}</span>`
  ).join(' ');

  // Comment — esc() prevents stored XSS from Notion notes
  const commentHtml = trade.comment
    ? `<div style="margin-top:12px;font-size:.56rem;color:var(--t2);line-height:1.7;border-top:1px solid var(--border);padding-top:10px">${esc(trade.comment)}</div>`
    : '';

  document.getElementById('modal-body').innerHTML = `
    <div class="modal-meta">
      <span class="badge ${trade.outcome==='Win'?'bg':trade.outcome==='Lose'?'br':'ba'}">${esc(trade.outcome||'—')}</span>
      <span class="badge bb">${esc(trade.pair||'—')}</span>
      <span class="badge" style="color:${trade.direction==='BUY'?'var(--green)':'var(--red)'};border-color:currentColor">${esc(trade.direction||'—')}</span>
      <span class="badge" style="color:${gC};border-color:${gC}">Grade: ${esc(trade.grade||'—')}</span>
      <span class="badge bp">${esc(trade.session||'—')}</span>
    </div>
    <div style="display:flex;gap:16px;margin-bottom:12px;font-size:.56rem">
      <div><span style="color:var(--muted)">R MULTIPLE</span><br><span style="color:${rC};font-family:var(--fd);font-size:.95rem;font-weight:800">${(trade.rMultiple||0) >= 0 ? '+' : ''}${esc(String(trade.rMultiple ?? '—'))}R</span></div>
      <div><span style="color:var(--muted)">ENTRY TF</span><br><span style="color:var(--t2)">${esc(trade.entryTF||'—')}</span></div>
      <div><span style="color:var(--muted)">HTF CONTEXT</span><br><span style="color:var(--t2)">${esc(trade.htfContext||'—')}</span></div>
    </div>
    ${confHtml ? `<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:12px">${confHtml}</div>` : ''}
    ${imgHtml}
    ${commentHtml}`;

  document.getElementById('trade-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('trade-modal').classList.remove('open');
}

document.getElementById('trade-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('trade-modal')) closeModal();
});

// ══════════════════════════════════════════════════════════════
// TRADES TABLE — filter + paginate
// ══════════════════════════════════════════════════════════════
function filterTrades(reset) {
  if (reset) {
    document.getElementById('f-search').value = '';
    document.getElementById('f-outcome').value = '';
    document.getElementById('f-grade').value = '';
  }
  const q  = document.getElementById('f-search').value.toLowerCase();
  const oc = document.getElementById('f-outcome').value;
  const gr = document.getElementById('f-grade').value;

  _filtered = [..._trades].reverse().filter(t => {
    const matchQ  = !q  || (t.pair||'').toLowerCase().includes(q) || (t.session||'').toLowerCase().includes(q);
    const matchOC = !oc || t.outcome === oc;
    const matchGR = !gr || t.grade   === gr;
    return matchQ && matchOC && matchGR;
  });
  _page = 1;
  renderPage();
}

function renderPage() {
  const total = _filtered.length;
  const pages = Math.ceil(total / PER_PAGE);
  const slice = _filtered.slice((_page-1)*PER_PAGE, _page*PER_PAGE);

  document.getElementById('tbl-sub').textContent = `${total} trades`;

  document.getElementById('tbl-body').innerHTML = slice.map((t, i) => {
    // Safe Notion IDs: validate UUID format before use in onclick
    const safeId = /^[a-f0-9-]{32,36}$/.test(t.id||'') ? t.id : '';
    const d    = new Date(t.date);
    const rC   = (t.rMultiple||0) >= 0 ? 'var(--green)' : 'var(--red)';
    const gC   = gradeColor(t.grade);
    const conf = (t.confluences||[]).slice(0,2).map(c => `<span class="badge bg" style="font-size:.38rem">${esc(c)}</span>`).join(' ');
    return `<tr onclick="openTradeModal(_trades.find(x=>x.id==='${safeId}'))">
      <td style="color:var(--muted);font-size:.5rem">${(_page-1)*PER_PAGE+i+1}</td>
      <td style="color:var(--m2)">${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'})}</td>
      <td style="font-weight:600;color:var(--text)">${esc(t.pair||'—')}</td>
      <td style="color:${t.direction==='BUY'?'var(--green)':'var(--red)'};font-weight:600">${esc(t.direction||'—')}</td>
      <td><span class="badge ${t.outcome==='Win'?'bg':t.outcome==='Lose'?'br':'ba'}">${esc(t.outcome||'—')}</span></td>
      <td style="color:${rC};font-weight:700">${(t.rMultiple||0)>=0?'+':''}${esc(String(t.rMultiple??'—'))}R</td>
      <td style="color:${gC};font-weight:700">${esc(t.grade||'—')}</td>
      <td style="color:var(--m2)">${esc(t.session||'—')}</td>
      <td>${conf}</td>
    </tr>`;
  }).join('');

  // Pagination
  const pgEl = document.getElementById('pagination');
  if (pages <= 1) { pgEl.innerHTML=''; return; }
  let pags = `<button class="pg-btn" onclick="_page=Math.max(1,_page-1);renderPage()" ${_page===1?'disabled':''}>‹</button>`;
  for (let p = 1; p <= Math.min(pages,7); p++) {
    pags += `<button class="pg-btn ${_page===p?'on':''}" onclick="_page=${p};renderPage()">${p}</button>`;
  }
  if (pages > 7) pags += `<span class="pg-info">… ${pages}</span>`;
  pags += `<button class="pg-btn" onclick="_page=Math.min(${pages},_page+1);renderPage()" ${_page===pages?'disabled':''}>›</button>`;
  pgEl.innerHTML = pags;
}

// ══════════════════════════════════════════════════════════════
// PRICE ENGINE — keys via header, updates nav + strip
// ══════════════════════════════════════════════════════════════
let _prices = {}, _priceAlerts = {}, _alertFired = new Set(), _notifOk = false;

async function fetchPrices() {
  try {
    const hasTD = !!ApiKeyStore.td();
    const data  = await wFetch('prices', { source: hasTD ? 'twelvedata' : 'exchangerate' });
    ['EURUSD','GBPUSD','DXY','XAUUSD'].forEach(sym => {
      if (!data[sym]) return;
      const prev  = _prices[sym]?.price ?? null;
      const price = parseFloat(data[sym]);
      if (isNaN(price)) return;
      _prices[sym] = { price, prev, change: prev !== null ? +(price-prev).toFixed(6) : 0 };
    });
    updatePriceUI(data.source);
    checkAlerts();
  } catch (e) {
    document.getElementById('strip-src').textContent = '○ Paused';
    document.getElementById('strip-src').style.color = 'var(--muted)';
  }
}

function updatePriceUI(source) {
  const fmt = (sym, dec, prefix='') => {
    const d = _prices[sym]; if (!d) return;
    return { label: prefix, price: d.price.toFixed(dec), change: d.change, sym };
  };

  [
    { elId:'ps-eur', sym:'EURUSD', dec:5, lbl:'EUR/USD' },
    { elId:'ps-gbp', sym:'GBPUSD', dec:5, lbl:'GBP/USD' },
    { elId:'ps-dxy', sym:'DXY',    dec:3, lbl:'DXY'     },
    { elId:'ps-xau', sym:'XAUUSD', dec:2, lbl:'XAU/USD' },
  ].forEach(({ elId, sym, dec, lbl }) => {
    const d   = _prices[sym]; if (!d) return;
    const el  = document.getElementById(elId); if (!el) return;
    const up  = d.change >= 0;
    const clr = up ? 'var(--green)' : 'var(--red)';
    el.querySelector('.ps-price').textContent = d.price.toFixed(dec);
    el.querySelector('.ps-chg').textContent   = (up?'▲':'▼') + ' ' + Math.abs(d.change).toFixed(dec);
    el.querySelector('.ps-chg').style.color   = clr;
  });

  // Nav prices
  const np = _prices;
  if (np.EURUSD) { const el=document.getElementById('np-eur'); el.textContent=`EUR ${np.EURUSD.price.toFixed(5)}`; el.style.color=np.EURUSD.change>=0?'var(--green)':'var(--red)'; }
  if (np.XAUUSD) { const el=document.getElementById('np-xau'); el.textContent=`XAU $${np.XAUUSD.price.toFixed(0)}`; el.style.color=np.XAUUSD.change>=0?'var(--green)':'var(--red)'; }
  if (np.DXY)    { const el=document.getElementById('np-dxy'); el.textContent=`DXY ${np.DXY.price.toFixed(3)}`; el.style.color='var(--t2)'; }

  document.getElementById('strip-ts').textContent  = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('strip-src').textContent = source === 'twelvedata' ? '● Live' : '● Hourly';
  document.getElementById('strip-src').style.color  = 'var(--green)';
}

function checkAlerts() {
  const bar = document.getElementById('alert-bar');
  if (!Object.keys(_priceAlerts).length) return;
  Object.entries(_priceAlerts).forEach(([sym, levels]) => {
    const d = _prices[sym]; if (!d) return;
    levels.forEach(level => {
      const dist  = Math.abs(d.price - level) / level * 100;
      const type  = dist <= 0.15 ? 'hit' : dist <= 0.4 ? 'near' : null;
      if (!type) return;
      const key   = `${sym}:${level}:${type}`;
      if (_alertFired.has(key)) return;
      _alertFired.add(key);
      setTimeout(() => _alertFired.delete(key), type==='hit'?1_800_000:900_000);
      if (type==='hit' && _notifOk) { try { new Notification(`🚨 ${sym} HIT ${level}`,{body:`Price: ${d.price}`}); } catch {} }
      const id = `al-${key.replace(/[:.]/g,'_')}`;
      if (!document.getElementById(id)) {
        const div = document.createElement('div');
        div.id = id;
        div.className = `alert-item alert-${type}`;
        div.innerHTML = `${type==='hit'?'🚨':'⚠'} <strong>${esc(sym)}</strong> ${type==='hit'?'HIT':'approaching'} <strong>${esc(String(level))}</strong> · ${d.price}<button class="alert-close" onclick="this.parentElement.remove()">✕</button>`;
        bar.appendChild(div);
      }
    });
  });
}

async function requestNotifications() {
  if (!('Notification' in window)) return;
  if (Notification.permission === 'granted') { _notifOk=true; return; }
  if (Notification.permission !== 'denied') {
    try { const p = await Notification.requestPermission(); _notifOk = p==='granted'; } catch {}
  }
}

function startPriceMonitor() {
  fetchPrices();
  const hasTD = !!ApiKeyStore.td();
  setInterval(fetchPrices, hasTD ? 120_000 : 300_000);
}

// ══════════════════════════════════════════════════════════════
// MAIN LOAD
// ══════════════════════════════════════════════════════════════
async function loadData() {
  try {
    ldSet(10, 'CONNECTING TO NOTION…');
    const pages = await fetchAll();
    ldSet(70, 'PARSING TRADES…');
    const raw    = pages.map(parseTrade).filter(t => t.date);
    _trades      = raw;
    const stats  = analyze(raw);
    window._lastStats = stats;
    _filtered    = [..._trades].reverse();
    ldSet(90, 'RENDERING…');

    renderKPIs(stats);
    renderEquity(stats);
    renderCalendar(stats);
    renderMonthlyR(stats);
    renderWL(stats);
    renderSessions(stats);
    renderGrade(stats);
    renderTF(stats);
    renderRDist(stats);
    renderPage();

    document.getElementById('nav-dot').className = 'nav-dot on';
    ldSet(100, 'DONE');
    setTimeout(showApp, 300);

    console.log(`[TradeOS] ${raw.length} trades loaded`);
  } catch (e) {
    if (e.message === 'NO_TOKEN') return;
    console.error('[TradeOS] Load error:', e);
    document.getElementById('ld-msg').textContent = 'ERROR: ' + e.message.slice(0,60);
    document.getElementById('nav-dot').className = 'nav-dot err';
  }
}

// ══════════════════════════════════════════════════════════════
// BOOT
// ══════════════════════════════════════════════════════════════
window.addEventListener('load', async () => {
  initNav();
  startPriceMonitor();
  requestNotifications();

  if (!TokenStore.ok(TokenStore.get())) {
    showTokenScreen();
  } else {
    loadData();
  }
});
</script>
</body>
</html>
