<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Journal ‚Äî Intelligence Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07070f;
  --s1: #0d0d1a;
  --s2: #131326;
  --border: #1c1c30;
  --border2: #252540;
  --green: #00e5a0;
  --green2: #00b87d;
  --red: #ff3355;
  --amber: #ffbb00;
  --blue: #4488ff;
  --purple: #9966ff;
  --text: #e0e0f0;
  --muted: #44446a;
  --muted2: #666688;
  --aplus: #00e5a0;
  --bgrade: #4488ff;
  --cgrade: #ffbb00;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.02) 1px,transparent 1px);background-size:44px 44px;pointer-events:none;z-index:0}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .5s}
#loader.out{opacity:0;pointer-events:none}
.ld-title{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;letter-spacing:-1px}
.ld-title span{color:var(--green)}
.ld-sub{font-size:.6rem;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin:6px 0 28px}
.ld-track{width:260px;height:2px;background:var(--border);border-radius:2px;overflow:hidden}
.ld-fill{height:100%;background:var(--green);width:0%;transition:width .3s ease;box-shadow:0 0 10px var(--green)}
.ld-status{font-size:.6rem;color:var(--muted);margin-top:10px;letter-spacing:1px}

/* TOKEN SCREEN */
#token-screen{display:none;position:fixed;inset:0;background:var(--bg);z-index:9998;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:40px}
.token-box{background:var(--s1);border:1px solid var(--border2);border-radius:14px;padding:32px;max-width:480px;width:100%}
.token-box h2{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:6px}
.token-box p{font-size:.62rem;color:var(--muted2);line-height:1.8;margin-bottom:18px}
.token-input{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:12px 14px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.72rem;outline:none;margin-bottom:12px;transition:border-color .2s}
.token-input:focus{border-color:var(--green)}
.token-btn{width:100%;background:var(--green);color:#050510;border:none;border-radius:8px;padding:13px;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;letter-spacing:1px;cursor:pointer;transition:opacity .2s}
.token-btn:hover{opacity:.85}

/* ERROR */
#error-screen{display:none;position:fixed;inset:0;background:var(--bg);z-index:9997;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:40px;text-align:center}
#error-screen h2{font-family:'Syne',sans-serif;color:var(--red)}
#error-screen p{font-size:.68rem;color:var(--muted2);max-width:440px;line-height:1.8}
.err-msg{background:var(--s1);border:1px solid var(--border2);border-radius:8px;padding:14px 20px;font-size:.62rem;color:#aaaacc;max-width:500px;white-space:pre-wrap;word-break:break-word;line-height:1.7;text-align:left}
.retry-btn{background:var(--green);color:#050510;border:none;border-radius:8px;padding:10px 24px;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;margin-top:6px}

/* APP */
#app{display:none;position:relative;z-index:1;opacity:1;visibility:visible}
#app.on{display:block!important;opacity:1!important;visibility:visible!important}
.wrap{max-width:1500px;margin:0 auto;padding:32px 20px}

/* HEADER */
header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border)}
.brand h1{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;letter-spacing:-1px}
.brand h1 span{color:var(--green)}
.brand p{font-size:.58rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-top:4px}
.hdr-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.live-badge{display:flex;align-items:center;gap:6px;background:rgba(0,229,160,.08);border:1px solid rgba(0,229,160,.2);border-radius:20px;padding:5px 12px;font-size:.58rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--green)}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:livep 2s infinite}
@keyframes livep{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,229,160,.5)}50%{opacity:.6;box-shadow:0 0 0 5px rgba(0,229,160,0)}}
.updated{font-size:.56rem;color:var(--muted);letter-spacing:.5px}
.ref-btn{background:var(--s1);border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:6px 14px;cursor:pointer;transition:all .2s;letter-spacing:1px;text-transform:uppercase}
.ref-btn:hover{border-color:var(--green);color:var(--green)}

/* ALERT */
.alert{border-radius:10px;padding:13px 18px;margin-bottom:24px;display:flex;align-items:center;gap:10px;font-size:.68rem}
.alert.danger{background:linear-gradient(135deg,rgba(255,51,85,.12),rgba(255,51,85,.04));border:1px solid rgba(255,51,85,.3)}
.alert-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;animation:livep 1.5s infinite}
.alert.danger .alert-dot{background:var(--red)}

/* KPI GRID */
.kpi-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:24px}
.kpi{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px 14px;position:relative;overflow:hidden;transition:transform .2s,border-color .2s;cursor:default}
.kpi:hover{transform:translateY(-2px);border-color:var(--border2)}
.kpi::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi.g::after{background:var(--green)}.kpi.r::after{background:var(--red)}.kpi.a::after{background:var(--amber)}.kpi.b::after{background:var(--blue)}
.kpi-lbl{font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.kpi-val{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:700;line-height:1}
.kpi-val.g{color:var(--green)}.kpi-val.r{color:var(--red)}.kpi-val.a{color:var(--amber)}.kpi-val.b{color:var(--blue)}
.kpi-sub{font-size:.5rem;color:#2a2a44;margin-top:4px}

/* GRADE LEGEND */
.grade-legend{display:flex;gap:12px;margin-bottom:24px;align-items:center}
.gl-item{display:flex;align-items:center;gap:6px;font-size:.6rem;color:var(--muted2)}
.gl-dot{width:10px;height:10px;border-radius:50%}

/* ROW LAYOUTS */
.row{display:grid;gap:12px;margin-bottom:12px}
.r-2-1{grid-template-columns:2fr 1fr}
.r-3{grid-template-columns:1fr 1fr 1fr}
.r-2{grid-template-columns:1fr 1fr}
.r-1-2{grid-template-columns:1fr 2fr}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:20px;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.card-title{font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted2);margin-bottom:2px}
.card-sub{font-size:.56rem;color:#222240;margin-bottom:14px;letter-spacing:.5px}

/* EQUITY CURVE */
#eq-wrap{position:relative}
#eq-svg{cursor:crosshair}
#eq-tooltip{position:absolute;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;font-size:.62rem;pointer-events:none;display:none;z-index:100;min-width:160px;box-shadow:0 8px 32px rgba(0,0,0,.4)}
#eq-tooltip .tt-date{color:var(--muted2);font-size:.56rem;margin-bottom:4px;letter-spacing:1px}
#eq-tooltip .tt-r{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:2px}
#eq-tooltip .tt-trade{font-size:.58rem;color:var(--muted2)}
.eq-controls{display:flex;gap:8px;margin-bottom:10px}
.eq-btn{background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.56rem;padding:4px 10px;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:1px}
.eq-btn:hover,.eq-btn.active{border-color:var(--green);color:var(--green)}

/* CALENDAR */
.cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.cal-nav{display:flex;gap:8px;align-items:center}
.cal-nav button{background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-size:.7rem;width:26px;height:26px;cursor:pointer;transition:all .15s}
.cal-nav button:hover{border-color:var(--green);color:var(--green)}
.cal-month-label{font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700;color:var(--text)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-day-name{font-size:.52rem;text-align:center;color:var(--muted);padding:4px 0;letter-spacing:1px;text-transform:uppercase}
.cal-day{min-height:44px;border-radius:6px;padding:3px;cursor:pointer;transition:all .15s;position:relative;border:1px solid transparent}
.cal-day:hover{border-color:var(--border2);background:var(--s2)}
.cal-day.empty{cursor:default;background:transparent;border-color:transparent}
.cal-day.has-trades{background:rgba(0,229,160,.06);border-color:rgba(0,229,160,.15)}
.cal-day.has-trades:hover{background:rgba(0,229,160,.12);border-color:var(--green)}
.cal-day.today{border-color:var(--blue)!important}
.day-num{font-size:.6rem;color:var(--muted2);margin-bottom:2px}
.day-dots{display:flex;flex-wrap:wrap;gap:2px;margin-top:2px}
.day-dot{width:5px;height:5px;border-radius:50%}
.day-pnl{font-size:.52rem;font-weight:600}

/* PHASE ANALYSIS */
.phase-block{border-radius:8px;padding:12px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .15s;border:1px solid transparent}
.phase-block:hover{filter:brightness(1.1);border-color:rgba(255,255,255,.1)}
.phase-label{font-size:.56rem;letter-spacing:1.5px;text-transform:uppercase;opacity:.7}
.phase-wr{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700}
.phase-trades{display:flex;gap:3px;flex-wrap:wrap;margin-top:6px}
.phase-trade-dot{width:8px;height:8px;border-radius:50%;cursor:pointer;transition:transform .15s}
.phase-trade-dot:hover{transform:scale(1.5)}

/* SESSIONS DONUTS */
.session-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.sess-item{text-align:center}
.sess-name{font-size:.56rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
.donut-wrap{position:relative;width:68px;height:68px;margin:0 auto 6px}
.donut-wrap svg{transform:rotate(-90deg)}
.donut-lbl{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700}
.sess-count{font-size:.54rem;color:#222244}

/* MISTAKES */
.mbar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer;border-radius:6px;padding:6px;transition:background .15s}
.mbar-row:hover{background:var(--s2)}
.mbar-name{font-size:.58rem;color:#8888aa;width:145px;flex-shrink:0}
.mbar-track{flex:1;height:5px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden}
.mbar-fill{height:100%;background:linear-gradient(90deg,var(--red),rgba(255,51,85,.3));border-radius:3px;transition:width 1.2s ease;width:0%}
.mbar-count{font-size:.6rem;color:var(--red);width:18px;text-align:right}

/* RECENT TRADES TABLE */
.trade-table{width:100%;border-collapse:collapse}
.trade-table th{font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:7px 8px;text-align:left;border-bottom:1px solid var(--border)}
.trade-table td{font-size:.62rem;padding:9px 8px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle;cursor:pointer}
.trade-table tr:hover td{background:rgba(255,255,255,.02)}
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:.54rem;letter-spacing:1px;font-weight:600}
.badge.win{background:rgba(0,229,160,.1);color:var(--green);border:1px solid rgba(0,229,160,.2)}
.badge.lose{background:rgba(255,51,85,.1);color:var(--red);border:1px solid rgba(255,51,85,.2)}
.badge.be{background:rgba(255,187,0,.1);color:var(--amber);border:1px solid rgba(255,187,0,.2)}
.grade-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:.54rem;font-weight:700;letter-spacing:.5px}
.grade-badge.aplus{background:rgba(0,229,160,.15);color:var(--aplus);border:1px solid rgba(0,229,160,.3)}
.grade-badge.b{background:rgba(68,136,255,.15);color:var(--bgrade);border:1px solid rgba(68,136,255,.3)}
.grade-badge.c{background:rgba(255,187,0,.15);color:var(--cgrade);border:1px solid rgba(255,187,0,.3)}

/* R DISTRIBUTION */
#rdist-wrap{position:relative}
#rdist-tooltip{position:absolute;background:var(--s2);border:1px solid var(--border2);border-radius:6px;padding:8px 12px;font-size:.6rem;pointer-events:none;display:none;z-index:100}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:16px;max-width:720px;width:calc(100% - 40px);max-height:88vh;overflow-y:auto;position:relative}
.modal-header{padding:20px 24px 0;display:flex;justify-content:space-between;align-items:flex-start;position:sticky;top:0;background:var(--s1);border-radius:16px 16px 0 0;z-index:10;padding-bottom:12px;border-bottom:1px solid var(--border)}
.modal-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700}
.modal-close{background:var(--s2);border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-size:.8rem;width:28px;height:28px;cursor:pointer;transition:all .15s;flex-shrink:0}
.modal-close:hover{border-color:var(--red);color:var(--red)}
.modal-body{padding:20px 24px 24px}

/* SETUP VIEWER */
.setup-img{width:100%;border-radius:8px;border:1px solid var(--border2);margin-bottom:14px;background:var(--s2)}
.setup-img-placeholder{width:100%;height:200px;border-radius:8px;border:1px solid var(--border2);background:var(--s2);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.62rem;margin-bottom:14px}
.setup-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.meta-tag{background:var(--s2);border:1px solid var(--border2);border-radius:20px;padding:3px 10px;font-size:.56rem;color:var(--muted2)}
.setup-comment{background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:14px;font-size:.62rem;color:#aaaacc;line-height:1.8;margin-bottom:16px}
.similar-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.similar-card{background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px;cursor:pointer;transition:border-color .15s}
.similar-card:hover{border-color:var(--green)}

/* GRADE INSIGHT */
.grade-insight{border-radius:10px;padding:14px 16px;margin-bottom:14px}
.grade-insight.aplus{background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.2)}
.grade-insight.b{background:rgba(68,136,255,.06);border:1px solid rgba(68,136,255,.2)}
.grade-insight.c{background:rgba(255,187,0,.06);border:1px solid rgba(255,187,0,.2)}
.gi-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.gi-text{font-size:.62rem;color:#aaaacc;line-height:1.8}
.gi-loading{font-size:.6rem;color:var(--muted);font-style:italic}

/* CALENDAR POPUP */
.cal-popup{position:absolute;background:var(--s1);border:1px solid var(--border2);border-radius:12px;padding:16px;z-index:200;min-width:280px;box-shadow:0 16px 48px rgba(0,0,0,.5)}
.cal-popup-title{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;margin-bottom:12px;color:var(--text)}
.cal-popup-trade{background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px;margin-bottom:8px;cursor:pointer;transition:border-color .15s}
.cal-popup-trade:hover{border-color:var(--green)}

/* IMPROVEMENTS */
.imp-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.03)}
.imp-item:last-child{border-bottom:none}
.imp-icon{width:26px;height:26px;border-radius:50%;background:rgba(0,229,160,.1);border:1px solid rgba(0,229,160,.25);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:var(--green);flex-shrink:0}
.imp-text{font-size:.58rem;color:#7777aa;line-height:1.7}
.imp-text strong{color:#bbbbdd;font-weight:500}

/* WINNING SETUP */
.ws-item{background:rgba(0,229,160,.04);border:1px solid rgba(0,229,160,.12);border-radius:7px;padding:10px 12px;margin-bottom:7px}
.ws-lbl{font-size:.54rem;color:var(--green);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px}
.ws-val{font-size:.58rem;color:#7777aa;line-height:1.6}

/* MACRO ECONOMICS */
.macro-tab{background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:6px 12px;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:1px;margin-bottom:-1px}
.macro-tab:hover{color:var(--text)}
.macro-tab.active{color:var(--green);border-bottom-color:var(--green)}
.macro-panel{animation:fadeIn .2s ease}
.macro-kpi{background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:12px 14px}
.macro-kpi-lbl{font-size:.52rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.macro-kpi-val{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;color:var(--text)}
.macro-kpi-sub{font-size:.52rem;color:var(--muted);margin-top:3px}
.regime-pill{display:inline-flex;align-items:center;padding:4px 12px;border-radius:20px;border:1px solid;font-size:.58rem;font-weight:600}
.macro-impact-card{background:var(--s2);border:1px solid var(--border2);border-radius:10px;padding:14px}
.mic-header{font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;margin-bottom:8px}
.mic-body{font-size:.6rem;color:#7777aa;line-height:1.7;margin-bottom:8px}
.mic-signal{font-size:.64rem;font-weight:700;letter-spacing:.5px}
.macro-explainer{background:var(--s2);border:1px solid var(--border2);border-radius:10px;padding:18px}
.me-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin-bottom:16px}
.me-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.me-item{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px}
.me-label{font-size:.54rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.me-value{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin-bottom:6px}
.me-impact{font-size:.58rem;color:#6666aa;line-height:1.65}
.meb-item{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:5px 0;border-bottom:1px solid rgba(255,51,85,.1);font-size:.6rem}
.meb-item:last-child{border-bottom:none}
.me-trade-tip{background:rgba(0,229,160,.04);border:1px solid rgba(0,229,160,.15);border-radius:8px;padding:14px;font-size:.62rem;color:#8888aa;line-height:1.8}
@media(max-width:900px){.me-grid{grid-template-columns:1fr 1fr}.macro-impact-card+.macro-impact-card{margin-top:8px}}
@media(max-width:600px){.me-grid{grid-template-columns:1fr}}

/* PRICE ALERTS */
#price-bar{position:fixed;top:0;left:0;right:0;z-index:9000;display:none;flex-direction:column;gap:0}
.price-alert-item{display:flex;align-items:center;gap:12px;padding:10px 20px;background:#1a0008;border-bottom:1px solid rgba(255,51,85,.3);animation:alertPulse 1.5s infinite}
.price-alert-item.near{background:#1a1000;border-bottom-color:rgba(255,187,0,.3);animation:alertPulseAmber 1.5s infinite}
@keyframes alertPulse{0%,100%{background:#1a0008}50%{background:#2a0010}}
@keyframes alertPulseAmber{0%,100%{background:#1a1000}50%{background:#2a1800}}
.pa-icon{font-size:1rem;flex-shrink:0}
.pa-text{flex:1;font-size:.64rem;color:#ffcccc}
.pa-text.near{color:#ffe5aa}
.pa-dismiss{background:transparent;border:1px solid rgba(255,255,255,.15);border-radius:4px;color:rgba(255,255,255,.4);font-size:.56rem;padding:3px 8px;cursor:pointer;transition:all .15s;flex-shrink:0}
.pa-dismiss:hover{border-color:rgba(255,255,255,.4);color:rgba(255,255,255,.7)}

/* LIVE PRICES TICKER */
#live-ticker{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;padding:12px 16px;background:var(--s1);border:1px solid var(--border);border-radius:10px;align-items:center}
.ticker-item{display:flex;flex-direction:column;gap:2px;cursor:default}
.ticker-symbol{font-size:.52rem;color:var(--muted2);letter-spacing:1.5px;text-transform:uppercase}
.ticker-price{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;transition:color .3s}
.ticker-change{font-size:.54rem}
.ticker-status{font-size:.52rem;color:var(--muted);margin-left:auto;display:flex;align-items:center;gap:5px}
.ticker-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:livep 2s infinite}
.ticker-dot.stale{background:var(--amber);animation:none}
.ticker-dot.delayed{background:var(--amber);animation:livep 4s infinite}

/* FOREX NEWS */
.news-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04);cursor:pointer;transition:background .15s;border-radius:6px;padding:8px}
.news-item:hover{background:var(--s2)}
.news-impact{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px}
.news-impact.high{background:#ff3355;box-shadow:0 0 6px #ff3355}
.news-impact.medium{background:#ffbb00}
.news-impact.low{background:#4488ff}
.news-time{font-size:.56rem;color:var(--muted2);min-width:48px;flex-shrink:0}
.news-currency{font-size:.56rem;font-weight:700;min-width:28px;flex-shrink:0}
.news-title{font-size:.6rem;color:var(--text);line-height:1.4}
.news-forecast{font-size:.54rem;color:var(--muted);margin-top:2px}
.impact-legend{display:flex;gap:12px;margin-bottom:12px}
.il-item{display:flex;align-items:center;gap:5px;font-size:.56rem;color:var(--muted2)}
.il-dot{width:7px;height:7px;border-radius:50%}

/* PLAYBOOK TABS */
.pb-tab{background:transparent;border:none;border-bottom:2px solid transparent;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.6rem;padding:8px 14px;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:1px;margin-bottom:-1px}
.pb-tab:hover{color:var(--text)}
.pb-tab.active{color:var(--green);border-bottom-color:var(--green)}
.pb-panel{animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* WEEKLY PLAYBOOK */
.playbook-day{background:var(--s2);border:1px solid var(--border2);border-radius:10px;padding:14px;margin-bottom:10px}
.pb-day-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;cursor:pointer}
.pb-day-name{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700}
.pb-day-badge{font-size:.54rem;padding:2px 8px;border-radius:10px;font-weight:600}
.pb-section{margin-bottom:8px}
.pb-section-label{font-size:.54rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted2);margin-bottom:4px}
.pb-textarea{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:6px;padding:8px 10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.62rem;resize:vertical;min-height:60px;outline:none;line-height:1.6;transition:border-color .2s}
.pb-textarea:focus{border-color:var(--green)}
.pb-save-btn{background:var(--green);color:#050510;border:none;border-radius:6px;padding:6px 16px;font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;cursor:pointer;letter-spacing:.5px;transition:opacity .2s;margin-top:8px}
.pb-save-btn:hover{opacity:.85}
.pb-saved{font-size:.56rem;color:var(--green);margin-left:8px;opacity:0;transition:opacity .3s}
.week-nav{display:flex;gap:8px;align-items:center;margin-bottom:16px}
.week-nav button{background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-size:.7rem;width:26px;height:26px;cursor:pointer;transition:all .15s}
.week-nav button:hover{border-color:var(--green);color:var(--green)}
.week-label{font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700}
.checklist-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer}
.checklist-item input[type=checkbox]{accent-color:var(--green);width:14px;height:14px;cursor:pointer}
.checklist-item label{font-size:.62rem;color:var(--muted2);cursor:pointer;line-height:1.5}

footer{margin-top:40px;padding-top:18px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:.54rem;color:#1a1a33;letter-spacing:1.5px;text-transform:uppercase}

@media(max-width:1100px){.kpi-grid{grid-template-columns:repeat(4,1fr)}.r-2-1,.r-3,.r-2,.r-1-2{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <div class="ld-title">TRADE <span>JOURNAL</span></div>
  <div class="ld-sub">Intelligence Platform</div>
  <div class="ld-track"><div class="ld-fill" id="ld-fill"></div></div>
  <div class="ld-status" id="ld-status">Initializing...</div>
</div>

<!-- TOKEN SCREEN -->
<div id="token-screen" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:9998;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:40px;">
  <div style="font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;">TRADE <span style="color:var(--green)">JOURNAL</span></div>
  <div class="token-box">
    <h2>Connect to Notion</h2>
    <p>Enter your Notion API token. Stored only in your browser ‚Äî never uploaded anywhere.<br>Get it from <strong style="color:var(--green)">notion.so/my-integrations</strong></p>
    <input class="token-input" id="token-input" type="password" placeholder="ntn_xxxxxxxxxxxxxxxxxxxx" onkeydown="if(event.key==='Enter')saveToken()"/>
    <button class="token-btn" onclick="saveToken()">CONNECT TO NOTION ‚Üí</button>
    <div style="font-size:.54rem;color:#1a1a33;margin-top:10px;text-align:center">Token saved locally ¬∑ Never sent to any server</div>
  </div>
</div>

<!-- ERROR -->
<div id="error-screen">
  <h2>‚ö† Connection Failed</h2>
  <p>Could not connect to Notion. Check the steps below and try again.</p>
  <div class="err-msg" id="err-msg"></div>
  <p style="font-size:.64rem;color:var(--muted2);max-width:400px;line-height:1.8">
    <strong style="color:#ccccee">Checklist:</strong><br>
    1. Regenerate token at <strong style="color:var(--green)">notion.so/my-integrations</strong><br>
    2. In Notion: ¬∑¬∑¬∑ ‚Üí Connections ‚Üí Connect your integration<br>
    3. Click Retry and paste new token
  </p>
  <button class="retry-btn" onclick="localStorage.removeItem('notion_token');location.reload()">‚Üª Retry with New Token</button>
</div>

<!-- TRADE DETAIL MODAL -->
<div class="modal-overlay" id="trade-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Trade Details</div>
      <button class="modal-close" onclick="closeModal('trade-modal')">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- MISTAKE MODAL -->
<div class="modal-overlay" id="mistake-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="mistake-modal-title">Mistake Examples</div>
      <button class="modal-close" onclick="closeModal('mistake-modal')">‚úï</button>
    </div>
    <div class="modal-body" id="mistake-modal-body"></div>
  </div>
</div>

<!-- CALENDAR POPUP -->
<div id="cal-popup" class="cal-popup" style="display:none"></div>

<!-- APP -->
<!-- PRICE ALERT BAR -->
<div id="price-bar"></div>

<div id="app">
<div class="wrap">

  <!-- LIVE PRICE TICKER -->
  <div id="live-ticker">
    <div class="ticker-item" id="tick-EURUSD">
      <div class="ticker-symbol">EUR/USD</div>
      <div class="ticker-price" id="tick-price-EURUSD">‚Äî</div>
      <div class="ticker-change" id="tick-chg-EURUSD">‚Äî</div>
    </div>
    <div class="ticker-item" id="tick-GBPUSD">
      <div class="ticker-symbol">GBP/USD</div>
      <div class="ticker-price" id="tick-price-GBPUSD">‚Äî</div>
      <div class="ticker-change" id="tick-chg-GBPUSD">‚Äî</div>
    </div>
    <div class="ticker-item" id="tick-DXY">
      <div class="ticker-symbol">DX/Y (DXY)</div>
      <div class="ticker-price" id="tick-price-DXY">‚Äî</div>
      <div class="ticker-change" id="tick-chg-DXY">‚Äî</div>
    </div>
    <div class="ticker-item" id="tick-XAUUSD">
      <div class="ticker-symbol">XAU/USD</div>
      <div class="ticker-price" id="tick-price-XAUUSD">‚Äî</div>
      <div class="ticker-change" id="tick-chg-XAUUSD">‚Äî</div>
    </div>
    <div class="ticker-status">
      <div class="ticker-dot" id="ticker-dot"></div>
      <span id="ticker-status-text" style="font-size:.52rem;color:var(--muted)">Connecting...</span>
    </div>
  </div>

  <header>
    <div class="brand">
      <h1>TRADE <span>JOURNAL</span></h1>
      <p id="hdr-sub">Intelligence Platform ¬∑ Live Notion Sync</p>
    </div>
    <div class="hdr-right">
      <div class="live-badge"><div class="live-dot"></div>Live Notion Sync</div>
      <div class="updated" id="updated-time">‚Äî</div>
      <button class="ref-btn" onclick="loadData()">‚Üª Refresh</button>
      <button class="ref-btn" id="notif-btn" onclick="requestNotificationsManual()" title="Enable price alerts on this device">üîî Enable Alerts</button>
    </div>
  </header>

  <div class="alert danger" id="acct-alert" style="display:none"></div>

  <!-- GRADE LEGEND -->
  <div class="grade-legend">
    <span style="font-size:.56rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-right:4px">Setup Grade:</span>
    <div class="gl-item"><div class="gl-dot" style="background:var(--aplus)"></div>A+ Full Confluence</div>
    <div class="gl-item"><div class="gl-dot" style="background:var(--bgrade)"></div>B Good Setup</div>
    <div class="gl-item"><div class="gl-dot" style="background:var(--cgrade)"></div>C Partial / Forced</div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid" id="kpi-grid"></div>

  <!-- ROW 1: Equity Curve + Calendar -->
  <div class="row r-2-1">
    <div class="card">
      <div class="card-title">Equity Curve</div>
      <div class="card-sub">Hover for details ¬∑ Click to view trade ¬∑ Colour = setup grade</div>
      <div class="eq-controls">
        <button class="eq-btn active" onclick="setRange('all',this)">ALL</button>
        <button class="eq-btn" onclick="setRange('3m',this)">3M</button>
        <button class="eq-btn" onclick="setRange('1m',this)">1M</button>
      </div>
      <div id="eq-wrap" style="position:relative">
        <svg id="eq-svg" width="100%" height="220" viewBox="0 0 800 220"></svg>
        <div id="eq-tooltip">
          <div class="tt-date" id="tt-date"></div>
          <div class="tt-r" id="tt-r"></div>
          <div class="tt-trade" id="tt-trade"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Calendar</div>
      <div class="card-sub">Click any day with trades to see setups</div>
      <div class="cal-header">
        <button class="cal-nav" id="cal-prev" onclick="calNav(-1)" style="background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-size:.7rem;width:26px;height:26px;cursor:pointer">‚Äπ</button>
        <div class="cal-month-label" id="cal-label"></div>
        <button class="cal-nav" id="cal-next" onclick="calNav(1)" style="background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-size:.7rem;width:26px;height:26px;cursor:pointer">‚Ä∫</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
  </div>

  <!-- ROW 2: Monthly R + W/L + Sessions -->
  <div class="row r-3">
    <div class="card">
      <div class="card-title">Monthly R</div>
      <div class="card-sub">Net R per month ¬∑ colour = phase</div>
      <svg id="mr-svg" width="100%" height="150" viewBox="0 0 300 150"></svg>
    </div>
    <div class="card">
      <div class="card-title">Monthly W/L</div>
      <div class="card-sub">Trade count by outcome</div>
      <svg id="wl-svg" width="100%" height="150" viewBox="0 0 300 150"></svg>
    </div>
    <div class="card">
      <div class="card-title">Sessions</div>
      <div class="card-sub">Win rate by session</div>
      <div class="session-row" id="sess-row"></div>
    </div>
  </div>

  <!-- ROW 3: Phase Analysis + Mistake Frequency -->
  <div class="row r-2">
    <div class="card">
      <div class="card-title">Phase Analysis</div>
      <div class="card-sub">Click phase to expand ¬∑ dots = individual trades coloured by grade</div>
      <div id="phase-container"></div>
    </div>
    <div class="card">
      <div class="card-title">Mistake Frequency</div>
      <div class="card-sub">Click any mistake to see real examples with setups</div>
      <div id="mistakes-wrap"></div>
    </div>
  </div>

  <!-- ROW 4: R Distribution + Entry TF + Winning Setup -->
  <div class="row r-3">
    <div class="card">
      <div class="card-title">R Distribution</div>
      <div class="card-sub">Wins vs losses ‚Äî hover bars for count</div>
      <div id="rdist-wrap" style="position:relative">
        <svg id="rdist-svg" width="100%" height="160" viewBox="0 0 360 160"></svg>
        <div id="rdist-tooltip" style="position:absolute;background:var(--s2);border:1px solid var(--border2);border-radius:6px;padding:8px 12px;font-size:.6rem;pointer-events:none;display:none;z-index:100"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Entry TF Win Rates</div>
      <div class="card-sub">Best performing timeframes</div>
      <svg id="tf-svg" width="100%" height="100" viewBox="0 0 300 100"></svg>
      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
        <div class="card-title" style="margin-bottom:8px">Winning Setup Blueprint</div>
        <div class="ws-item"><div class="ws-lbl">‚úì Session</div><div class="ws-val">London KZ ¬∑ 1am‚Äì4am EST ¬∑ C2 closure confirms</div></div>
        <div class="ws-item"><div class="ws-lbl">‚úì Confluences</div><div class="ws-val">Sweep ‚Üí SMT (DXY/GBP) ‚Üí Secondary CISD ‚Üí FVG M5</div></div>
        <div class="ws-item"><div class="ws-lbl">‚úì Context</div><div class="ws-val">Clear DOL ¬∑ C3 not expanded ¬∑ No pending liq above</div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Areas of Growth</div>
      <div class="card-sub">Improvements across your journal</div>
      <div class="imp-item"><div class="imp-icon">‚Üë</div><div class="imp-text"><strong>Self-Awareness</strong> ‚Äî Early: 1-line entries. Feb '26: detailed paragraphs identifying exact missing confluences.</div></div>
      <div class="imp-item"><div class="imp-icon">‚è±</div><div class="imp-text"><strong>Timing Edge</strong> ‚Äî Mapped London: 3‚Äì4am C2, 5am expansion, 11am consolidation.</div></div>
      <div class="imp-item"><div class="imp-icon">üß†</div><div class="imp-text"><strong>Emotional Control</strong> ‚Äî Dec '25: 6 revenge trades. Feb '26: "not emotionally connected to this loss."</div></div>
      <div class="imp-item"><div class="imp-icon">üìê</div><div class="imp-text"><strong>AOX Model</strong> ‚Äî Nov 27: 5.4R, 4R, 6R in one day. Ceiling is very high when disciplined.</div></div>
    </div>
  </div>

  <!-- ROW 5: All Trades (full width with pagination) -->
  <div class="card" style="margin-bottom:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
      <div class="card-title">All Trades</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="trade-search" type="text" placeholder="Search pair, session, outcome..." style="background:var(--s2);border:1px solid var(--border2);border-radius:6px;padding:5px 10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.6rem;outline:none;width:220px" oninput="filterTrades()" onfocus="this.style.borderColor='var(--green)'" onblur="this.style.borderColor='var(--border2)'">
        <select id="trade-filter-grade" onchange="filterTrades()" style="background:var(--s2);border:1px solid var(--border2);border-radius:6px;padding:5px 8px;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.6rem;outline:none;cursor:pointer">
          <option value="">All Grades</option>
          <option value="A+">A+ Only</option>
          <option value="B">B Only</option>
          <option value="C">C Only</option>
        </select>
        <select id="trade-filter-outcome" onchange="filterTrades()" style="background:var(--s2);border:1px solid var(--border2);border-radius:6px;padding:5px 8px;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.6rem;outline:none;cursor:pointer">
          <option value="">All Outcomes</option>
          <option value="Win">Wins</option>
          <option value="Lose">Losses</option>
        </select>
      </div>
    </div>
    <div class="card-sub" id="recent-sub">Click any row to see full setup ‚Äî image, comment, similar trades & AI grade insight</div>
    <div style="overflow-x:auto">
      <table class="trade-table">
        <thead><tr>
          <th>#</th><th>Date</th><th>Pair</th><th>Dir</th><th>Session</th><th>HTF</th><th>Confluences</th><th>R</th><th>Result</th><th>Grade</th><th>Insight</th>
        </tr></thead>
        <tbody id="recent-tbody"></tbody>
      </table>
    </div>
    <!-- Pagination -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:12px;border-top:1px solid var(--border);flex-wrap:wrap;gap:8px">
      <div id="trade-page-info" style="font-size:.6rem;color:var(--muted2)"></div>
      <div style="display:flex;gap:6px;align-items:center" id="trade-pagination"></div>
    </div>
  </div>

  <!-- FOREX NEWS + WEEKLY PLAYBOOK -->
  <div class="row r-2" style="margin-bottom:12px">

    <!-- FOREX NEWS -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <div class="card-title">Forex Economic Calendar</div>
        <button onclick="loadNews()" style="background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.54rem;padding:4px 10px;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:1px" onmouseover="this.style.borderColor='var(--green)'" onmouseout="this.style.borderColor='var(--border2)'">‚Üª Refresh</button>
      </div>
      <div class="card-sub">High impact events this week ¬∑ XAUUSD, EURUSD, GBPUSD relevant</div>
      <div class="impact-legend">
        <div class="il-item"><div class="il-dot" style="background:#ff3355;box-shadow:0 0 4px #ff3355"></div>High Impact</div>
        <div class="il-item"><div class="il-dot" style="background:#ffbb00"></div>Medium</div>
        <div class="il-item"><div class="il-dot" style="background:#4488ff"></div>Low</div>
      </div>
      <div id="news-container">
        <div style="font-size:.62rem;color:var(--muted);font-style:italic;padding:20px 0;text-align:center">Loading economic calendar...</div>
      </div>
    </div>

    <!-- WEEKLY PLAYBOOK -->
    <div class="card" style="overflow:hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
        <div class="card-title">Weekly Playbook</div>
        <div style="display:flex;gap:6px">
          <button onclick="pbNav(-1)" style="background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-size:.7rem;width:26px;height:26px;cursor:pointer" onmouseover="this.style.borderColor='var(--green)'" onmouseout="this.style.borderColor='var(--border2)'">‚Äπ</button>
          <div id="pb-week-label" style="font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;line-height:26px;color:var(--text)">This Week</div>
          <button onclick="pbNav(1)" style="background:var(--s2);border:1px solid var(--border2);border-radius:5px;color:var(--muted2);font-size:.7rem;width:26px;height:26px;cursor:pointer" onmouseover="this.style.borderColor='var(--green)'" onmouseout="this.style.borderColor='var(--border2)'">‚Ä∫</button>
        </div>
      </div>
      <div class="card-sub" id="pb-sync-status">Notion sync ¬∑ Charts stored in Notion ¬∑ Text saved locally</div>

      <!-- TABS -->
      <div style="display:flex;gap:0;margin-bottom:16px;border-bottom:1px solid var(--border)">
        <button class="pb-tab active" id="pbt-plan" onclick="pbTab('plan')">üìã Plan</button>
        <button class="pb-tab" id="pbt-levels" onclick="pbTab('levels')">üéØ Key Areas</button>
        <button class="pb-tab" id="pbt-charts" onclick="pbTab('charts')">üìä Charts</button>
        <button class="pb-tab" id="pbt-review" onclick="pbTab('review')">‚úÖ Review</button>
      </div>

      <!-- TAB: PLAN -->
      <div id="pb-panel-plan" class="pb-panel">
        <div class="pb-section">
          <div class="pb-section-label">Weekly Bias & HTF Context</div>
          <textarea class="pb-textarea" id="pb-bias" rows="4" placeholder="e.g. XAUUSD bullish ‚Äî price swept weekly lows, now targeting 2080 ERL. DXY bearish structure after rejecting 104.50 resistance. Looking for London KZ entries on pullbacks to OB..."></textarea>
        </div>
        <div class="pb-section">
          <div class="pb-section-label">DXY Outlook</div>
          <textarea class="pb-textarea" id="pb-dxy" rows="2" placeholder="e.g. DXY bearish ‚Äî broke below 103.80, targeting 103.20 weekly FVG..."></textarea>
        </div>
        <div class="pb-section">
          <div class="pb-section-label">Pre-Trade Checklist (A+ Only)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
            <div class="checklist-item"><input type="checkbox" id="chk1"><label for="chk1">London KZ window (1‚Äì4am EST)</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk2"><label for="chk2">Liquidity sweep confirmed</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk3"><label for="chk3">SMT confirmed (DXY/GBP)</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk4"><label for="chk4">Secondary CISD on H1/M15</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk5"><label for="chk5">C3 not yet expanded</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk6"><label for="chk6">SL at swing invalidation</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk7"><label for="chk7">TP marked before entry</label></div>
            <div class="checklist-item"><input type="checkbox" id="chk8"><label for="chk8">Max 1 trade today rule</label></div>
          </div>
        </div>
        <div class="pb-section">
          <div class="pb-section-label">Mistakes to Avoid This Week</div>
          <textarea class="pb-textarea" id="pb-avoid" rows="2" placeholder="e.g. Do NOT enter before SMT. Do NOT trade NY session. Stick to 0.25% risk only..."></textarea>
        </div>
      </div>

      <!-- TAB: KEY AREAS -->
      <div id="pb-panel-levels" class="pb-panel" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div class="pb-section">
            <div class="pb-section-label" style="color:var(--green)">XAUUSD Key Areas</div>
            <textarea class="pb-textarea" id="pb-xau" rows="4" placeholder="Bullish OB: 2020‚Äì2025&#10;Weekly FVG: 2040‚Äì2045&#10;ERL Target: 2080&#10;Invalidation: below 2010"></textarea>
          </div>
          <div class="pb-section">
            <div class="pb-section-label" style="color:var(--blue)">EURUSD Key Areas</div>
            <textarea class="pb-textarea" id="pb-eur" rows="4" placeholder="H4 OB: 1.0850&#10;Daily FVG: 1.0870‚Äì1.0880&#10;Target: 1.0920 old high&#10;Invalidation: below 1.0820"></textarea>
          </div>
          <div class="pb-section">
            <div class="pb-section-label" style="color:var(--amber)">GBPUSD Key Areas</div>
            <textarea class="pb-textarea" id="pb-gbp" rows="4" placeholder="Weekly support: 1.2650&#10;H4 FVG: 1.2680‚Äì1.2700&#10;Target: 1.2780 ERL&#10;Invalidation: below 1.2620"></textarea>
          </div>
          <div class="pb-section">
            <div class="pb-section-label" style="color:var(--muted2)">DXY / Other</div>
            <textarea class="pb-textarea" id="pb-dxy2" rows="4" placeholder="DXY resistance: 104.50&#10;Support: 103.20&#10;Bias confirms at: below 103.80&#10;Watch: USDJPY reaction at 148"></textarea>
          </div>
        </div>
      </div>

      <!-- TAB: CHARTS -->
      <div id="pb-panel-charts" class="pb-panel" style="display:none">
        <div id="pb-notion-charts">
          <div style="text-align:center;padding:30px;color:var(--muted);font-size:.66rem">
            <div style="font-size:1.5rem;margin-bottom:8px">üìä</div>
            Loading charts from Notion...
          </div>
        </div>
        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
          <div class="pb-section-label">Add Chart to Notion</div>
          <div style="font-size:.6rem;color:var(--muted2);line-height:1.8;background:var(--s2);border-radius:8px;padding:12px;border:1px solid var(--border2)">
            <strong style="color:var(--text)">How to add charts:</strong><br>
            1. Open your Weekly Playbook in Notion<br>
            2. Find or create this week's entry<br>
            3. Attach your annotated chart screenshots to the <strong style="color:var(--green)">Charts</strong> property<br>
            4. Come back and click <strong style="color:var(--green)">‚Üª Reload Charts</strong> below
          </div>
          <button onclick="loadPlaybookCharts()" style="margin-top:10px;background:var(--s2);border:1px solid var(--border2);border-radius:6px;color:var(--muted2);font-family:'JetBrains Mono',monospace;font-size:.6rem;padding:7px 16px;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:1px" onmouseover="this.style.borderColor='var(--green)';this.style.color='var(--green)'" onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--muted2)'">‚Üª Reload Charts from Notion</button>
        </div>
      </div>

      <!-- TAB: REVIEW -->
      <div id="pb-panel-review" class="pb-panel" style="display:none">
        <div class="pb-section">
          <div class="pb-section-label" style="color:var(--green)">What Went Well</div>
          <textarea class="pb-textarea" id="pb-good" rows="3" placeholder="e.g. Followed the checklist on Tuesday. Waited for SMT before entering. Respected the 1 trade rule all week..."></textarea>
        </div>
        <div class="pb-section">
          <div class="pb-section-label" style="color:var(--red)">What Went Wrong</div>
          <textarea class="pb-textarea" id="pb-bad" rows="3" placeholder="e.g. Broke the rule on Thursday ‚Äî entered before CISD. Moved SL on Friday trade..."></textarea>
        </div>
        <div class="pb-section">
          <div class="pb-section-label" style="color:var(--amber)">Next Week Focus</div>
          <textarea class="pb-textarea" id="pb-next" rows="2" placeholder="e.g. Only London KZ. No trades after 6am. Must have 3 confluences minimum..."></textarea>
        </div>
        <div class="pb-section">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px">
            <div style="text-align:center;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px">
              <div class="pb-section-label" style="margin-bottom:4px">Week R</div>
              <input id="pb-week-r" type="number" step="0.1" placeholder="0.0" style="width:100%;background:transparent;border:none;color:var(--green);font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;text-align:center;outline:none">
            </div>
            <div style="text-align:center;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px">
              <div class="pb-section-label" style="margin-bottom:4px">Trades</div>
              <input id="pb-week-trades" type="number" placeholder="0" style="width:100%;background:transparent;border:none;color:var(--blue);font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;text-align:center;outline:none">
            </div>
            <div style="text-align:center;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px">
              <div class="pb-section-label" style="margin-bottom:4px">Wins</div>
              <input id="pb-week-wins" type="number" placeholder="0" style="width:100%;background:transparent;border:none;color:var(--green);font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;text-align:center;outline:none">
            </div>
            <div style="text-align:center;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px">
              <div class="pb-section-label" style="margin-bottom:4px">Losses</div>
              <input id="pb-week-losses" type="number" placeholder="0" style="width:100%;background:transparent;border:none;color:var(--red);font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;text-align:center;outline:none">
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
        <button class="pb-save-btn" onclick="savePlaybook()">üíæ Save to Notion + Browser</button>
        <span class="pb-saved" id="pb-saved" style="font-size:.58rem;color:var(--green);opacity:0;transition:opacity .3s">‚úì Saved!</span>
        <span id="pb-notion-status" style="font-size:.56rem;color:var(--muted2)"></span>
      </div>
    </div>
  </div>

  <!-- MACRO ECONOMICS SECTION -->
  <div class="card" style="margin-bottom:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
      <div>
        <div class="card-title">Macro Economic Dashboard</div>
        <div class="card-sub">How global data impacts your currencies ¬∑ <span id="macro-last-update" style="color:var(--green)">Loading...</span></div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="setMacroTab('overview')" class="macro-tab active" id="mt-overview">üìä Overview</button>
        <button onclick="setMacroTab('usd')"      class="macro-tab"        id="mt-usd">üá∫üá∏ USD</button>
        <button onclick="setMacroTab('eur')"      class="macro-tab"        id="mt-eur">üá™üá∫ EUR</button>
        <button onclick="setMacroTab('gbp')"      class="macro-tab"        id="mt-gbp">üá¨üáß GBP</button>
        <button onclick="setMacroTab('gold')"     class="macro-tab"        id="mt-gold">ü•á Gold</button>
      </div>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="macro-overview" class="macro-panel">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px" id="macro-kpis">
        <div class="macro-kpi" id="mk-dxy">
          <div class="macro-kpi-lbl">DXY Live</div>
          <div class="macro-kpi-val" id="mk-dxy-val">‚Äî</div>
          <div class="macro-kpi-sub" id="mk-dxy-sub">Dollar Index</div>
        </div>
        <div class="macro-kpi">
          <div class="macro-kpi-lbl">Fed Rate</div>
          <div class="macro-kpi-val" id="live-fed-rate">‚Äî</div>
          <div class="macro-kpi-sub" id="live-fed-rate-sub">FOMC Target</div>
        </div>
        <div class="macro-kpi" id="mk-inflation">
          <div class="macro-kpi-lbl">US CPI YoY</div>
          <div class="macro-kpi-val" id="live-cpi">Loading...</div>
          <div class="macro-kpi-sub" id="live-cpi-sub">Target: 2.0%</div>
        </div>
        <div class="macro-kpi" id="mk-nfp">
          <div class="macro-kpi-lbl">NFP Last</div>
          <div class="macro-kpi-val" id="live-nfp">Loading...</div>
          <div class="macro-kpi-sub" id="live-nfp-sub">Non-Farm Payrolls</div>
        </div>
      </div>

      <!-- Upcoming Events Banner -->
      <div id="macro-next-events" style="display:none;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
        <span style="font-size:.54rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px">This week:</span>
      </div>

      <!-- Macro Regime Bar -->
      <div style="margin-bottom:16px;padding:14px;background:var(--s2);border:1px solid var(--border2);border-radius:10px">
        <div style="font-size:.58rem;color:var(--muted2);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px">Current Macro Regime</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div class="regime-pill" style="background:rgba(255,187,0,.1);border-color:rgba(255,187,0,.25);color:var(--amber)">‚ö° Fed on Pause ‚Äî 4.25‚Äì4.50%</div>
          <div class="regime-pill" style="background:rgba(255,51,85,.12);border-color:rgba(255,51,85,.3);color:var(--red)">üî¥ CPI Sticky at 2.9% (Above Target)</div>
          <div class="regime-pill" style="background:rgba(0,229,160,.08);border-color:rgba(0,229,160,.2);color:var(--green)">‚úÖ Labour Market Resilient</div>
          <div class="regime-pill" style="background:rgba(68,136,255,.1);border-color:rgba(68,136,255,.25);color:var(--blue)">üìä Markets Pricing 1‚Äì2 Cuts in 2025</div>
          <div class="regime-pill" style="background:rgba(153,102,255,.1);border-color:rgba(153,102,255,.25);color:var(--purple)" id="macro-ff-events">‚è≥ Loading calendar events...</div>
        </div>
      </div>

      <!-- Extra KPIs row -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px">
        <div class="macro-kpi">
          <div class="macro-kpi-lbl">ECB Rate</div>
          <div class="macro-kpi-val" id="live-ecb-rate" style="color:var(--blue)">3.15%</div>
          <div class="macro-kpi-sub">Eurozone</div>
        </div>
        <div class="macro-kpi">
          <div class="macro-kpi-lbl">BoE Rate</div>
          <div class="macro-kpi-val" id="live-boe-rate" style="color:var(--purple)">4.75%</div>
          <div class="macro-kpi-sub">UK</div>
        </div>
        <div class="macro-kpi">
          <div class="macro-kpi-lbl">US GDP QoQ</div>
          <div class="macro-kpi-val" id="live-gdp">‚Äî</div>
          <div class="macro-kpi-sub" id="live-gdp-sub">Annualised</div>
        </div>
        <div class="macro-kpi">
          <div class="macro-kpi-lbl">Unemployment</div>
          <div class="macro-kpi-val" id="live-unemp">‚Äî</div>
          <div class="macro-kpi-sub" id="live-unemp-sub">US Rate</div>
        </div>
        <div class="macro-kpi">
          <div class="macro-kpi-lbl">Core CPI</div>
          <div class="macro-kpi-val" id="live-core-cpi">‚Äî</div>
          <div class="macro-kpi-sub">Ex Food &amp; Energy</div>
        </div>
      </div>

      <!-- Sparkline Charts Row -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
        <div style="background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:12px">
          <div style="font-size:.52rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">CPI YoY % ‚Äî Last 12 Months <span id="live-cpi-chart-label" style="color:var(--amber)"></span></div>
          <canvas id="macro-cpi-chart" width="260" height="50" style="display:block;width:100%"></canvas>
        </div>
        <div style="background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:12px">
          <div style="font-size:.52rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">NFP Monthly Change (K) ‚Äî Last 12 Months</div>
          <canvas id="macro-nfp-chart" width="260" height="50" style="display:block;width:100%"></canvas>
        </div>
      </div>

      <!-- Upcoming High-Impact Events Banner -->
      <div id="macro-events-banner" style="display:none;background:rgba(255,51,85,.05);border:1px solid rgba(255,51,85,.2);border-radius:8px;padding:12px;margin-bottom:14px">
        <div style="font-size:.54rem;color:var(--red);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px">üö® Upcoming High-Impact Events</div>
        <div id="macro-events-banner-inner"></div>
      </div>

      <!-- Impact on your pairs -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px" id="macro-pairs-impact">
        <div class="macro-impact-card">
          <div class="mic-header" style="color:var(--green)">EURUSD Impact</div>
          <div class="mic-body">Strong USD = bearish EURUSD pressure. ECB rate cuts ahead of Fed = downward bias. Watch 1.08 support. NFP beats = sell rallies.</div>
          <div class="mic-signal" style="color:var(--red)">‚¨á Bearish Bias</div>
        </div>
        <div class="macro-impact-card">
          <div class="mic-header" style="color:var(--blue)">GBPUSD Impact</div>
          <div class="mic-body">BoE holding rates longer than ECB = GBP relatively stronger vs EUR but still USD-sensitive. UK inflation sticky. Watch 1.25 support.</div>
          <div class="mic-signal" style="color:var(--amber)">‚Üî Neutral/Mixed</div>
        </div>
        <div class="macro-impact-card">
          <div class="mic-header" style="color:var(--amber)">Gold (XAUUSD) Impact</div>
          <div class="mic-body">Real yields falling = gold supportive. Rate cut cycle beginning = bullish. Dollar weakness = gold strength. Central bank buying record highs.</div>
          <div class="mic-signal" style="color:var(--green)">‚¨Ü Bullish Bias</div>
        </div>
      </div>
    </div>

    <!-- USD TAB -->
    <div id="macro-usd" class="macro-panel" style="display:none">
      <div class="macro-explainer">
        <div class="me-title">üá∫üá∏ US Dollar ‚Äî Key Drivers</div>
        <div class="me-grid">
          <div class="me-item">
            <div class="me-label">Fed Funds Rate</div>
            <div class="me-value" style="color:var(--amber)">4.25‚Äì4.50%</div>
            <div class="me-impact">IMPACT: Fed cut 100bps in late 2024 then paused. Now on hold ‚Äî inflation still above 2% target. Markets pricing only 1‚Äì2 cuts in 2025. Each cut = USD bearish. Watch FOMC dates closely.</div>
          </div>
          <div class="me-item">
            <div class="me-label">CPI Inflation</div>
            <div class="me-value" style="color:var(--amber)">2.9% YoY</div>
            <div class="me-impact">IMPACT: Jan 2025 CPI came in hotter than expected at 2.9%. Above 2% target keeps Fed on hold = USD supported. If CPI drops to 2.5% ‚Üí rate cuts sooner ‚Üí USD sells off ‚Üí Gold, EUR, GBP rally.</div>
          </div>
          <div class="me-item">
            <div class="me-label">NFP (Jobs)</div>
            <div class="me-value" style="color:var(--amber)">+143K</div>
            <div class="me-impact">IMPACT: Jan 2025 NFP came in below 200K expectations ‚Äî slight miss but still positive. Fed sees no urgency to cut. Watch for Feb NFP (Mar 7). Weak print +100K = USD selloff = buy XAUUSD dips.</div>
          </div>
          <div class="me-item">
            <div class="me-label">GDP Growth</div>
            <div class="me-value" style="color:var(--green)">+2.3% QoQ</div>
            <div class="me-impact">IMPACT: Q4 2024 GDP grew 2.3% ‚Äî solid but below 2.8% prior. Economy slowing slightly but no recession. Fed comfortable on hold. Watch Q1 2025 GDP (Apr). Below 1.5% = USD bearish.</div>
          </div>
          <div class="me-item">
            <div class="me-label">Consumer Confidence</div>
            <div class="me-value" style="color:var(--amber)">Moderate</div>
            <div class="me-impact">IMPACT: Leading indicator. Falling confidence ‚Üí slower spending ‚Üí softer economy ‚Üí rate cuts ‚Üí USD bearish. Watch Conference Board monthly.</div>
          </div>
          <div class="me-item">
            <div class="me-label">DXY Level</div>
            <div class="me-value" id="usd-dxy-live">Loading...</div>
            <div class="me-impact">IMPACT: DXY above 104 = dollar strength cycle intact. Below 102 = structural dollar weakness. Your pairs move inverse to DXY.</div>
          </div>
        </div>
        <div class="me-trade-tip">
          <strong style="color:var(--green)">Trading Application:</strong>
          On NFP Friday ‚Äî wait for the spike then fade. If NFP beats and DXY spikes ‚Üí look for XAUUSD and EURUSD to sweep highs and reverse. 
          On FOMC day ‚Äî no new positions. After statement ‚Üí let volatility settle 30 min ‚Üí then look for London model entry next day.
        </div>
      </div>
    </div>

    <!-- EUR TAB -->
    <div id="macro-eur" class="macro-panel" style="display:none">
      <div class="macro-explainer">
        <div class="me-title">üá™üá∫ Euro ‚Äî Key Drivers</div>
        <div class="me-grid">
          <div class="me-item">
            <div class="me-label">ECB Rate</div>
            <div class="me-value" style="color:var(--green)">2.75%</div>
            <div class="me-impact">IMPACT: ECB cut rates 4 times in 2024 to 2.75%. Still cutting ‚Äî another cut expected Mar 2025. ECB cutting faster than Fed = EUR bearish vs USD. Each cut widens rate differential.</div>
          </div>
          <div class="me-item">
            <div class="me-label">Eurozone CPI</div>
            <div class="me-value" style="color:var(--green)">2.5% YoY</div>
            <div class="me-impact">IMPACT: Jan 2025 Eurozone CPI at 2.5% ‚Äî near target. Gives ECB full room to cut rates. Services inflation still sticky at 3.9%. More cuts = EUR bearish vs USD.</div>
          </div>
          <div class="me-item">
            <div class="me-label">German GDP</div>
            <div class="me-value" style="color:var(--red)">-0.2% (Recession)</div>
            <div class="me-impact">IMPACT: Germany in recession = weak Eurozone engine = EUR bearish pressure. Manufacturing PMI below 50 = contraction = sell EURUSD rallies.</div>
          </div>
          <div class="me-item">
            <div class="me-label">PMI Services</div>
            <div class="me-value" style="color:var(--amber)">51.6</div>
            <div class="me-impact">IMPACT: Services above 50 = expansion keeping EUR supported. Below 50 would accelerate ECB cuts. Watch monthly flash PMI releases.</div>
          </div>
        </div>
        <div class="me-trade-tip">
          <strong style="color:var(--green)">Trading Application:</strong>
          EURUSD structural bias is bearish while Germany stagnates and ECB cuts ahead of Fed.
          Best London KZ setups: Look for sweeps of Asian session lows ‚Üí SMT with DXY ‚Üí sell into FVG targeting NY session lows.
          Avoid buying EURUSD against strong NFP weeks.
        </div>
      </div>
    </div>

    <!-- GBP TAB -->
    <div id="macro-gbp" class="macro-panel" style="display:none">
      <div class="macro-explainer">
        <div class="me-title">üá¨üáß British Pound ‚Äî Key Drivers</div>
        <div class="me-grid">
          <div class="me-item">
            <div class="me-label">BoE Rate</div>
            <div class="me-value" style="color:var(--amber)">4.50%</div>
            <div class="me-impact">IMPACT: BoE cut to 4.50% in Feb 2025. Still above ECB (2.75%) = GBP relatively stronger vs EUR. But both below Fed (4.50%) = USD remains king. Further BoE cuts = GBP weakens.</div>
          </div>
          <div class="me-item">
            <div class="me-label">UK CPI</div>
            <div class="me-value" style="color:var(--amber)">2.5% YoY</div>
            <div class="me-impact">IMPACT: UK CPI fell to 2.5% Dec 2024 ‚Äî near BoE target. Gives BoE room to cut further in 2025. Services still sticky at 4.4%. More cuts = GBP bearish. Watch monthly CPI releases.</div>
          </div>
          <div class="me-item">
            <div class="me-label">UK GDP</div>
            <div class="me-value" style="color:var(--amber)">Flat</div>
            <div class="me-impact">IMPACT: Stagnant economy limits BoE options. If UK enters recession ‚Üí forced rate cuts ‚Üí GBP sharp sell-off vs USD.</div>
          </div>
          <div class="me-item">
            <div class="me-label">GBPUSD Level</div>
            <div class="me-value" id="gbp-live-price">Loading...</div>
            <div class="me-impact">IMPACT: 1.25‚Äì1.28 range is key battleground. Below 1.25 = bearish trend. Above 1.28 = bullish. Your model: sweep 1.25 lows ‚Üí long to 1.28.</div>
          </div>
        </div>
        <div class="me-trade-tip">
          <strong style="color:var(--green)">Trading Application:</strong>
          GBPUSD is more volatile than EURUSD ‚Äî wider spreads, sharper moves.
          Best setup: London session sweep of overnight low ‚Üí SMT vs EURUSD (GBP makes new low, EUR doesn't) ‚Üí long entry on M5 FVG ‚Üí target Asian high.
          UK CPI and GDP releases = avoid trading that morning.
        </div>
      </div>
    </div>

    <!-- GOLD TAB -->
    <div id="macro-gold" class="macro-panel" style="display:none">
      <div class="macro-explainer">
        <div class="me-title">ü•á Gold (XAUUSD) ‚Äî Key Drivers</div>
        <div class="me-grid">
          <div class="me-item">
            <div class="me-label">Real Yields (10Y TIPS)</div>
            <div class="me-value" style="color:var(--amber)">+1.8%</div>
            <div class="me-impact">IMPACT: Gold moves INVERSE to real yields. Falling real yields = gold rallies. Rate cuts = real yields fall = gold bullish. Key driver.</div>
          </div>
          <div class="me-item">
            <div class="me-label">Central Bank Buying</div>
            <div class="me-value" style="color:var(--green)">Record High</div>
            <div class="me-impact">IMPACT: China, India, Poland buying gold aggressively = structural floor under gold. De-dollarisation trend = long-term bullish.</div>
          </div>
          <div class="me-item">
            <div class="me-label">DXY Correlation</div>
            <div class="me-value" style="color:var(--red)">-0.82 (Inverse)</div>
            <div class="me-impact">IMPACT: Gold moves opposite to USD ~82% of time. Weak NFP ‚Üí USD falls ‚Üí Gold spikes. Your SMT: DXY makes new high while Gold holds low = long Gold signal.</div>
          </div>
          <div class="me-item">
            <div class="me-label">XAUUSD Price</div>
            <div class="me-value" id="gold-live-price">Loading...</div>
            <div class="me-impact">IMPACT: Above 2000 = bull cycle intact. Key levels: 2020 OB, 2050 FVG, 2080 ERL, 2100 ATH. Below 1980 = trend change risk.</div>
          </div>
          <div class="me-item">
            <div class="me-label">Geopolitical Risk</div>
            <div class="me-value" style="color:var(--red)">Elevated</div>
            <div class="me-impact">IMPACT: Wars, tensions = safe haven demand for gold. Can override technical analysis. Check news before London session opens.</div>
          </div>
          <div class="me-item">
            <div class="me-label">Seasonality</div>
            <div class="me-value" style="color:var(--green)">Q1 Bullish</div>
            <div class="me-impact">IMPACT: Gold historically strong Jan‚ÄìMar (Chinese New Year demand, Indian wedding season). Q3 often weakest. Current period = seasonally supportive.</div>
          </div>
        </div>
        <div class="me-trade-tip">
          <strong style="color:var(--green)">Trading Application ‚Äî Your AOX Model on Gold:</strong>
          London KZ (1‚Äì4am EST): Wait for Asian session sweep ‚Üí DXY SMT confirmation ‚Üí Secondary CISD on M15 ‚Üí Enter on M5 FVG.
          Target: Previous day high or weekly ERL.
          Best days: Tuesday‚ÄìThursday. Avoid Monday (low volume) and Friday afternoon (NFP risk).
          Rule: If DXY and Gold BOTH making new highs together = do NOT long Gold. That's your ignored SMT mistake.
        </div>
      </div>
    </div>
  </div>

  <footer>
    <span>Abubakar Javaid ¬∑ Trade Journal</span>
    <span id="footer-count">‚Äî</span>
    <span>Intelligence Platform ¬∑ Notion Live</span>
  </footer>
</div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const WORKER_URL       = 'https://notion-proxy.churan756.workers.dev/';
const DATABASE_ID      = '1f8c2f0e01588051ac78f92b4aaf19f9';
const PLAYBOOK_DB_ID   = '30fc2f0e0158808a9ce1cb7ff70ce3aa';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ñà‚ñà  PASTE YOUR API KEYS BELOW ‚Äî LINES 1041 & 1042        ‚ñà‚ñà
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TWELVE_DATA_KEY  = '5db5f72e03dc40b4ae453edf8a437232';
const FRED_API_KEY     = '5d8f2796ad376f6a4336bdceb8818960';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let NOTION_TOKEN  = localStorage.getItem('notion_token') || '';
let ALL_TRADES    = [];
let EQ_RANGE      = 'all';
let CAL_YEAR      = new Date().getFullYear();
let CAL_MONTH     = new Date().getMonth();

// ============================================================
// LOADER / UI HELPERS
// ============================================================
function setLoader(pct, msg) {
  document.getElementById('ld-fill').style.width = pct + '%';
  document.getElementById('ld-status').textContent = msg;
}
function showError(msg) {
  document.getElementById('loader').classList.add('out');
  const es = document.getElementById('error-screen');
  es.style.display = 'flex';
  document.getElementById('err-msg').textContent = msg;
}
function showApp() {
  const loader = document.getElementById('loader');
  loader.style.opacity = '0';
  loader.style.pointerEvents = 'none';
  setTimeout(() => { loader.style.display = 'none'; }, 500);
  const app = document.getElementById('app');
  app.style.display = 'block';
  app.style.opacity = '1';
  app.style.visibility = 'visible';
  app.classList.add('on');
}
function showTokenScreen() {
  document.getElementById('loader').classList.add('out');
  document.getElementById('token-screen').style.display = 'flex';
}
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ============================================================
// TOKEN
// ============================================================
function saveToken() {
  const v = document.getElementById('token-input').value.trim();
  if (!v.startsWith('ntn_') && !v.startsWith('secret_')) {
    alert('Enter a valid Notion token (starts with ntn_ or secret_)'); return;
  }
  NOTION_TOKEN = v;
  localStorage.setItem('notion_token', v);
  document.getElementById('token-screen').style.display = 'none';
  loadData();
}

// ============================================================
// FETCH
// ============================================================
async function fetchPage(cursor = null) {
  let tok = localStorage.getItem('notion_token') || NOTION_TOKEN;
  // Clean up bad stored values
  if (!tok || tok.trim() === '' || tok === 'null' || tok === 'undefined' || tok === 'false') {
    localStorage.removeItem('notion_token');
    NOTION_TOKEN = '';
    document.getElementById('loader').style.display = 'none';
    showTokenScreen();
    throw new Error('SHOW_TOKEN_SCREEN');
  }
  tok = tok.trim();
  let url = WORKER_URL + '?token=' + encodeURIComponent(tok);
  if (cursor) url += '&cursor=' + encodeURIComponent(cursor);
  const res = await fetch(url, { method: 'GET' });
  const body = await res.json().catch(() => ({}));
  if (!res.ok || body.error === 'Missing token in URL params') {
    if (res.status === 400 || res.status === 401 || body.error) {
      localStorage.removeItem('notion_token');
      NOTION_TOKEN = '';
      document.getElementById('loader').style.display = 'none';
      showTokenScreen();
      throw new Error('SHOW_TOKEN_SCREEN');
    }
    throw new Error(body.error || body.message || 'HTTP ' + res.status);
  }
  return body;
}

async function fetchAll() {
  let results = [], cursor = null, page = 1;
  do {
    setLoader(20 + page * 12, `Loading page ${page}...`);
    const d = await fetchPage(cursor);
    results = results.concat(d.results || []);
    cursor = d.has_more ? d.next_cursor : null;
    page++;
  } while (cursor && page < 15);
  return results;
}

// ============================================================
// PARSE
// ============================================================
function getProp(props, key, type) {
  const p = props[key]; if (!p) return null;
  try {
    if (type === 'title')      return p.title?.map(t=>t.plain_text).join('') || '';
    if (type === 'rich_text')  return p.rich_text?.map(t=>t.plain_text).join('') || '';
    if (type === 'select')     return p.select?.name || '';
    if (type === 'date')       return p.date?.start || '';
    if (type === 'number')     return p.number ?? null;
    if (type === 'checkbox')   return p.checkbox ?? false;
    if (type === 'multi_select') return p.multi_select?.map(s=>s.name) || [];
    if (type === 'files')      return p.files?.map(f=>f.file?.url || f.external?.url).filter(Boolean) || [];
    if (type === 'url')        return p.url || '';
  } catch(e) { return null; }
  return null;
}

function parseTrade(page) {
  const p = page.properties;
  const keys = Object.keys(p);
  const find = (partial, type) => {
    const k = keys.find(k => k.toLowerCase().includes(partial.toLowerCase()));
    return k ? getProp(p, k, type) : null;
  };
  const findExact = (name, type) => getProp(p, name, type);

  return {
    id: page.id,
    notionUrl: page.url,
    date:       find('date','date'),
    pair:       find('pair','select') || find('pair','rich_text'),
    direction:  find('direction','select'),
    outcome:    (()=>{
      const raw = find('outcome','select')||'';
      if (/win/i.test(raw)) return 'Win';
      if (/loss|lose/i.test(raw)) return 'Lose';
      if (/be|breakeven|break.even/i.test(raw)) return 'Breakeven';
      return raw;
    })(),
    rMultiple:  find('multiple','number') ?? find('r multiple','number'),
    session:    find('session','select'),
    htfContext: find('htf','select'),
    entryTF:    find('entry time','select') || find('entry','select'),
    comment:    find('comment','rich_text') || find('note','rich_text'),
    confluences: find('ltf','multi_select') || find('confluence','multi_select') || [],
    images:     find('files','files') || find('media','files') || [],
    htfCandle:  find('htf candle','select'),
    winBinary:  find('win','checkbox'),
  };
}

// ============================================================
// GRADING ENGINE
// ============================================================
function gradeTrade(t) {
  let score = 0;
  const conf = t.confluences || [];
  const hasConf = (c) => conf.some(x => x.toLowerCase().includes(c.toLowerCase()));

  // Core confluences
  if (hasConf('CISD') || hasConf('CSID')) score += 2;
  if (hasConf('Displacement')) score += 2;
  if (hasConf('Sweep')) score += 2;
  if (hasConf('SMT')) score += 2;
  if (hasConf('Kill Zone') || hasConf('KZ')) score += 1;

  // Session bonus
  if (t.session === 'London KZ') score += 2;
  else if (t.session === 'New York KZ') score += 0;
  else if (t.session === 'OFF session') score += 1;

  // HTF context
  if (t.htfContext) score += 1;

  // Confluence count bonus
  if (conf.length >= 4) score += 2;
  else if (conf.length >= 3) score += 1;

  if (score >= 11) return 'A+';
  if (score >= 7)  return 'B';
  return 'C';
}

function gradeColor(g) {
  if (g === 'A+') return '#00e5a0';
  if (g === 'B')  return '#4488ff';
  return '#ffbb00';
}

function gradeInsight(t) {
  const g = t.grade;
  const outcome = t.outcome;
  const conf = (t.confluences || []).join(', ');

  if (g === 'A+' && outcome === 'Lose') {
    return `‚ö†Ô∏è You had a full A+ setup here (${conf}) but still lost. This is process-correct ‚Äî even perfect setups lose. The market respects no one. Key question: was your SL placed at the proper swing invalidation point, or too tight?`;
  }
  if (g === 'A+' && outcome === 'Win') {
    return `‚úÖ Textbook execution. Full confluence stack delivered. This is your edge ‚Äî replicate this process.`;
  }
  if (g === 'B' && outcome === 'Lose') {
    return `üìä B-grade setup loss. Missing 1-2 confluences (${conf}). Acceptable to take, but tighten the checklist ‚Äî wait for the secondary CISD before entry.`;
  }
  if (g === 'B' && outcome === 'Win') {
    return `‚úÖ Good setup won despite not being full confluence. Don't let wins on B-grade setups lead to lowering standards.`;
  }
  if (g === 'C') {
    return `üö® C-grade setup ‚Äî this was forced or premature. Missing too many confluences (only: ${conf || 'few'}). These are the trades bleeding your account. Skip C-grade setups entirely.`;
  }
  return `Grade: ${g}`;
}

function findSimilar(current, all) {
  return all.filter(t => {
    if (t.id === current.id) return false;
    const sameDir = t.direction === current.direction;
    const sameSess = t.session === current.session;
    const sameHTF = t.htfContext === current.htfContext;
    const currConf = new Set((current.confluences || []).map(c=>c.toLowerCase()));
    const tConf = (t.confluences || []).map(c=>c.toLowerCase());
    const overlap = tConf.filter(c => currConf.has(c)).length;
    return sameDir && sameSess && overlap >= 2;
  }).slice(0, 3);
}

// ============================================================
// ANALYSIS
// ============================================================
function analyze(trades) {
  const valid = trades.filter(t=>t.date).sort((a,b)=>new Date(a.date)-new Date(b.date));
  valid.forEach(t => { t.grade = gradeTrade(t); });

  const wins   = valid.filter(t=>t.outcome==='Win');
  const losses = valid.filter(t=>t.outcome==='Lose');
  const bes    = valid.filter(t=>t.outcome==='Breakeven');

  let running = 0;
  valid.forEach(t => { running += t.rMultiple||0; t.cumR = Math.round(running*100)/100; });

  const months = {};
  valid.forEach(t => {
    const d = new Date(t.date);
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    if (!months[k]) months[k] = { label: d.toLocaleString('en-US',{month:'short',year:'2-digit'}), wins:0,losses:0,bes:0,r:0,trades:[],order:d.getFullYear()*100+d.getMonth() };
    months[k].trades.push(t);
    if (t.outcome==='Win') months[k].wins++;
    else if (t.outcome==='Lose' || t.outcome==='Loss') months[k].losses++;
    else months[k].bes++;
    months[k].r += t.rMultiple||0;
  });
  const sortedMonths = Object.values(months).sort((a,b)=>a.order-b.order).map(m=>({...m,r:Math.round(m.r*100)/100}));

  const sessions = {};
  valid.forEach(t => {
    const s = t.session||'Unknown';
    if (!sessions[s]) sessions[s]={wins:0,total:0};
    sessions[s].total++;
    if (t.outcome==='Win') sessions[s].wins++;
  });

  const tfs = {};
  valid.forEach(t => {
    const tf = t.entryTF||'Unknown';
    if (!tfs[tf]) tfs[tf]={wins:0,total:0};
    tfs[tf].total++;
    if (t.outcome==='Win') tfs[tf].wins++;
  });

  const peakR = Math.max(...valid.map(t=>t.cumR),0);
  const currentR = valid.length ? valid[valid.length-1].cumR : 0;
  const winRate = valid.length ? Math.round(wins.length/valid.length*100) : 0;
  const avgWin = wins.length ? Math.round(wins.reduce((s,t)=>s+(t.rMultiple||0),0)/wins.length*100)/100 : 0;

  // By day for calendar
  const byDay = {};
  valid.forEach(t => {
    const k = t.date.slice(0,10);
    if (!byDay[k]) byDay[k] = [];
    byDay[k].push(t);
  });

  return { valid, wins, losses, bes, sortedMonths, sessions, tfs, peakR, currentR, winRate, avgWin, byDay };
}

// ============================================================
// PHASE HELPER
// ============================================================
function getPhase(trade) {
  const d = new Date(trade.date);
  const ym = d.getFullYear()*100 + d.getMonth();
  if (ym < 202511) return { label:'Phase 1 ‚Äî Early', color:'rgba(0,229,160,0.15)', border:'#00e5a0', text:'#00e5a0' };
  if (ym === 202511) return { label:'Phase 2 ‚Äî Peak Nov', color:'rgba(0,229,160,0.22)', border:'#00e5a0', text:'#00e5a0' };
  if (ym === 202512) return { label:'Phase 3 ‚Äî Dec Crash', color:'rgba(255,51,85,0.15)', border:'#ff3355', text:'#ff3355' };
  return { label:'Phase 4 ‚Äî New Year Recovery', color:'rgba(255,187,0,0.12)', border:'#ffbb00', text:'#ffbb00' };
}

// ============================================================
// RENDER: KPIs
// ============================================================
function renderKPIs(s) {
  const lonWR = s.sessions['London KZ'] ? Math.round(s.sessions['London KZ'].wins/s.sessions['London KZ'].total*100) : 0;
  const nyWR  = s.sessions['New York KZ'] ? Math.round(s.sessions['New York KZ'].wins/s.sessions['New York KZ'].total*100) : 0;
  const aplus = s.valid.filter(t=>t.grade==='A+').length;
  const kpis = [
    {l:'Total Trades',v:s.valid.length,sub:`${s.wins.length}W / ${s.losses.length}L`,cls:'b'},
    {l:'Win Rate',v:s.winRate+'%',sub:'all time',cls:s.winRate>=50?'g':'a'},
    {l:'Peak Equity',v:'+'+s.peakR+'R',sub:'highest R',cls:'a'},
    {l:'Current Equity',v:(s.currentR>=0?'+':'')+s.currentR+'R',sub:'cumulative',cls:s.currentR>=0?'g':'r'},
    {l:'Avg Win',v:'+'+s.avgWin+'R',sub:'per winner',cls:'g'},
    {l:'London WR',v:lonWR+'%',sub:(s.sessions['London KZ']?.total||0)+' trades',cls:'b'},
    {l:'A+ Setups',v:aplus,sub:`${Math.round(aplus/s.valid.length*100)}% of trades`,cls:'g'},
  ];
  document.getElementById('kpi-grid').innerHTML = kpis.map(k=>`
    <div class="kpi ${k.cls}">
      <div class="kpi-lbl">${k.l}</div>
      <div class="kpi-val ${k.cls}">${k.v}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');
}

// ============================================================
// RENDER: EQUITY CURVE (interactive)
// ============================================================
function renderEquity(stats) {
  const svg = document.getElementById('eq-svg');
  svg.innerHTML = '';
  let data = stats.valid;
  const now = new Date();
  if (EQ_RANGE === '3m') { const cut = new Date(now); cut.setMonth(cut.getMonth()-3); data = data.filter(t=>new Date(t.date)>=cut); }
  if (EQ_RANGE === '1m') { const cut = new Date(now); cut.setMonth(cut.getMonth()-1); data = data.filter(t=>new Date(t.date)>=cut); }
  if (!data.length) return;

  // Recalculate cumR for filtered range
  let run = EQ_RANGE==='all' ? 0 : (data[0].cumR - (data[0].rMultiple||0));
  const pts = data.map(t => { run += t.rMultiple||0; return {...t, displayR: Math.round(run*100)/100}; });

  const W=800,H=220,pL=42,pR=16,pT=20,pB=30;
  const w=W-pL-pR, h=H-pT-pB;
  const vals = pts.map(p=>p.displayR);
  const minV = Math.min(...vals,0)-2;
  const maxV = Math.max(...vals)+2;
  const n = pts.length;
  const px = i => pL + (i/(n-1||1))*w;
  const py = v => pT + h - ((v-minV)/(maxV-minV))*h;

  // Defs
  svg.innerHTML = `<defs>
    <linearGradient id="eg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#00e5a0" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="#00e5a0" stop-opacity="0"/>
    </linearGradient>
    <clipPath id="eq-clip"><rect x="${pL}" y="${pT}" width="${w}" height="${h}"/></clipPath>
  </defs>`;

  // Zero line
  const zY = py(0);
  svg.innerHTML += `<line x1="${pL}" x2="${W-pR}" y1="${zY}" y2="${zY}" stroke="rgba(255,255,255,0.08)" stroke-dasharray="4,3"/>`;

  // Grid lines
  [Math.round(maxV/2), Math.round(maxV)].forEach(v => {
    if(v <= minV) return;
    const y = py(v);
    svg.innerHTML += `<line x1="${pL}" x2="${W-pR}" y1="${y}" y2="${y}" stroke="rgba(255,255,255,0.04)"/>`;
    svg.innerHTML += `<text x="${pL-5}" y="${y+3}" fill="#333355" font-size="8" font-family="JetBrains Mono" text-anchor="end">${v}R</text>`;
  });
  svg.innerHTML += `<text x="${pL-5}" y="${zY+3}" fill="#444466" font-size="8" font-family="JetBrains Mono" text-anchor="end">0</text>`;

  // Area fill
  let areaD = `M ${px(0)} ${py(0)} `;
  pts.forEach((_,i) => areaD += `L ${px(i)} ${py(vals[i])} `);
  areaD += `L ${px(n-1)} ${py(0)} Z`;
  svg.innerHTML += `<path d="${areaD}" fill="url(#eg)" clip-path="url(#eq-clip)"/>`;

  // Coloured segments by grade
  for (let i = 1; i < n; i++) {
    const color = gradeColor(pts[i].grade);
    svg.innerHTML += `<line x1="${px(i-1)}" y1="${py(vals[i-1])}" x2="${px(i)}" y2="${py(vals[i])}" stroke="${color}" stroke-width="2" opacity="0.9" clip-path="url(#eq-clip)"/>`;
  }

  // Dots (clickable)
  pts.forEach((t,i) => {
    const color = gradeColor(t.grade);
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', px(i)); circle.setAttribute('cy', py(vals[i]));
    circle.setAttribute('r', 3.5); circle.setAttribute('fill', color);
    circle.setAttribute('stroke', 'var(--bg)'); circle.setAttribute('stroke-width', '1.5');
    circle.style.cursor = 'pointer';
    circle.addEventListener('mouseenter', (e) => showEqTooltip(e, t, vals[i]));
    circle.addEventListener('mouseleave', hideEqTooltip);
    circle.addEventListener('click', () => openTradeModal(t, stats.valid));
    svg.appendChild(circle);
  });

  // Peak marker
  const peakIdx = vals.indexOf(Math.max(...vals));
  if(peakIdx >= 0) {
    svg.innerHTML += `<circle cx="${px(peakIdx)}" cy="${py(vals[peakIdx])}" r="5" fill="#ffbb00" filter="drop-shadow(0 0 4px #ffbb00)"/>`;
    svg.innerHTML += `<text x="${px(peakIdx)}" y="${py(vals[peakIdx])-10}" fill="#ffbb00" font-size="8" font-family="JetBrains Mono" text-anchor="middle">PEAK +${vals[peakIdx]}R</text>`;
  }

  // X axis labels
  const step = Math.max(1, Math.floor(n/8));
  pts.forEach((t,i) => {
    if (i%step!==0 && i!==n-1) return;
    const d = new Date(t.date);
    const lbl = d.toLocaleString('en-US',{month:'short',day:'numeric'});
    svg.innerHTML += `<text x="${px(i)}" y="${H-4}" fill="#222244" font-size="7" font-family="JetBrains Mono" text-anchor="middle">${lbl}</text>`;
  });
}

function showEqTooltip(e, t, r) {
  const tt = document.getElementById('eq-tooltip');
  const d = new Date(t.date);
  document.getElementById('tt-date').textContent = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
  document.getElementById('tt-r').textContent = (r>=0?'+':'')+r+'R cumulative';
  document.getElementById('tt-r').style.color = gradeColor(t.grade);
  document.getElementById('tt-trade').textContent = `${t.pair||''} ${t.direction||''} ¬∑ ${t.outcome||''} ¬∑ Grade: ${t.grade}`;
  const wrap = document.getElementById('eq-wrap');
  const rect = wrap.getBoundingClientRect();
  const svgEl = document.getElementById('eq-svg');
  const svgRect = svgEl.getBoundingClientRect();
  let left = e.clientX - rect.left + 12;
  if (left + 170 > rect.width) left = e.clientX - rect.left - 182;
  tt.style.left = left + 'px';
  tt.style.top = (e.clientY - rect.top - 20) + 'px';
  tt.style.display = 'block';
}

function hideEqTooltip() { document.getElementById('eq-tooltip').style.display = 'none'; }

function setRange(r, btn) {
  EQ_RANGE = r;
  document.querySelectorAll('.eq-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (ALL_TRADES.length) renderEquity(analyze(ALL_TRADES));
}

// ============================================================
// RENDER: CALENDAR
// ============================================================
function renderCalendar(byDay) {
  const d = new Date(CAL_YEAR, CAL_MONTH, 1);
  const label = d.toLocaleString('en-US',{month:'long',year:'numeric'});
  document.getElementById('cal-label').textContent = label;

  const firstDay = d.getDay();
  const daysInMonth = new Date(CAL_YEAR, CAL_MONTH+1, 0).getDate();
  const today = new Date();
  const grid = document.getElementById('cal-grid');

  let html = ['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d=>`<div class="cal-day-name">${d}</div>`).join('');

  for (let i=0; i<firstDay; i++) html += `<div class="cal-day empty"></div>`;

  for (let day=1; day<=daysInMonth; day++) {
    const dateStr = `${CAL_YEAR}-${String(CAL_MONTH+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const dayTrades = byDay[dateStr] || [];
    const isToday = today.getFullYear()===CAL_YEAR && today.getMonth()===CAL_MONTH && today.getDate()===day;
    const hasTrades = dayTrades.length > 0;
    const totalR = dayTrades.reduce((s,t)=>s+(t.rMultiple||0),0);
    const rColor = totalR > 0 ? 'var(--green)' : totalR < 0 ? 'var(--red)' : 'var(--muted2)';

    const dots = dayTrades.map(t=>`<div class="day-dot" style="background:${gradeColor(t.grade)}" title="${t.pair} ${t.outcome}"></div>`).join('');

    html += `<div class="cal-day ${hasTrades?'has-trades':''} ${isToday?'today':''}"
      onclick="${hasTrades?`showCalPopup(event,'${dateStr}')`:''}"
      style="cursor:${hasTrades?'pointer':'default'}">
      <div class="day-num">${day}</div>
      ${hasTrades ? `<div class="day-dots">${dots}</div>` : ''}
      ${hasTrades ? `<div class="day-pnl" style="color:${rColor}">${totalR>0?'+':''}${Math.round(totalR*100)/100}R</div>` : ''}
    </div>`;
  }
  grid.innerHTML = html;
}

function calNav(dir) {
  CAL_MONTH += dir;
  if (CAL_MONTH > 11) { CAL_MONTH = 0; CAL_YEAR++; }
  if (CAL_MONTH < 0)  { CAL_MONTH = 11; CAL_YEAR--; }
  if (ALL_TRADES.length) renderCalendar(analyze(ALL_TRADES).byDay);
}

function showCalPopup(e, dateStr) {
  const popup = document.getElementById('cal-popup');
  const stats = analyze(ALL_TRADES);
  const trades = stats.byDay[dateStr] || [];
  if (!trades.length) return;

  const d = new Date(dateStr);
  const label = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  let html = `<div class="cal-popup-title">${label}</div>`;
  trades.forEach(t => {
    const rC = (t.rMultiple||0)>=0?'var(--green)':'var(--red)';
    html += `<div class="cal-popup-trade" onclick="openTradeModal(window._calTrades['${t.id}'], window._allTrades); document.getElementById('cal-popup').style.display='none'">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="font-size:.62rem;font-weight:600;color:var(--text)">${t.pair||'‚Äî'} ${t.direction||''}</span>
        <span class="grade-badge ${t.grade==='A+'?'aplus':t.grade.toLowerCase()}">${t.grade}</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="badge ${t.outcome?.toLowerCase()==='win'?'win':t.outcome?.toLowerCase()==='lose'?'lose':'be'}">${t.outcome||'‚Äî'}</span>
        <span style="font-size:.6rem;color:${rC}">${(t.rMultiple||0)>=0?'+':''}${t.rMultiple||'‚Äî'}R</span>
        <span style="font-size:.56rem;color:var(--muted2)">${t.session||''}</span>
      </div>
    </div>`;
  });
  html += `<div style="font-size:.54rem;color:var(--muted);margin-top:6px;text-align:right;cursor:pointer" onclick="document.getElementById('cal-popup').style.display='none'">‚úï Close</div>`;
  popup.innerHTML = html;

  // Store refs for onclick
  window._calTrades = {};
  window._allTrades = stats.valid;
  trades.forEach(t => window._calTrades[t.id] = t);

  // Position
  const rect = e.target.closest('.cal-day').getBoundingClientRect();
  const card = e.target.closest('.card').getBoundingClientRect();
  popup.style.display = 'block';
  popup.style.top = (rect.bottom - card.top + 4) + 'px';
  popup.style.left = Math.min(rect.left - card.left, card.width - 290) + 'px';
}

// Close cal popup on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('#cal-popup') && !e.target.closest('.cal-day')) {
    document.getElementById('cal-popup').style.display = 'none';
  }
});

// ============================================================
// RENDER: TRADE MODAL
// ============================================================
function openTradeModal(trade, allTrades) {
  if (!trade) return;
  const d = new Date(trade.date);
  document.getElementById('modal-title').textContent = `${trade.pair||'Trade'} ¬∑ ${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;

  const similar = findSimilar(trade, allTrades);
  const insight = gradeInsight(trade);
  const rC = (trade.rMultiple||0)>=0?'var(--green)':'var(--red)';
  const gradeCls = trade.grade==='A+'?'aplus':trade.grade.toLowerCase();

  let imgHtml = '';
  if (trade.images && trade.images.length > 0) {
    imgHtml = trade.images.map(url => `<img src="${url}" class="setup-img" alt="Setup chart" onerror="this.style.display='none'">`).join('');
  } else {
    imgHtml = `<div class="setup-img-placeholder">üìä No chart image attached in Notion</div>`;
  }

  let similarHtml = '';
  if (similar.length > 0) {
    similarHtml = `
      <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
        <div style="font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted2);margin-bottom:10px">Similar Past Setups</div>
        <div class="similar-grid">
          ${similar.map(s => {
            const sd = new Date(s.date);
            const sR = (s.rMultiple||0)>=0?'var(--green)':'var(--red)';
            return `<div class="similar-card" onclick="closeModal('trade-modal');setTimeout(()=>openTradeModal(window._allTrades.find(t=>t.id==='${s.id}'),window._allTrades),200)">
              <div style="font-size:.58rem;color:var(--muted2)">${sd.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>
              <div style="font-size:.68rem;font-weight:600;color:var(--text);margin:2px 0">${s.pair} ${s.direction}</div>
              <div style="display:flex;gap:6px;align-items:center;margin-top:4px">
                <span class="badge ${s.outcome?.toLowerCase()==='win'?'win':'lose'}">${s.outcome}</span>
                <span style="font-size:.58rem;color:${sR}">${(s.rMultiple||0)>=0?'+':''}${s.rMultiple||'‚Äî'}R</span>
                <span class="grade-badge ${s.grade==='A+'?'aplus':s.grade.toLowerCase()}">${s.grade}</span>
              </div>
              <div style="font-size:.54rem;color:var(--muted);margin-top:4px">${(s.confluences||[]).join(', ')}</div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
  }

  document.getElementById('modal-body').innerHTML = `
    ${imgHtml}
    <div class="setup-meta">
      <div class="meta-tag">${trade.pair||'‚Äî'}</div>
      <div class="meta-tag">${trade.direction||'‚Äî'}</div>
      <div class="meta-tag">${trade.session||'‚Äî'}</div>
      <div class="meta-tag">${trade.htfContext||'‚Äî'}</div>
      <div class="meta-tag">${trade.entryTF||'‚Äî'}</div>
      ${(trade.confluences||[]).map(c=>`<div class="meta-tag" style="color:var(--green)">${c}</div>`).join('')}
    </div>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
      <span class="badge ${trade.outcome?.toLowerCase()==='win'?'win':trade.outcome?.toLowerCase()==='lose'?'lose':'be'}">${trade.outcome||'‚Äî'}</span>
      <span style="font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;color:${rC}">${(trade.rMultiple||0)>=0?'+':''}${trade.rMultiple||'‚Äî'}R</span>
      <span class="grade-badge ${gradeCls}">${trade.grade}</span>
      ${trade.notionUrl ? `<a href="${trade.notionUrl}" target="_blank" style="font-size:.56rem;color:var(--muted2);text-decoration:none;border:1px solid var(--border2);border-radius:4px;padding:2px 8px">Open in Notion ‚Üó</a>` : ''}
    </div>
    <div class="grade-insight ${gradeCls}">
      <div class="gi-header">
        <span class="grade-badge ${gradeCls}">${trade.grade}</span>
        <span style="font-size:.62rem;color:var(--muted2);font-weight:600">Grade Insight</span>
      </div>
      <div class="gi-text">${insight}</div>
    </div>
    ${trade.comment ? `<div style="font-size:.58rem;color:var(--muted2);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">Journal Entry</div><div class="setup-comment">${trade.comment}</div>` : '<div class="setup-comment" style="color:var(--muted)">No journal comment recorded for this trade.</div>'}
    ${similarHtml}
  `;

  window._allTrades = allTrades;
  openModal('trade-modal');
}

// ============================================================
// RENDER: MONTHLY R
// ============================================================
function renderMonthlyR(sortedMonths) {
  const svg = document.getElementById('mr-svg');
  svg.innerHTML = '';
  const months = sortedMonths.slice(-8);
  if (!months.length) return;

  const W=300, H=150, pL=10, pR=8, pT=16, pB=28;
  const cW = W-pL-pR, cH = H-pT-pB;
  const maxAbs = Math.max(...months.map(m=>Math.abs(m.r)), 0.1);
  const bW = Math.max(Math.floor(cW/months.length) - 4, 6);
  const zY = pT + cH/2; // zero line in middle

  // zero line
  svg.innerHTML += `<line x1="${pL}" x2="${W-pR}" y1="${zY}" y2="${zY}" stroke="rgba(255,255,255,0.1)" stroke-dasharray="3,3"/>`;

  months.forEach((m, i) => {
    const x = pL + i*(cW/months.length) + 2;
    // Color based on actual R value: positive=green, negative=red, zero=amber
    const clr = m.r > 0 ? '#00e5a0' : m.r < 0 ? '#ff3355' : '#ffbb00';
    const halfH = cH / 2;
    const bH = Math.max((Math.abs(m.r) / maxAbs) * halfH, 2);
    const isPos = m.r >= 0;
    const barY = isPos ? zY - bH : zY;

    // Draw bar immediately ‚Äî no transition needed
    svg.innerHTML += `<rect x="${x}" y="${barY}" width="${bW}" height="${bH}" fill="${clr}" rx="2" opacity="0.88"/>`;

    // Value label
    const lblY = isPos ? barY - 4 : barY + bH + 9;
    svg.innerHTML += `<text x="${x+bW/2}" y="${lblY}" fill="${clr}" font-size="7" font-family="JetBrains Mono" text-anchor="middle">${m.r>0?'+':''}${m.r}</text>`;

    // Month label
    svg.innerHTML += `<text x="${x+bW/2}" y="${H-5}" fill="#334" font-size="6" font-family="JetBrains Mono" text-anchor="middle">${m.label.replace(' ','')}</text>`;
  });
}
// ============================================================
// RENDER: W/L BARS
// ============================================================
function renderWL(sortedMonths) {
  const svg = document.getElementById('wl-svg');
  svg.innerHTML = '';
  const months = sortedMonths.slice(-8);
  if (!months.length) return;

  const W=300, H=150, pL=8, pR=8, pT=22, pB=26;
  const cW = W-pL-pR, cH = H-pT-pB;
  const maxT = Math.max(...months.map(m => m.wins+m.losses+m.bes), 1);
  const bW   = Math.max(Math.floor(cW/months.length) - 4, 6);
  const baseY = pT + cH;

  // Legend
  svg.innerHTML += `
    <rect x="0" y="3" width="7" height="7" fill="#00e5a0" rx="1"/>
    <text x="10" y="10" fill="#555577" font-size="6.5" font-family="JetBrains Mono">Win</text>
    <rect x="34" y="3" width="7" height="7" fill="#ff3355" rx="1"/>
    <text x="44" y="10" fill="#555577" font-size="6.5" font-family="JetBrains Mono">Loss</text>
    <rect x="72" y="3" width="7" height="7" fill="#ffbb00" rx="1"/>
    <text x="82" y="10" fill="#555577" font-size="6.5" font-family="JetBrains Mono">BE</text>`;

  // Base line
  svg.innerHTML += `<line x1="${pL}" x2="${W-pR}" y1="${baseY}" y2="${baseY}" stroke="rgba(255,255,255,0.08)"/>`;

  months.forEach((m, i) => {
    const x = pL + i*(cW/months.length) + 2;
    const wH = Math.max((m.wins   / maxT) * cH, m.wins   > 0 ? 2 : 0);
    const lH = Math.max((m.losses / maxT) * cH, m.losses > 0 ? 2 : 0);
    const bH = Math.max((m.bes    / maxT) * cH, m.bes    > 0 ? 2 : 0);

    // Stack from base: losses first (bottom), then BE, then wins (top)
    let curY = baseY;

    if (lH > 0) {
      curY -= lH;
      svg.innerHTML += `<rect x="${x}" y="${curY}" width="${bW}" height="${lH}" fill="#ff3355" rx="1" opacity="0.85"/>`;
    }
    if (bH > 0) {
      curY -= bH;
      svg.innerHTML += `<rect x="${x}" y="${curY}" width="${bW}" height="${bH}" fill="#ffbb00" rx="1" opacity="0.85"/>`;
    }
    if (wH > 0) {
      curY -= wH;
      svg.innerHTML += `<rect x="${x}" y="${curY}" width="${bW}" height="${wH}" fill="#00e5a0" rx="1" opacity="0.85"/>`;
    }

    // Total count on top
    const total = m.wins+m.losses+m.bes;
    if (total > 0) {
      svg.innerHTML += `<text x="${x+bW/2}" y="${curY-3}" fill="#666688" font-size="6" font-family="JetBrains Mono" text-anchor="middle">${total}</text>`;
    }

    // Month label at bottom
    svg.innerHTML += `<text x="${x+bW/2}" y="${H-5}" fill="#334" font-size="6" font-family="JetBrains Mono" text-anchor="middle">${m.label.replace(' ','')}</text>`;
  });
}
// ============================================================
// RENDER: SESSIONS
// ============================================================
function renderSessions(sessions) {
  const sessMap = [
    {key:'London KZ',label:'London',color:'#4488ff'},
    {key:'New York KZ',label:'New York',color:'#ff3355'},
    {key:'OFF session',label:'Off Session',color:'#00e5a0'},
  ];
  document.getElementById('sess-row').innerHTML = sessMap.map(s => {
    const d = sessions[s.key]||{wins:0,total:0};
    const wr = d.total ? Math.round(d.wins/d.total*100) : 0;
    const circ = 2*Math.PI*28;
    return `<div class="sess-item">
      <div class="sess-name">${s.label}</div>
      <div class="donut-wrap">
        <svg width="68" height="68" viewBox="0 0 68 68">
          <circle cx="34" cy="34" r="28" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="9"/>
          <circle cx="34" cy="34" r="28" fill="none" stroke="${s.color}" stroke-width="9" stroke-dasharray="${circ*wr/100} ${circ}" stroke-linecap="round" opacity=".85"/>
        </svg>
        <div class="donut-lbl" style="color:${s.color}">${wr}%</div>
      </div>
      <div class="sess-count" style="color:${s.color}">${d.total} trades</div>
    </div>`;
  }).join('');
}

// ============================================================
// RENDER: PHASE ANALYSIS (with trade dots)
// ============================================================
function renderPhase(valid) {
  const phaseDefs = [
    {id:'p1',label:'Phase 1 ‚Äî Early Trading',fn:t=>{ const d=new Date(t.date); return d<new Date('2025-11-01'); },color:'rgba(0,229,160,0.1)',border:'#00e5a0'},
    {id:'p2',label:'Phase 2 ‚Äî Peak Nov 2025', fn:t=>{ const d=new Date(t.date); return d>=new Date('2025-11-01')&&d<new Date('2025-12-01'); },color:'rgba(0,229,160,0.18)',border:'#00e5a0'},
    {id:'p3',label:'Phase 3 ‚Äî Dec Crash',     fn:t=>{ const d=new Date(t.date); return d>=new Date('2025-12-01')&&d<new Date('2026-01-01'); },color:'rgba(255,51,85,0.12)',border:'#ff3355'},
    {id:'p4',label:'Phase 4 ‚Äî New Year',      fn:t=>{ const d=new Date(t.date); return d>=new Date('2026-01-01'); },color:'rgba(255,187,0,0.1)',border:'#ffbb00'},
  ];

  const container = document.getElementById('phase-container');
  container.innerHTML = phaseDefs.map(ph => {
    const trades = valid.filter(ph.fn);
    if (!trades.length) return '';
    const wins = trades.filter(t=>t.outcome==='Win').length;
    const wr = Math.round(wins/trades.length*100);
    const totalR = trades.reduce((s,t)=>s+(t.rMultiple||0),0);
    const rC = totalR>=0?'var(--green)':'var(--red)';

    const dots = trades.map(t => {
      const gC = gradeColor(t.grade);
      const outlineC = t.outcome==='Win'?gC:'rgba(255,255,255,0.2)';
      return `<div class="phase-trade-dot"
        style="background:${gC};opacity:${t.outcome==='Win'?1:0.4};border:1px solid ${outlineC}"
        title="${t.pair} ${t.outcome} ${t.rMultiple||''}R ¬∑ ${t.grade}"
        onclick="openTradeModal(window._allTrades.find(x=>x.id==='${t.id}'),window._allTrades)"
      ></div>`;
    }).join('');

    return `<div class="phase-block" style="background:${ph.color};border-color:${ph.border}" onclick="this.querySelector('.phase-trades').style.display=this.querySelector('.phase-trades').style.display==='none'?'flex':'none'">
      <div>
        <div class="phase-label" style="color:${ph.border}">${ph.label}</div>
        <div class="phase-wr" style="color:${ph.border}">${wr}% WR</div>
        <div style="font-size:.56rem;color:var(--muted2);margin-top:2px">${trades.length} trades ¬∑ <span style="color:${rC}">${totalR>=0?'+':''}${Math.round(totalR*100)/100}R</span></div>
        <div class="phase-trades" style="display:none;flex-wrap:wrap;gap:3px;margin-top:8px">${dots}</div>
      </div>
      <div style="font-size:.56rem;color:var(--muted);text-align:right">
        <div>${trades.filter(t=>t.grade==='A+').length} A+</div>
        <div>${trades.filter(t=>t.grade==='B').length} B</div>
        <div>${trades.filter(t=>t.grade==='C').length} C</div>
        <div style="margin-top:4px;font-size:.52rem">click to expand</div>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// RENDER: MISTAKES
// ============================================================
// ‚îÄ‚îÄ MISTAKE DEFINITIONS with multi-strategy matching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MISTAKE_DEFS = [
  {
    name: 'Ignored / Wrong SMT',
    desc: 'Traded without SMT confirmation or misread SMT divergence',
    color: '#ff3355',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      const conf = (t.confluences||[]).map(x=>x.toLowerCase());
      const noSMT = !conf.some(x=>x.includes('smt'));
      const isLoss = (t.outcome==='Lose'||t.outcome==='Loss');
      // Match if: comment mentions SMT issue, OR trade lost AND no SMT in confluences
      return /smt|silver bullet|dxy.*wrong|wrong.*dxy|divergence.*ignored|ignored.*divergence/i.test(c)
          || (noSMT && isLoss);
    }
  },
  {
    name: 'FOMO / Revenge Trade',
    desc: 'Entered out of fear of missing out or after a loss to recover',
    color: '#ff3355',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      return /fomo|revenge|gambl|chased|jumped in|couldn.t wait|bad idea|forced|shouldn.t have|emotional|after.*loss|recover|too eager|wanted.*trade|needed.*trade/i.test(c)
          || ((t.outcome==='Lose'||t.outcome==='Loss') && t.grade==='C' && /ny|new york|off session/i.test(t.session||''));
    }
  },
  {
    name: 'Wrong Bias / Missing Context',
    desc: 'Traded against the higher timeframe direction or without clear DOL',
    color: '#ff3355',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      return /wrong bias|against.*direction|premature.*entry.*context|context missing|no context|missing context|wrong erl|wrong.*draw|didn.t check|against trend|counter trend/i.test(c);
    }
  },
  {
    name: 'Premature Entry (No CISD)',
    desc: 'Entered before secondary CISD confirmed on execution timeframe',
    color: '#ffbb00',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      const conf = (t.confluences||[]).map(x=>x.toLowerCase());
      const noCISD = !conf.some(x=>x.includes('cisd')||x.includes('csid'));
      return /premature|too early|before.*confirm|no.*cisd|without.*cisd|jumped|didn.t wait|early entry/i.test(c)
          || (noCISD && (t.outcome==='Lose'||t.outcome==='Loss') && t.grade !== 'A+');
    }
  },
  {
    name: 'Wrong SL Placement',
    desc: 'Stop loss placed at recent low/STL instead of swing invalidation',
    color: '#ffbb00',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      return /sl.*wrong|wrong.*sl|sl.*placement|bad.*sl|stop.*too tight|recent low|stl.*sl|sl.*stl|moved.*sl|stopped out.*moved/i.test(c);
    }
  },
  {
    name: 'Breaking Own Rules',
    desc: 'Deviated from the pre-defined A+ checklist during live session',
    color: '#ffbb00',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      return /broke.*rule|break.*rule|shouldn.t|against.*plan|deviat|not my setup|outside.*plan|ignored.*rule|didn.t follow/i.test(c);
    }
  },
  {
    name: 'No Displacement / FVG',
    desc: 'Entered on a retracement without displacement confirming the move',
    color: '#4488ff',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      const conf = (t.confluences||[]).map(x=>x.toLowerCase());
      const noDisp = !conf.some(x=>x.includes('displacement')||x.includes('fvg'));
      return /no displacement|lack.*displacement|no fvg|without displacement/i.test(c)
          || (noDisp && (t.outcome==='Lose'||t.outcome==='Loss'));
    }
  },
  {
    name: 'TP / RR Management',
    desc: 'Closed too early, moved TP, or had poor risk-reward target',
    color: '#4488ff',
    match: (t) => {
      const c = (t.comment||'').toLowerCase();
      return /tp.*wrong|wrong.*tp|closed.*early|moved.*tp|low rr|poor.*rr|should.*held|left.*table|cut.*profit/i.test(c);
    }
  },
];

function renderMistakes(valid) {
  // Count actual matches from real trade data
  const counts = MISTAKE_DEFS.map(m => ({
    ...m,
    trades: valid.filter(t => m.match(t)),
    count: valid.filter(t => m.match(t)).length
  }));

  const max = Math.max(...counts.map(c=>c.count), 1);

  document.getElementById('mistakes-wrap').innerHTML = counts.map((m,i) => `
    <div class="mbar-row" onclick="showMistakeModal(${i}, window._allTrades, window._mistakeCounts)">
      <div class="mbar-name" title="${m.desc}">${m.name}</div>
      <div class="mbar-track"><div class="mbar-fill" style="background:linear-gradient(90deg,${m.color},${m.color}44)" data-pct="${max>0?m.count/max*100:0}"></div></div>
      <div class="mbar-count" style="color:${m.color}">${m.count}</div>
    </div>`).join('');

  setTimeout(()=>{ document.querySelectorAll('.mbar-fill').forEach(el=>el.style.width=el.dataset.pct+'%'); }, 400);
  window._mistakeCounts = counts;
}

function showMistakeModal(idx, allTrades, counts) {
  const m = (counts || window._mistakeCounts || MISTAKE_DEFS)[idx];
  const trades = m.trades || (allTrades||[]).filter(t => MISTAKE_DEFS[idx].match(t));

  document.getElementById('mistake-modal-title').textContent = `${m.name} ¬∑ ${trades.length} trade${trades.length!==1?'s':''}`;

  let html = `
    <div style="background:rgba(255,51,85,.06);border:1px solid rgba(255,51,85,.2);border-radius:8px;padding:12px 14px;margin-bottom:16px">
      <div style="font-size:.62rem;color:#ccaaaa;line-height:1.7">${m.desc}</div>
    </div>`;

  if (trades.length === 0) {
    html += `<div style="text-align:center;padding:40px;color:var(--muted);font-size:.68rem">
      <div style="font-size:2rem;margin-bottom:10px">‚úÖ</div>
      No trades found matching this mistake pattern.<br>
      <span style="font-size:.58rem">This could mean comments don't contain keywords ‚Äî check your Notion journal entries have detailed comments.</span>
    </div>`;
  } else {
    html += `<div style="font-size:.58rem;color:var(--muted2);margin-bottom:14px;letter-spacing:1px;text-transform:uppercase">Found ${trades.length} matching trades ¬∑ Click any to view full setup</div>`;
    html += trades.map(t => {
      const d = new Date(t.date);
      const rC = (t.rMultiple||0)>=0?'var(--green)':'var(--red)';
      const outCls = t.outcome?.toLowerCase()==='win'?'win':t.outcome?.toLowerCase()==='lose'?'lose':'be';
      const gradeCls = t.grade==='A+'?'aplus':t.grade?.toLowerCase()||'c';
      const snippet = (t.comment||'No comment recorded').slice(0,240);
      const hasImg = t.images && t.images.length > 0;
      return `<div style="background:var(--s2);border:1px solid var(--border2);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;transition:border-color .15s"
        onmouseover="this.style.borderColor='var(--red)'" onmouseout="this.style.borderColor='var(--border2)'"
        onclick="closeModal('mistake-modal');setTimeout(()=>openTradeModal(window._allTrades.find(x=>x.id==='${t.id}'),window._allTrades),250)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;flex-wrap:wrap;gap:6px">
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700;color:var(--text)">${t.pair||'‚Äî'} ${t.direction||''}</div>
            <div style="font-size:.58rem;color:var(--muted2)">${d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})} ¬∑ ${t.session||'‚Äî'}</div>
          </div>
          <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap">
            <span class="badge ${outCls}">${t.outcome||'‚Äî'}</span>
            <span style="font-size:.65rem;color:${rC};font-weight:700">${(t.rMultiple||0)>=0?'+':''}${t.rMultiple??'‚Äî'}R</span>
            <span class="grade-badge ${gradeCls}">${t.grade}</span>
            ${hasImg ? '<span style="font-size:.56rem;color:var(--green);border:1px solid rgba(0,229,160,.2);border-radius:4px;padding:1px 6px">üìä Chart</span>' : ''}
          </div>
        </div>
        <div style="font-size:.6rem;color:#7777aa;line-height:1.75;background:var(--bg);border-radius:6px;padding:10px;border:1px solid var(--border)">${snippet}${t.comment?.length>240?'<span style="color:var(--muted)">... click to read full</span>':''}</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          ${(t.confluences||[]).map(c=>`<span style="background:var(--bg);border:1px solid var(--border2);border-radius:10px;padding:2px 8px;font-size:.52rem;color:var(--muted2)">${c}</span>`).join('')}
        </div>
        <div style="font-size:.52rem;color:var(--muted);margin-top:8px">Click to see full setup with chart image ‚Üí</div>
      </div>`;
    }).join('');
  }

  document.getElementById('mistake-modal-body').innerHTML = html;
  openModal('mistake-modal');
}

// ============================================================
// RENDER: R DISTRIBUTION
// ============================================================
function renderRDist(valid) {
  const container = document.getElementById('rdist-wrap');
  const svgEl = document.getElementById('rdist-svg');
  svgEl.innerHTML = '';

  // Build buckets
  const buckets = {};
  valid.forEach(t => {
    if (t.rMultiple === null || t.rMultiple === undefined) return;
    const rounded = Math.round(t.rMultiple / 0.5) * 0.5;
    const key = rounded.toFixed(1);
    if (!buckets[key]) buckets[key] = { win:0, lose:0, be:0, total:0, val: rounded };
    const o = (t.outcome||'').toLowerCase();
    if (o === 'win') buckets[key].win++;
    else if (o === 'lose' || o === 'loss') buckets[key].lose++;
    else buckets[key].be++;
    buckets[key].total++;
  });

  const keys = Object.keys(buckets).sort((a,b) => parseFloat(a) - parseFloat(b));
  if (!keys.length) {
    svgEl.innerHTML = '<text x="180" y="80" fill="#444466" font-size="12" font-family="JetBrains Mono" text-anchor="middle">No R data available</text>';
    return;
  }

  const W = 360, H = 160, pL = 32, pR = 10, pT = 18, pB = 32;
  const cW = W - pL - pR;
  const cH = H - pT - pB;
  const maxCount = Math.max(...Object.values(buckets).map(b => b.total), 1);
  const bW = Math.max(Math.floor(cW / keys.length) - 3, 6);
  const baseY = pT + cH;
  const tt = document.getElementById('rdist-tooltip');

  // Grid lines
  for (let g = 1; g <= 3; g++) {
    const gy = baseY - (g/3)*cH;
    svgEl.innerHTML += `<line x1="${pL}" x2="${W-pR}" y1="${gy}" y2="${gy}" stroke="rgba(255,255,255,0.04)"/>`;
    svgEl.innerHTML += `<text x="${pL-4}" y="${gy+3}" fill="#333355" font-size="7" font-family="JetBrains Mono" text-anchor="end">${Math.round(maxCount*g/3)}</text>`;
  }

  // Base line
  svgEl.innerHTML += `<line x1="${pL}" x2="${W-pR}" y1="${baseY}" y2="${baseY}" stroke="rgba(255,255,255,0.1)"/>`;

  keys.forEach((k, i) => {
    const b = buckets[k];
    const isPos = parseFloat(k) >= 0;
    const clr = isPos ? '#00e5a0' : '#ff3355';
    const bH = Math.max((b.total / maxCount) * cH, 3);
    const x = pL + i * (cW / keys.length) + 1;
    const finalY = baseY - bH;

    // Draw bar using innerHTML for reliability
    svgEl.innerHTML += `<rect x="${x}" y="${baseY}" width="${bW}" height="0" fill="${clr}" rx="2" opacity="0.85" id="rdbar_${i}"/>`;

    // X label
    svgEl.innerHTML += `<text x="${x + bW/2}" y="${H - 4}" fill="#333355" font-size="6" font-family="JetBrains Mono" text-anchor="middle">${parseFloat(k)>0?'+':''}${k}</text>`;

    // Count on top
    svgEl.innerHTML += `<text x="${x + bW/2}" y="${finalY - 3}" fill="${clr}" font-size="7" font-family="JetBrains Mono" text-anchor="middle" id="rdlbl_${i}">${b.total}</text>`;

    // Animate after render
    setTimeout(() => {
      const bar = document.getElementById(`rdbar_${i}`);
      if (bar) { bar.setAttribute('height', bH); bar.setAttribute('y', finalY); bar.style.transition = 'none'; }
      const lbl = document.getElementById(`rdlbl_${i}`);
      if (lbl) lbl.setAttribute('y', finalY - 3);
    }, 100 + i * 20);

    // Hover tooltip
    setTimeout(() => {
      const bar = document.getElementById(`rdbar_${i}`);
      if (!bar) return;
      bar.style.cursor = 'pointer';
      bar.addEventListener('mouseenter', (e) => {
        const wRect = container.getBoundingClientRect();
        tt.innerHTML = `<strong style="color:${clr}">${parseFloat(k)>0?'+':''}${k}R</strong><br>${b.total} trade${b.total!==1?'s':''}<br>‚úÖ ${b.win}W &nbsp; ‚ùå ${b.lose}L &nbsp; ‚ûñ ${b.be}BE`;
        tt.style.display = 'block';
        tt.style.left = Math.min(e.clientX - wRect.left + 10, wRect.width - 140) + 'px';
        tt.style.top = Math.max(e.clientY - wRect.top - 70, 0) + 'px';
      });
      bar.addEventListener('mouseleave', () => tt.style.display = 'none');
    }, 200 + i * 20);
  });

  // Legend
  svgEl.innerHTML += `
    <rect x="${pL}" y="2" width="8" height="8" fill="#00e5a0" rx="1"/>
    <text x="${pL+11}" y="9" fill="#666688" font-size="7" font-family="JetBrains Mono">Positive R</text>
    <rect x="${pL+80}" y="2" width="8" height="8" fill="#ff3355" rx="1"/>
    <text x="${pL+91}" y="9" fill="#666688" font-size="7" font-family="JetBrains Mono">Negative R</text>`;
}

// ============================================================
// RENDER: ENTRY TF
// ============================================================
function renderTF(tfs) {
  const svg = document.getElementById('tf-svg');
  svg.innerHTML = '';
  const order = ['H1/M5','H4/M15','M30/M3','M15/m1','D1/H1'];
  const data = order.filter(tf=>tfs[tf]).map(tf=>({ label:tf, wr:Math.round(tfs[tf].wins/tfs[tf].total*100), trades:tfs[tf].total }));
  if (!data.length) return;
  const W=300,H=100,pL=60,pR=55;
  const cW=W-pL-pR, rowH=14, gap=4;
  data.forEach((tf,i) => {
    const y=i*(rowH+gap)+4;
    const clr=tf.wr>=45?'#00e5a0':tf.wr>=35?'#ffbb00':'#ff3355';
    svg.innerHTML+=`<text x="0" y="${y+rowH/2+4}" fill="#666688" font-size="8" font-family="JetBrains Mono">${tf.label}</text>`;
    svg.innerHTML+=`<rect x="${pL}" y="${y}" width="${cW}" height="${rowH}" fill="rgba(255,255,255,.04)" rx="3"/>`;
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',pL); rect.setAttribute('y',y); rect.setAttribute('width',0); rect.setAttribute('height',rowH);
    rect.setAttribute('fill',clr); rect.setAttribute('rx','3'); rect.setAttribute('opacity','.75');
    svg.appendChild(rect);
    setTimeout(()=>{rect.style.transition='width .8s ease'; rect.setAttribute('width',cW*tf.wr/100);},300+i*80);
    svg.innerHTML+=`<text x="${pL+5}" y="${y+rowH/2+4}" fill="#050510" font-size="8" font-family="JetBrains Mono" font-weight="600">${tf.wr}%</text>`;
    svg.innerHTML+=`<text x="${W-5}" y="${y+rowH/2+4}" fill="#333355" font-size="7" font-family="JetBrains Mono" text-anchor="end">${tf.trades} trades</text>`;
  });
}

// ============================================================
// RENDER: ALL TRADES TABLE ‚Äî paginated + filterable
// ============================================================
let _tradePage = 1;
const TRADES_PER_PAGE = 20;
let _filteredTrades = [];

function filterTrades() {
  const search  = (document.getElementById('trade-search')?.value || '').toLowerCase();
  const grade   = document.getElementById('trade-filter-grade')?.value || '';
  const outcome = document.getElementById('trade-filter-outcome')?.value || '';
  const source  = [...(window._allTrades || [])].reverse();
  _filteredTrades = source.filter(t => {
    if (grade   && t.grade   !== grade)   return false;
    if (outcome && t.outcome !== outcome) return false;
    if (search) {
      const haystack = [t.pair, t.direction, t.session, t.outcome, t.htfContext, ...(t.confluences||[])].join(' ').toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });
  _tradePage = 1;
  renderTradesPage();
}

function renderTradesPage() {
  const allTrades = window._allTrades || [];
  if (!_filteredTrades.length && allTrades.length) filterTrades();
  const trades = _filteredTrades;
  const total  = trades.length;
  const pages  = Math.ceil(total / TRADES_PER_PAGE);
  const start  = (_tradePage - 1) * TRADES_PER_PAGE;
  const slice  = trades.slice(start, start + TRADES_PER_PAGE);

  document.getElementById('recent-sub').textContent = `${total} trades ¬∑ Click any row for full setup, image & AI grade insight`;

  document.getElementById('recent-tbody').innerHTML = slice.map((t, i) => {
    const d = new Date(t.date);
    const rC = (t.rMultiple||0) >= 0 ? 'var(--green)' : 'var(--red)';
    const gradeCls = t.grade === 'A+' ? 'aplus' : (t.grade||'c').toLowerCase();
    const outCls   = t.outcome?.toLowerCase() === 'win' ? 'win' : t.outcome?.toLowerCase() === 'lose' ? 'lose' : 'be';
    const insight  = t.grade === 'A+' && t.outcome === 'Lose' ? '‚ö†Ô∏è A+ loss ‚Äî process correct' :
                     t.grade === 'C'  && t.outcome === 'Lose' ? 'üö® C-grade ‚Äî avoid' :
                     t.grade === 'C'  && t.outcome === 'Win'  ? '‚ö° C-grade win ‚Äî don\'t repeat' :
                     t.grade === 'A+' && t.outcome === 'Win'  ? '‚úÖ Textbook' : 'üìä Review';
    const rowNum = start + i + 1;
    return `<tr onclick="openTradeModal(window._allTrades.find(x=>x.id==='${t.id}'),window._allTrades)" style="cursor:pointer">
      <td style="color:var(--muted);font-size:.54rem">${rowNum}</td>
      <td style="color:var(--muted2)">${d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'})}</td>
      <td style="font-weight:600;color:var(--text)">${t.pair||'‚Äî'}</td>
      <td style="color:${t.direction==='BUY'?'var(--green)':'var(--red)'};font-weight:600">${t.direction||'‚Äî'}</td>
      <td style="font-size:.56rem;color:var(--muted2)">${(t.session||'‚Äî').replace(' KZ','')}</td>
      <td style="font-size:.56rem;color:var(--muted2)">${t.htfContext||'‚Äî'}</td>
      <td style="font-size:.52rem;color:var(--muted)">${(t.confluences||[]).slice(0,3).join(', ')}${(t.confluences||[]).length>3?'‚Ä¶':''}</td>
      <td style="color:${rC};font-weight:600;font-size:.7rem">${(t.rMultiple||0)>=0?'+':''}${t.rMultiple??'‚Äî'}</td>
      <td><span class="badge ${outCls}">${t.outcome||'‚Äî'}</span></td>
      <td><span class="grade-badge ${gradeCls}">${t.grade}</span></td>
      <td style="font-size:.54rem;color:var(--muted2)">${insight}</td>
    </tr>`;
  }).join('');

  // Page info
  document.getElementById('trade-page-info').textContent =
    `Showing ${start+1}‚Äì${Math.min(start+TRADES_PER_PAGE,total)} of ${total} trades`;

  // Pagination buttons
  const pgEl = document.getElementById('trade-pagination');
  let pgHtml = '';
  const btnStyle = (active) => `style="background:${active?'var(--green)':'var(--s2)'};border:1px solid ${active?'var(--green)':'var(--border2)'};border-radius:5px;color:${active?'#050510':'var(--muted2)'};font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:4px 10px;cursor:pointer;min-width:28px"`;

  if (_tradePage > 1)      pgHtml += `<button ${btnStyle(false)} onclick="_tradePage=1;renderTradesPage()">¬´</button>`;
  if (_tradePage > 1)      pgHtml += `<button ${btnStyle(false)} onclick="_tradePage--;renderTradesPage()">‚Äπ</button>`;

  // Show up to 5 page buttons
  const startP = Math.max(1, _tradePage - 2);
  const endP   = Math.min(pages, startP + 4);
  for (let p = startP; p <= endP; p++) {
    pgHtml += `<button ${btnStyle(p===_tradePage)} onclick="_tradePage=${p};renderTradesPage()">${p}</button>`;
  }

  if (_tradePage < pages)  pgHtml += `<button ${btnStyle(false)} onclick="_tradePage++;renderTradesPage()">‚Ä∫</button>`;
  if (_tradePage < pages)  pgHtml += `<button ${btnStyle(false)} onclick="_tradePage=${pages};renderTradesPage()">¬ª</button>`;

  pgEl.innerHTML = pgHtml;
}

function renderRecent(valid, allTrades) {
  window._allTrades = allTrades;
  _filteredTrades = [...valid].reverse();
  _tradePage = 1;
  renderTradesPage();
}
// ============================================================
// MAIN LOAD
// ============================================================
async function loadData() {
  document.getElementById('loader').classList.remove('out');
  document.getElementById('loader').style.opacity = '1';
  document.getElementById('loader').style.pointerEvents = 'auto';
  document.getElementById('ld-fill').style.width = '0%';
  document.getElementById('app').classList.remove('on');

  try {
    setLoader(10, 'Connecting to Notion...');
    await new Promise(r=>setTimeout(r,200));

    const pages = await fetchAll();
    setLoader(75, `Parsing ${pages.length} trades...`);
    await new Promise(r=>setTimeout(r,100));

    ALL_TRADES = pages.map(parseTrade);
    // Debug: log what outcomes/pairs we got from Notion
    const outcomeSample = [...new Set(ALL_TRADES.map(t=>t.outcome))].filter(Boolean);
    const pairSample    = [...new Set(ALL_TRADES.map(t=>t.pair))].filter(Boolean).slice(0,5);
    console.log('[Dashboard] Outcomes found:', outcomeSample);
    console.log('[Dashboard] Sample pairs:', pairSample);
    console.log('[Dashboard] Total trades:', ALL_TRADES.length, '| With date:', ALL_TRADES.filter(t=>t.date).length);
    const stats = analyze(ALL_TRADES);

    setLoader(85, 'Auto-grading setups...');
    await new Promise(r=>setTimeout(r,100));

    // Alert
    const alert = document.getElementById('acct-alert');
    alert.style.display = 'flex';
    alert.innerHTML = `<div class="alert-dot"></div><span style="color:var(--red);font-weight:600;margin-right:8px">ACCOUNT STATUS:</span><span style="color:#aaaacc;font-size:.66rem">Monitor drawdown ¬∑ Max risk: <strong style="color:var(--amber)">0.25%</strong> ¬∑ London KZ only ¬∑ 1 trade/day max ¬∑ <strong style="color:var(--green)">${stats.valid.filter(t=>t.grade==='A+').length} A+ setups</strong> in history</span>`;

    renderKPIs(stats);
    renderEquity(stats);
    renderCalendar(stats.byDay);
    renderMonthlyR(stats.sortedMonths);
    renderWL(stats.sortedMonths);
    renderSessions(stats.sessions);
    renderPhase(stats.valid);
    renderMistakes(stats.valid);
    renderRDist(stats.valid);
    renderTF(stats.tfs);
    renderRecent(stats.valid, stats.valid);

    document.getElementById('hdr-sub').textContent = `Intelligence Platform ¬∑ ${stats.valid.length} trades ¬∑ ${stats.valid.filter(t=>t.grade==='A+').length} A+ setups`;
    document.getElementById('updated-time').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    document.getElementById('footer-count').textContent = `${stats.valid.length} trades ¬∑ ${stats.wins.length}W ${stats.losses.length}L ¬∑ ${stats.valid.filter(t=>t.grade==='A+').length} A+`;

    window._allTrades = stats.valid;

    // Navigate calendar to latest month with trades
    if (stats.valid.length) {
      const last = new Date(stats.valid[stats.valid.length-1].date);
      CAL_YEAR = last.getFullYear(); CAL_MONTH = last.getMonth();
      renderCalendar(stats.byDay);
    }

    setLoader(100, 'Done!');
    await new Promise(r=>setTimeout(r,350));
    showApp();

  } catch(err) {
    if (err.message === 'SHOW_TOKEN_SCREEN') return; // handled by fetchPage
    console.error('Dashboard error:', err);
    console.error('Stack:', err.stack);
    showError(err.message + '\n\nCheck browser console (F12) for details.');
  }
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if(e.target===el) el.classList.remove('open'); });
});

// ============================================================
// PLAYBOOK TABS
// ============================================================


// ============================================================
// FOREX NEWS ‚Äî ForexFactory JSON + Filters + Bank Holidays
// ============================================================
let pbWeekOffset = 0;
let _newsData    = [];
let _newsFilters = { currencies: ['USD','EUR','GBP'], impact: ['High','Medium','Low'] };











// ============================================================
// WEEKLY PLAYBOOK ‚Äî Notion connected
// ============================================================








// ‚îÄ‚îÄ SAVE PLAYBOOK TO NOTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ




// ============================================================
// LIVE PRICE ENGINE ‚Äî Twelve Data + fallbacks
// ============================================================
const PRICE_PAIRS = {
  EURUSD: { label:'EUR/USD', symbol:'EUR/USD', decimals:5 },
  GBPUSD: { label:'GBP/USD', symbol:'GBP/USD', decimals:5 },
  DXY:    { label:'DXY',     symbol:'DX-Y.NYB', decimals:3 },
  XAUUSD: { label:'XAU/USD', symbol:'XAU/USD', decimals:2 },
};

let _prices        = {};
let _alertLevels   = {};
let _firedAlerts   = new Set();
let _priceInterval = null;
let _notifGranted  = false;
let _lastPriceTs   = 0;



function applyPriceData(data) {
  ['EURUSD','GBPUSD','DXY','XAUUSD'].forEach(function(sym) {
    if (!data[sym]) return;
    var prev = _prices[sym] ? _prices[sym].price : null;
    var price = parseFloat(data[sym]);
    _prices[sym] = {
      price:     price,
      change:    prev ? price - prev : 0,
      changePct: prev ? ((price - prev) / prev * 100) : 0,
      prev:      prev,
      time:      Date.now(),
    };
  });
  updateTickerUI();
  checkAlerts();
  updateMacroPrices();
}



function setTickerStatus(state, msg) {
  var dot = document.getElementById('ticker-dot');
  var txt = document.getElementById('ticker-status-text');
  if (dot) dot.className = 'ticker-dot' + (state === 'live' ? '' : state === 'delayed' ? ' delayed' : ' stale');
  if (txt) txt.textContent = msg;
}

function fmtTime() {
  return new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}








// ============================================================
// PLAYBOOK TABS
// ============================================================
function pbTab(name) {
  ['plan','levels','charts','review'].forEach(t => {
    document.getElementById(`pb-panel-${t}`).style.display = t === name ? 'block' : 'none';
    const btn = document.getElementById(`pbt-${t}`);
    if (btn) btn.classList.toggle('active', t === name);
  });
  if (name === 'charts') loadPlaybookCharts();
}

// ============================================================
// FOREX NEWS ‚Äî ForexFactory JSON + Filters + Bank Holidays
// ============================================================

async function loadNews() {
  const container = document.getElementById('news-container');
  if (!container) return;
  container.innerHTML = '<div style="font-size:.62rem;color:var(--muted);font-style:italic;padding:20px 0;text-align:center">‚è≥ Fetching ForexFactory calendar...</div>';
  try {
    var newsUrl = WORKER_URL + '?action=news';
    var res = await fetch(newsUrl, { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('Worker news failed: ' + res.status);
    var data = await res.json();
    if (data.error) throw new Error(data.error);
    _newsData = Array.isArray(data) ? data : [];
    if (_newsData.length === 0) throw new Error('Empty feed');
    renderNews();
    console.log('[News] Loaded ' + _newsData.length + ' events from ForexFactory');
  } catch(err) {
    console.warn('[News] Live feed failed:', err.message, '‚Äî using static fallback');
    _newsData = getStaticNews();
    renderNews(true);
  }
}

function renderNews(isStatic = false) {
  const container = document.getElementById('news-container');
  if (!container) return;

  const filters = _newsFilters;
  const impactMap = { 'High':'high', 'Medium':'medium', 'Low':'low', 'Non-Economic':'low', 'Holiday':'holiday' };

  const filtered = _newsData.filter(ev => {
    const cur  = ev.country || ev.currency || '';
    const imp  = ev.impact  || '';
    if (!filters.currencies.includes(cur)) return false;
    const normImp = imp.charAt(0).toUpperCase() + imp.slice(1).toLowerCase();
    if (!filters.impact.includes(normImp) && imp !== 'Holiday') return false;
    return true;
  });

  let html = '';

  // Static warning
  if (isStatic) {
    html += `<div style="font-size:.58rem;color:var(--amber);margin-bottom:10px;padding:8px 10px;background:rgba(255,187,0,.06);border:1px solid rgba(255,187,0,.15);border-radius:6px">
      ‚ö† Live feed unavailable. Showing typical weekly events. <a href="https://www.forexfactory.com/calendar" target="_blank" style="color:var(--green)">forexfactory.com ‚Üó</a>
    </div>`;
  }

  // Filter bar
  html += `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
    <span style="font-size:.54rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Impact:</span>
    ${['High','Medium','Low'].map(imp => {
      const clr = imp==='High'?'var(--red)':imp==='Medium'?'var(--amber)':'var(--blue)';
      const active = filters.impact.includes(imp);
      return `<button onclick="toggleNewsFilter('impact','${imp}')" style="background:${active?clr+'22':'var(--s2)'};border:1px solid ${active?clr:'var(--border2)'};border-radius:10px;color:${active?clr:'var(--muted2)'};font-family:'JetBrains Mono',monospace;font-size:.54rem;padding:3px 10px;cursor:pointer;transition:all .15s">${imp}</button>`;
    }).join('')}
    <span style="font-size:.54rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-left:4px">Currency:</span>
    ${['USD','EUR','GBP','JPY','CHF'].map(cur => {
      const active = filters.currencies.includes(cur);
      return `<button onclick="toggleNewsFilter('currencies','${cur}')" style="background:${active?'rgba(68,136,255,.15)':'var(--s2)'};border:1px solid ${active?'var(--blue)':'var(--border2)'};border-radius:10px;color:${active?'var(--blue)':'var(--muted2)'};font-family:'JetBrains Mono',monospace;font-size:.54rem;padding:3px 10px;cursor:pointer;transition:all .15s">${cur}</button>`;
    }).join('')}
  </div>`;

  // Bank Holidays
  const holidays = _newsData.filter(ev => (ev.impact||'').toLowerCase() === 'holiday' || (ev.title||'').toLowerCase().includes('holiday'));
  if (holidays.length) {
    html += `<div style="margin-bottom:10px;padding:8px 10px;background:rgba(68,136,255,.06);border:1px solid rgba(68,136,255,.15);border-radius:6px">
      <div style="font-size:.54rem;color:var(--blue);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px">üè¶ Bank Holidays This Week</div>
      ${holidays.map(h => `<div style="font-size:.6rem;color:#8888aa;padding:2px 0">${h.country||''} ¬∑ ${h.title||''} ¬∑ ${formatNewsDate(h.date)}</div>`).join('')}
    </div>`;
  }

  if (!filtered.length) {
    html += `<div style="text-align:center;padding:24px;color:var(--muted);font-size:.64rem">No events matching current filters</div>`;
  } else {
    // Group by day
    const byDay = {};
    filtered.forEach(ev => {
      const d = new Date(ev.date);
      const dayKey = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
      if (!byDay[dayKey]) byDay[dayKey] = [];
      byDay[dayKey].push(ev);
    });

    Object.entries(byDay).forEach(([day, events]) => {
      html += `<div style="font-size:.56rem;color:var(--muted2);letter-spacing:1.5px;text-transform:uppercase;padding:6px 0 4px;border-top:1px solid var(--border);margin-top:4px">${day}</div>`;
      events.forEach(ev => {
        const imp = (ev.impact||'Low');
        const normImp = imp.charAt(0).toUpperCase() + imp.slice(1).toLowerCase();
        const impCls = normImp === 'High' ? 'high' : normImp === 'Medium' ? 'medium' : 'low';
        const impClr = normImp === 'High' ? 'var(--red)' : normImp === 'Medium' ? 'var(--amber)' : 'var(--blue)';
        const t = new Date(ev.date);
        const timeStr = isNaN(t) ? '' : t.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
        const forecast = ev.forecast ? ` ¬∑ F: <strong style="color:var(--text)">${ev.forecast}</strong>` : '';
        const previous = ev.previous ? ` ¬∑ P: ${ev.previous}` : '';

        html += `<div class="news-item">
          <div class="news-impact ${impCls}" style="margin-top:5px;flex-shrink:0"></div>
          <div style="flex:1;min-width:0">
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:2px">
              <span style="font-size:.58rem;font-weight:700;color:${impClr};min-width:28px">${ev.country||''}</span>
              <span style="font-size:.54rem;color:var(--muted2)">${timeStr}</span>
              ${normImp === 'High' ? `<span style="font-size:.5rem;background:rgba(255,51,85,.15);color:var(--red);border-radius:3px;padding:1px 5px;letter-spacing:1px">HIGH IMPACT</span>` : ''}
            </div>
            <div style="font-size:.62rem;color:var(--text);line-height:1.4">${ev.title||''}</div>
            ${(forecast||previous) ? `<div style="font-size:.56rem;color:var(--muted2);margin-top:2px">${forecast}${previous}</div>` : ''}
          </div>
        </div>`;
      });
    });
  }

  container.innerHTML = html;
}

function toggleNewsFilter(type, value) {
  const arr = _newsFilters[type];
  const idx = arr.indexOf(value);
  if (idx >= 0) arr.splice(idx, 1); else arr.push(value);
  renderNews(_newsData === getStaticNews());
}

function formatNewsDate(dateStr) {
  try { return new Date(dateStr).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}); }
  catch(e) { return dateStr; }
}

function getStaticNews() {
  return [
    {country:'USD',title:'S&P Global Services PMI',impact:'Medium',date:new Date(Date.now()-86400000*1).toISOString()},
    {country:'USD',title:'ISM Non-Manufacturing PMI',impact:'High',date:new Date(Date.now()-86400000*1).toISOString()},
    {country:'USD',title:'ADP Non-Farm Employment Change',impact:'High',date:new Date(Date.now()+86400000*1).toISOString()},
    {country:'USD',title:'FOMC Meeting Minutes',impact:'High',date:new Date(Date.now()+86400000*1).toISOString()},
    {country:'EUR',title:'ECB Monetary Policy Meeting Accounts',impact:'High',date:new Date(Date.now()+86400000*1).toISOString()},
    {country:'USD',title:'Initial Jobless Claims',impact:'High',date:new Date(Date.now()+86400000*2).toISOString()},
    {country:'GBP',title:'GDP m/m',impact:'High',date:new Date(Date.now()+86400000*2).toISOString()},
    {country:'USD',title:'Non-Farm Payrolls',impact:'High',date:new Date(Date.now()+86400000*3).toISOString()},
    {country:'USD',title:'Unemployment Rate',impact:'High',date:new Date(Date.now()+86400000*3).toISOString()},
    {country:'GBP',title:'Manufacturing Production m/m',impact:'Medium',date:new Date(Date.now()+86400000*3).toISOString()},
  ];
}

// ============================================================
// WEEKLY PLAYBOOK ‚Äî Notion connected
// ============================================================
async function loadPlaybook() {
  const key   = getWeekKey(pbWeekOffset);
  const saved = JSON.parse(localStorage.getItem(key) || '{}');

  const fields = ['bias','dxy','avoid','xau','eur','gbp','dxy2','good','bad','next'];
  fields.forEach(f => {
    const el = document.getElementById(`pb-${f}`);
    if (el) el.value = saved[f] || '';
  });
  const numFields = ['week-r','week-trades','week-wins','week-losses'];
  numFields.forEach(f => {
    const el = document.getElementById(`pb-${f}`);
    if (el) el.value = saved[f] || '';
  });
  for (let i = 1; i <= 8; i++) {
    const el = document.getElementById(`chk${i}`);
    if (el) el.checked = saved[`chk${i}`] || false;
  }

  document.getElementById('pb-week-label').textContent = getWeekLabel(pbWeekOffset);

  // Try load from Notion
  await loadPlaybookFromNotion();
}

async function loadPlaybookFromNotion() {
  const statusEl = document.getElementById('pb-notion-status');
  if (statusEl) statusEl.textContent = 'Loading from Notion...';
  try {
    const tok = localStorage.getItem('notion_token') || NOTION_TOKEN;
    if (!tok || tok === 'null' || tok.trim() === '') {
      if (statusEl) statusEl.textContent = 'No token ‚Äî enter token to sync';
      return;
    }
    const url = WORKER_URL + '?token=' + encodeURIComponent(tok.trim())
              + '&db=' + encodeURIComponent(PLAYBOOK_DB_ID)
              + '&action=query';
    const res  = await fetch(url);
    const data = await res.json();
    if (data.object === 'error') throw new Error(data.message);
    const pages = data.results || [];

    // Log actual property names for debugging
    if (pages.length > 0) {
      window._notionPlaybookProps = Object.keys(pages[0].properties);
      console.log('[Playbook] Notion props:', window._notionPlaybookProps);
    }

    // Find this week's entry
    const weekKey = getWeekKey(pbWeekOffset);
    const weekLabel = getWeekLabel(pbWeekOffset);
    const match = pages.find(p => {
      const tProp = Object.values(p.properties).find(v => v.type === 'title');
      const title = (tProp?.title || []).map(t => t.plain_text).join('');
      return title.indexOf(weekKey) >= 0 || title === weekLabel;
    });

    if (match) {
      const props = match.properties;
      // Get text from any rich_text property by trying multiple name variants
      const getText = (names) => {
        for (var i = 0; i < names.length; i++) {
          var p = props[names[i]];
          if (p && p.rich_text) return p.rich_text.map(t => t.plain_text).join('');
        }
        return '';
      };
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && val) el.value = val;
      };

      const biasText   = getText(['Bias','Weekly Bias','Bias & Context']);
      const keyText    = getText(['Key Area','Key Levels','Key Areas','Levels']);
      const notesText  = getText(['Notes','Weekly Notes','Note']);
      const reviewText = getText(['Review','Week Review','Reflection']);

      // Parse combined fields back into individual fields
      setVal('pb-bias', biasText);
      // Split key area back into pairs
      if (keyText) {
        const parts = keyText.split('---');
        parts.forEach(part => {
          const t = part.trim();
          if (t.startsWith('XAUUSD:')) setVal('pb-xau', t.replace('XAUUSD:','').trim());
          else if (t.startsWith('EURUSD:')) setVal('pb-eur', t.replace('EURUSD:','').trim());
          else if (t.startsWith('GBPUSD:')) setVal('pb-gbp', t.replace('GBPUSD:','').trim());
          else if (t.startsWith('DXY:'))    setVal('pb-dxy2', t.replace('DXY:','').trim());
          else if (t) setVal('pb-xau', t); // fallback
        });
      }
      if (notesText) setVal('pb-avoid', notesText);
      if (reviewText) {
        const rParts = reviewText.split(/WENT WELL:|WENT WRONG:|NEXT WEEK:/);
        if (rParts[1]) setVal('pb-good', rParts[1].trim());
        if (rParts[2]) setVal('pb-bad',  rParts[2].trim());
        if (rParts[3]) setVal('pb-next', rParts[3].trim());
      }

      if (statusEl) statusEl.textContent = '‚úì Synced from Notion ¬∑ ' + new Date().toLocaleTimeString();
    } else {
      if (statusEl) statusEl.textContent = 'No entry for this week yet ¬∑ Save to create one';
    }
  } catch(e) {
    console.error('[Playbook] Load error:', e.message);
    if (statusEl) statusEl.textContent = 'Sync error: ' + e.message;
  }
}

async function loadPlaybookCharts() {
  const chartsEl = document.getElementById('pb-notion-charts');
  if (!chartsEl) return;
  chartsEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:.62rem">‚è≥ Loading charts from Notion...</div>';
  try {
    const tok = localStorage.getItem('notion_token');
    if (!tok) throw new Error('No token');
    const url = `${WORKER_URL}?token=${encodeURIComponent(tok)}&db=${encodeURIComponent(PLAYBOOK_DB_ID)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();
    const pages = data.results || [];

    let allImages = [];
    pages.forEach(p => {
      const fileProps = Object.values(p.properties).filter(v => v.type === 'files');
      fileProps.forEach(fp => {
        (fp.files||[]).forEach(f => {
          const url = f.file?.url || f.external?.url;
          if (url) allImages.push({ url, name: f.name || 'Chart' });
        });
      });
    });

    if (!allImages.length) {
      chartsEl.innerHTML = `<div style="text-align:center;padding:30px;color:var(--muted);font-size:.66rem">
        <div style="font-size:1.5rem;margin-bottom:8px">üìä</div>
        No charts uploaded yet.<br>
        <span style="font-size:.58rem">Add annotated screenshots to the Charts property in your Weekly Playbook Notion database.</span>
      </div>`;
      return;
    }

    chartsEl.innerHTML = `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
      ${allImages.map(img => `
        <div style="border-radius:8px;overflow:hidden;border:1px solid var(--border2);cursor:pointer" onclick="window.open('${img.url}','_blank')">
          <img src="${img.url}" style="width:100%;display:block;border-radius:8px" alt="${img.name}" onerror="this.parentElement.innerHTML='<div style=padding:20px;text-align:center;color:var(--muted);font-size:.6rem>Image expired ‚Äî re-upload in Notion</div>'">
          <div style="font-size:.54rem;color:var(--muted2);padding:5px 8px;background:var(--s2)">${img.name}</div>
        </div>`).join('')}
    </div>`;
  } catch(e) {
    chartsEl.innerHTML = `<div style="text-align:center;padding:20px;color:var(--muted);font-size:.62rem">Could not load charts: ${e.message}</div>`;
  }
}

async function savePlaybook() {
  const key = getWeekKey(pbWeekOffset);
  const data = {};
  ['bias','dxy','avoid','xau','eur','gbp','dxy2','good','bad','next'].forEach(f => {
    const el = document.getElementById(`pb-${f}`);
    if (el) data[f] = el.value;
  });
  ['week-r','week-trades','week-wins','week-losses'].forEach(f => {
    const el = document.getElementById(`pb-${f}`);
    if (el) data[f] = el.value;
  });
  for (let i = 1; i <= 8; i++) {
    const el = document.getElementById(`chk${i}`);
    if (el) data[`chk${i}`] = el.checked;
  }
  localStorage.setItem(key, JSON.stringify(data));

  // Try save to Notion
  const statusEl = document.getElementById('pb-notion-status');
  if (statusEl) statusEl.textContent = 'Saving to Notion...';
  try {
    const tok = localStorage.getItem('notion_token');
    if (!tok) {
      if (statusEl) statusEl.textContent = 'No token ‚Äî saved locally only';
    } else {
      await savePlaybookToNotion(data);
      // status set inside savePlaybookToNotion
    }
  } catch(e) {
    console.error('Notion sync error:', e.message);
    const sEl = document.getElementById('pb-notion-status');
    if (sEl) sEl.textContent = 'Sync failed: ' + e.message;
  }

  const savedEl = document.getElementById('pb-saved');
  if (savedEl) { savedEl.style.opacity='1'; setTimeout(()=>savedEl.style.opacity='0',2500); }
}

// ‚îÄ‚îÄ SAVE PLAYBOOK TO NOTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function savePlaybookToNotion(data) {
  const tok = localStorage.getItem('notion_token');
  if (!tok) throw new Error('No Notion token found');

  const weekLabel = getWeekLabel(pbWeekOffset);
  const weekKey   = getWeekKey(pbWeekOffset);
  const statusEl  = document.getElementById('pb-notion-status');
  const setStatus = function(msg) { if (statusEl) statusEl.textContent = msg; };

  // Safe property builders ‚Äî no template literals with newlines
  function makeTxt(v) {
    var safe = String(v || '').slice(0, 2000);
    return { rich_text: [{ text: { content: safe } }] };
  }
  function makeTitle(v) {
    var safe = String(v || '').slice(0, 255);
    return { title: [{ text: { content: safe } }] };
  }
  function makeDate(v) {
    return { date: { start: v } };
  }
  function join2(a, b) {
    var parts = [];
    if (a) parts.push(a);
    if (b) parts.push(b);
    return parts.join('\n\n');
  }
  function join4(a, b, c, d) {
    var parts = [];
    if (a) parts.push(a);
    if (b) parts.push(b);
    if (c) parts.push(c);
    if (d) parts.push(d);
    return parts.join('\n\n---\n\n');
  }

  // Get Monday date
  var now    = new Date();
  var day    = now.getDay();
  var monday = new Date(now);
  monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1) + pbWeekOffset * 7);
  var mondayStr = monday.toISOString().split('T')[0];

  // Build property values
  var biasText    = join2(data.bias || '', data.dxy ? ('DXY: ' + data.dxy) : '');
  var keyText     = join4(
    data.xau  ? ('XAUUSD: ' + data.xau)  : '',
    data.eur  ? ('EURUSD: ' + data.eur)  : '',
    data.gbp  ? ('GBPUSD: ' + data.gbp)  : '',
    data.dxy2 ? ('DXY: '    + data.dxy2) : ''
  );
  var notesText   = join2(data.avoid || '', data.notes || '');
  var reviewParts = [];
  if (data.good)           reviewParts.push('WENT WELL:\n'        + data.good);
  if (data.bad)            reviewParts.push('WENT WRONG:\n'       + data.bad);
  if (data.next)           reviewParts.push('NEXT WEEK:\n'        + data.next);
  if (data['week-r'])      reviewParts.push('Week R: '            + data['week-r']);
  if (data['week-trades']) reviewParts.push('Trades: '            + data['week-trades']);
  var reviewText = reviewParts.join('\n\n');

  // Build properties using EXACT names from schema fetch
  var schemaProps = window._notionPlaybookProps || [];
  console.log('[Playbook] Building with schema props:', schemaProps);

  // Helper: find exact prop name case-insensitively
  function findExact(keyword) {
    var kw = keyword.toLowerCase().replace(/[^a-z]/g,'');
    for (var i = 0; i < schemaProps.length; i++) {
      var clean = schemaProps[i].toLowerCase().replace(/[^a-z]/g,'');
      if (clean === kw || clean.includes(kw) || kw.includes(clean)) return schemaProps[i];
    }
    return null;
  }

  // Find the title property (always include it ‚Äî it's the required one)
  var titlePropName = null;
  for (var si = 0; si < schemaProps.length; si++) {
    // title type is usually the first prop or named 'Week'/'Name'
    if (/^(week|name|title)$/i.test(schemaProps[si])) { titlePropName = schemaProps[si]; break; }
  }
  if (!titlePropName && schemaProps.length > 0) titlePropName = schemaProps[0];

  var pBias      = findExact('bias')      || 'Bias';
  var pKeyArea   = findExact('keyarea') || findExact('key')  || 'Key Area';
  var pNotes     = findExact('notes')     || 'Notes';
  var pReview    = findExact('review')    || 'Review';
  var pWeekStart = findExact('weekstart') || findExact('date') || 'Week Start';

  var properties = {};
  if (titlePropName) properties[titlePropName] = makeTitle(weekLabel);
  properties[pBias]      = makeTxt(biasText);
  properties[pKeyArea]   = makeTxt(keyText);
  properties[pNotes]     = makeTxt(notesText);
  properties[pReview]    = makeTxt(reviewText);
  // Only add date if prop type is 'date' (not text/title)
  var propTypes = window._notionPlaybookPropTypes || {};
  if (pWeekStart && pWeekStart !== titlePropName && propTypes[pWeekStart] === 'date') {
    properties[pWeekStart] = makeDate(mondayStr);
  }
  // Remove any properties whose type doesn't match what we're sending
  // (e.g. don't send rich_text to a title field or vice versa)
  Object.keys(properties).forEach(function(k) {
    var t = propTypes[k];
    if (t && t !== 'title' && t !== 'rich_text' && t !== 'date') {
      console.log('[Playbook] Skipping unsupported prop type:', k, t);
      delete properties[k];
    }
  });

  console.log('[Playbook] Sending properties:', Object.keys(properties));

  // Step 1 ‚Äî fetch DB schema to get EXACT property names
  setStatus('Reading Notion schema...');
  var schemaUrl = WORKER_URL + '?token=' + encodeURIComponent(tok)
                + '&db=' + encodeURIComponent(PLAYBOOK_DB_ID)
                + '&action=schema';
  var schRes  = await fetch(schemaUrl);
  var schData = await schRes.json();
  if (schData.object === 'error') throw new Error('Schema error: ' + schData.message);
  if (schData.properties) {
    window._notionPlaybookProps     = Object.keys(schData.properties);
    window._notionPlaybookPropTypes = {};
    Object.entries(schData.properties).forEach(function(kv) {
      window._notionPlaybookPropTypes[kv[0]] = kv[1].type;
    });
    console.log('[Playbook] Notion props:', window._notionPlaybookProps);
    console.log('[Playbook] Prop types:', window._notionPlaybookPropTypes);
  }

  // Step 2 ‚Äî query for existing week entry
  setStatus('Checking for existing entry...');
  var qUrl = WORKER_URL + '?token=' + encodeURIComponent(tok)
           + '&db=' + encodeURIComponent(PLAYBOOK_DB_ID)
           + '&action=query';
  var qRes  = await fetch(qUrl);
  var qData = await qRes.json();
  if (qData.object === 'error') throw new Error(qData.message || 'Notion error');

  var pages    = qData.results || [];
  var existing = null;
  for (var i = 0; i < pages.length; i++) {
    var p      = pages[i];
    var tProp  = null;
    var pKeys  = Object.keys(p.properties);
    for (var k = 0; k < pKeys.length; k++) {
      if (p.properties[pKeys[k]].type === 'title') { tProp = p.properties[pKeys[k]]; break; }
    }
    var title = tProp ? (tProp.title || []).map(function(t){ return t.plain_text; }).join('') : '';
    if (title.indexOf(weekKey) >= 0 || title === weekLabel) { existing = p; break; }
  }

  if (existing) {
    // UPDATE
    setStatus('Updating Notion entry...');
    var uUrl = WORKER_URL + '?token=' + encodeURIComponent(tok)
             + '&db=' + encodeURIComponent(PLAYBOOK_DB_ID)
             + '&action=update&pageId=' + encodeURIComponent(existing.id);
    var uRes  = await fetch(uUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ properties: properties }),
    });
    var uData = await uRes.json();
    if (uData.object === 'error') throw new Error(uData.message || 'Update failed');
    setStatus('‚úÖ Synced to Notion ¬∑ ' + new Date().toLocaleTimeString());
  } else {
    // CREATE
    setStatus('Creating Notion entry...');
    var cUrl = WORKER_URL + '?token=' + encodeURIComponent(tok)
             + '&db=' + encodeURIComponent(PLAYBOOK_DB_ID)
             + '&action=create';
    var cRes  = await fetch(cUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ properties: properties }),
    });
    var cData = await cRes.json();
    if (cData.object === 'error') throw new Error(cData.message || 'Create failed');
    setStatus('‚úÖ Saved to Notion ¬∑ ' + new Date().toLocaleTimeString());
  }
}



// ============================================================
// LIVE PRICE ENGINE + ALERTS
// ============================================================
const PRICE_SYMBOLS = {
  EURUSD: { label:'EUR/USD', decimals:5 },
  GBPUSD: { label:'GBP/USD', decimals:5 },
  DXY:    { label:'DXY',     decimals:3 },
  XAUUSD: { label:'XAU/USD', decimals:2 },
};


// Parse alert levels from playbook key area fields
function parseAlertLevels() {
  _alertLevels = {};
  const fieldMap = {
    EURUSD: 'pb-eur',
    GBPUSD: 'pb-gbp',
    DXY:    'pb-dxy2',
    XAUUSD: 'pb-xau',
  };
  Object.entries(fieldMap).forEach(([sym, fieldId]) => {
    const el = document.getElementById(fieldId);
    if (!el || !el.value) return;
    const nums = el.value.match(/\d{1,5}\.?\d{0,5}/g);
    if (nums) {
      _alertLevels[sym] = nums.map(parseFloat).filter(n => n > 0);
    }
  });
}

// ‚îÄ‚îÄ PRICE ENGINE ‚Äî open.er-api.com (free, no key, CORS ok) ‚îÄ‚îÄ
async function fetchPrices() {
  var hasTD   = TWELVE_DATA_KEY && TWELVE_DATA_KEY !== 'PASTE_TWELVE_DATA_KEY_HERE';
  var source  = hasTD ? 'twelvedata' : 'exchangerate';

  try {
    // Build worker URL ‚Äî always pass tdkey if we have it so worker uses Twelve Data
    var url = WORKER_URL + '?action=prices&source=' + source;
    if (hasTD) {
      url += '&tdkey=' + encodeURIComponent(TWELVE_DATA_KEY);
    }

    var res  = await fetch(url, { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    var data = await res.json();
    if (data.error) throw new Error(data.error);

    // Apply prices
    ['EURUSD','GBPUSD','DXY','XAUUSD'].forEach(function(sym) {
      if (!data[sym]) return;
      var prev = _prices[sym] ? _prices[sym].price : null;
      var price = parseFloat(data[sym]);
      if (isNaN(price)) return;
      _prices[sym] = {
        price:     price,
        change:    prev !== null ? +(price - prev).toFixed(6) : 0,
        changePct: prev !== null ? +((price - prev) / prev * 100).toFixed(4) : 0,
        prev:      prev,
        time:      Date.now(),
      };
    });

    updateTickerUI();
    updateMacroPrices();
    checkAlerts();

    var dot = document.getElementById('ticker-dot');
    var txt = document.getElementById('ticker-status-text');
    if (dot) dot.className = 'ticker-dot';
    if (txt) {
      var srcLabel = data.source === 'twelvedata' ? 'Twelve Data ¬∑ Live' : 'Rate feed ¬∑ Hourly';
      txt.textContent = srcLabel + ' ¬∑ ' + new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }
    console.log('[Prices] Updated from', data.source || source, '| EURUSD:', _prices.EURUSD ? _prices.EURUSD.price : 'N/A');

  } catch(e) {
    console.warn('[Prices] Fetch failed:', e.message);
    var dot2 = document.getElementById('ticker-dot');
    var txt2 = document.getElementById('ticker-status-text');
    if (dot2) dot2.className = 'ticker-dot stale';
    if (txt2) txt2.textContent = 'Prices paused ¬∑ Retrying...';
  }
}

function setPriceData(sym, price, change) {
  var prev = _prices[sym] ? _prices[sym].price : null;
  _prices[sym] = { price: price, change: change, changePct: 0, prev: prev, time: Date.now() };
}

function round(v, d) {
  var factor = Math.pow(10, d);
  return Math.round(v * factor) / factor;
}

function updateTickerUI() {
  var pairs = {
    EURUSD: { label:'EUR/USD', dec:5 },
    GBPUSD: { label:'GBP/USD', dec:5 },
    DXY:    { label:'DXY',    dec:3 },
    XAUUSD: { label:'XAU/USD', dec:2 },
  };
  Object.keys(pairs).forEach(function(sym) {
    var d   = _prices[sym];
    var cfg = pairs[sym];
    if (!d) return;
    var prEl = document.getElementById('tick-price-' + sym);
    var cgEl = document.getElementById('tick-chg-'   + sym);
    if (!prEl || !cgEl) return;
    var isUp  = d.change >= 0;
    var clr   = isUp ? 'var(--green)' : 'var(--red)';
    var arrow = isUp ? '‚ñ≤' : '‚ñº';
    // Flash color on change
    if (d.prev !== null && d.prev !== d.price) {
      prEl.style.transition = 'color 0s';
      prEl.style.color = clr;
      setTimeout(function(){ prEl.style.color = 'var(--text)'; prEl.style.transition = 'color 1.5s'; }, 800);
    }
    prEl.textContent = d.price.toFixed(cfg.dec);
    cgEl.textContent = arrow + ' ' + Math.abs(d.change).toFixed(cfg.dec) + ' (' + Math.abs(d.changePct).toFixed(2) + '%)';
    cgEl.style.color = clr;
  });
}

function startPriceMonitor() {
  fetchPrices();
  if (_priceInterval) clearInterval(_priceInterval);

  var hasTD    = TWELVE_DATA_KEY && TWELVE_DATA_KEY !== 'PASTE_TWELVE_DATA_KEY_HERE';
  // 800 req/day √∑ 16hr trading day = 50 req/hr = 1 req per 72s
  // Use 120s to stay well within limit and leave room for FRED calls
  var interval = hasTD ? 120000 : 300000;
  _priceInterval = setInterval(fetchPrices, interval);

  console.log('[Prices] Monitor started ¬∑ Source:', hasTD ? 'Twelve Data (2min)' : 'exchangerate-api (5min)');
}




function getWeekKey(offset = 0) {
  const now = new Date();
  const day = now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1) + offset * 7);
  return `pb_${monday.getFullYear()}_${monday.getMonth()}_${monday.getDate()}`;
}

function getWeekLabel(offset = 0) {
  const now = new Date();
  const day = now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1) + offset * 7);
  const friday = new Date(monday);
  friday.setDate(monday.getDate() + 4);
  const fmt = (d) => d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
  if (offset === 0) return `This Week ¬∑ ${fmt(monday)} ‚Äì ${fmt(friday)}`;
  if (offset === -1) return `Last Week ¬∑ ${fmt(monday)} ‚Äì ${fmt(friday)}`;
  if (offset === 1) return `Next Week ¬∑ ${fmt(monday)} ‚Äì ${fmt(friday)}`;
  return `${fmt(monday)} ‚Äì ${fmt(friday)}`;
}

function pbNav(dir) {
  pbWeekOffset += dir;
  loadPlaybook();
}

// ============================================================
// Boot
// ============================================================
// ‚îÄ‚îÄ MACRO DATA LOADER ‚Äî ForexFactory + current 2025 values ‚îÄ‚îÄ
// ============================================================
// MACRO DATA ENGINE ‚Äî FRED API + World Bank + ForexFactory
// ============================================================

// FRED Series IDs for key indicators
var FRED_SERIES = {
  FED_RATE:  'FEDFUNDS',        // Effective Federal Funds Rate
  CPI:       'CPIAUCSL',        // CPI All Urban Consumers
  CPI_YOY:   'CPIAUCSL',        // same, we compute YoY
  NFP:       'PAYEMS',          // Nonfarm Payrolls
  UNEMP:     'UNRATE',          // Unemployment Rate
  GDP:       'A191RL1Q225SBEA', // Real GDP Growth Rate QoQ
  CORE_CPI:  'CPILFESL',        // Core CPI (ex food/energy)
  PCE:       'PCEPI',           // PCE Price Index (Fed's preferred)
  RETAIL:    'RSXFS',           // Retail Sales
  ISM_MFG:   'NAPM',            // ISM Manufacturing PMI
};

var _macroData  = {};
var _macroReady = false;

async function loadMacroData() {
  // 1. Load from cache first (instant display)
  try {
    var cached = JSON.parse(localStorage.getItem('macro_v2') || '{}');
    if (cached.ts && Date.now() - cached.ts < 3600000) { // 1hr cache
      _macroData = cached;
      _macroReady = true;
      renderMacro();
      console.log('[Macro] Loaded from cache (' + Math.round((Date.now()-cached.ts)/60000) + 'min old)');
    }
  } catch(e) {}

  // 2. Fetch fresh data
  await Promise.allSettled([
    fetchFREDData(),
    fetchWorldBankRates(),
    fetchFFNews(),
  ]).then(function(results) {
    results.forEach(function(r, i) {
      if (r.status === 'rejected') console.warn('[Macro] Source ' + i + ' failed:', r.reason?.message);
    });
    _macroReady = true;
    _macroData.ts = Date.now();
    try { localStorage.setItem('macro_v2', JSON.stringify(_macroData)); } catch(e) {}
    renderMacro();
    console.log('[Macro] All sources loaded. Data:', Object.keys(_macroData).join(', '));
  });
}

async function fetchFREDData() {
  if (!FRED_API_KEY) {
    console.log('[Macro] No FRED key ‚Äî using World Bank + cached data only');
    return;
  }
  var series = ['FEDFUNDS','CPIAUCSL','PAYEMS','UNRATE','A191RL1Q225SBEA','CPILFESL'];
  var fetches = series.map(function(id) {
    var url = WORKER_URL + '?action=fred&series=' + id + '&fredkey=' + encodeURIComponent(FRED_API_KEY);
    return fetch(url, { signal: AbortSignal.timeout(10000) })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var obs = data.observations || [];
        if (!obs.length) return;
        // Get latest non-null value
        var latest = null;
        for (var i = obs.length - 1; i >= 0; i--) {
          if (obs[i].value !== '.' && obs[i].value !== '') {
            latest = obs[i];
            break;
          }
        }
        if (!latest) return;
        var prev = obs.length > 1 ? obs[obs.length - 2] : null;
        _macroData[id] = {
          value:    parseFloat(latest.value),
          date:     latest.date,
          prev:     prev ? parseFloat(prev.value) : null,
          change:   prev ? parseFloat(latest.value) - parseFloat(prev.value) : 0,
          raw:      obs.slice(-13), // last 13 months for chart
        };
      })
      .catch(function(e) { console.warn('[FRED]', id, e.message); });
  });
  await Promise.allSettled(fetches);
}

async function fetchWorldBankRates() {
  // ECB rate and UK rate from World Bank (no key needed)
  var endpoints = [
    { key:'ECB_RATE', url:'https://api.worldbank.org/v2/country/XC/indicator/FR.INR.RINR?format=json&mrv=1' },
    { key:'UK_RATE',  url:'https://api.worldbank.org/v2/country/GB/indicator/FR.INR.RINR?format=json&mrv=1' },
  ];
  for (var i = 0; i < endpoints.length; i++) {
    try {
      var proxied = WORKER_URL + '?action=proxy&url=' + encodeURIComponent(endpoints[i].url);
      var res = await fetch(proxied, { signal: AbortSignal.timeout(8000) });
      var data = await res.json();
      var d = data[1] && data[1][0];
      if (d && d.value) _macroData[endpoints[i].key] = { value: parseFloat(d.value.toFixed(2)), date: d.date };
    } catch(e) { console.warn('[WorldBank]', endpoints[i].key, e.message); }
  }
  // Use hard fallback values if World Bank fails (well-known current rates)
  if (!_macroData.ECB_RATE) _macroData.ECB_RATE = { value: 3.15, date: 'Jan 2025' };
  if (!_macroData.UK_RATE)  _macroData.UK_RATE  = { value: 4.75, date: 'Feb 2025' };
}

async function fetchFFNews() {
  try {
    var res = await fetch(WORKER_URL + '?action=news', { signal: AbortSignal.timeout(10000) });
    if (!res.ok) throw new Error('Worker news ' + res.status);
    var events = await res.json();
    if (!Array.isArray(events)) throw new Error('Bad format');
    _macroData.ff_events = events;
    _macroData.ff_ts     = Date.now();
    console.log('[Macro] FF events:', events.length);

    // Extract latest actual values from FF data
    events.filter(function(e){ return e.actual; }).forEach(function(e) {
      var t = (e.title || '').toLowerCase();
      if (/non-farm payrolls/i.test(t) && e.country === 'USD') {
        _macroData.FF_NFP = { value: e.actual, date: e.date, forecast: e.forecast, prev: e.previous };
      }
      if (/consumer price index.*year|cpi.*y\/y/i.test(t) && e.country === 'USD') {
        _macroData.FF_CPI = { value: e.actual, date: e.date, forecast: e.forecast, prev: e.previous };
      }
      if (/interest rate decision/i.test(t) && e.country === 'USD') {
        _macroData.FF_FED = { value: e.actual, date: e.date };
      }
      if (/interest rate decision/i.test(t) && e.country === 'EUR') {
        _macroData.FF_ECB = { value: e.actual, date: e.date };
      }
      if (/interest rate decision/i.test(t) && e.country === 'GBP') {
        _macroData.FF_BOE = { value: e.actual, date: e.date };
      }
    });
  } catch(e) { console.warn('[Macro] FF news failed:', e.message); }
}

function getFREDVal(id, decimals, suffix) {
  var d = _macroData[id];
  if (!d) return null;
  return { val: d.value.toFixed(decimals || 2) + (suffix||''), date: d.date, change: d.change, raw: d.raw };
}

function renderMacro() {
  var D = _macroData;
  function el(id) { return document.getElementById(id); }
  function setV(id, val, color) { var e = el(id); if(e){ e.textContent = val; if(color) e.style.color = color; } }
  function setSub(id, val) { var e = el(id); if(e) e.textContent = val; }
  function fmtDate(d) {
    if (!d) return '';
    try { return new Date(d).toLocaleDateString('en-US',{month:'short',year:'numeric'}); }
    catch(e) { return d; }
  }

  // ‚îÄ‚îÄ Fed Rate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var fed = D.FEDFUNDS || D.FF_FED;
  if (fed) {
    var fedVal = typeof fed.value === 'number' ? fed.value.toFixed(2) + '%' : fed.value;
    setV('live-fed-rate', fedVal, 'var(--amber)');
    setSub('live-fed-rate-sub', 'FOMC ¬∑ ' + fmtDate(fed.date));
  }

  // ‚îÄ‚îÄ CPI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var cpi = D.FF_CPI || D.CPIAUCSL;
  if (cpi) {
    var cpiVal = cpi.value;
    // FF gives string like "2.9%", FRED gives raw number
    if (typeof cpiVal === 'number') cpiVal = cpiVal.toFixed(1) + '%';
    var cpiNum = parseFloat(cpiVal);
    setV('live-cpi', cpiVal, cpiNum > 3 ? 'var(--red)' : cpiNum > 2 ? 'var(--amber)' : 'var(--green)');
    setSub('live-cpi-sub', fmtDate(cpi.date) + ' ¬∑ Target: 2.0%');
  }

  // ‚îÄ‚îÄ NFP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var nfp = D.FF_NFP || D.PAYEMS;
  if (nfp) {
    var nfpVal = nfp.value;
    if (typeof nfpVal === 'number') {
      // FRED gives total employed in thousands ‚Äî compute MoM change
      nfpVal = (nfp.change >= 0 ? '+' : '') + Math.round(nfp.change) + 'K';
    }
    var nfpNum = parseFloat(nfpVal.replace(/[^0-9.-]/g,''));
    setV('live-nfp', nfpVal, nfpNum > 150 ? 'var(--green)' : nfpNum < 50 ? 'var(--red)' : 'var(--amber)');
    setSub('live-nfp-sub', fmtDate(nfp.date) + (nfp.forecast ? ' ¬∑ F: ' + nfp.forecast : ''));
  }

  // ‚îÄ‚îÄ Unemployment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var un = D.UNRATE;
  if (un) {
    setV('live-unemp', un.value.toFixed(1) + '%', un.value < 4 ? 'var(--green)' : un.value > 5 ? 'var(--red)' : 'var(--amber)');
    setSub('live-unemp-sub', fmtDate(un.date));
  }

  // ‚îÄ‚îÄ GDP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var gdp = D.A191RL1Q225SBEA;
  if (gdp) {
    var gdpVal = (gdp.value >= 0 ? '+' : '') + gdp.value.toFixed(1) + '%';
    setV('live-gdp', gdpVal, gdp.value > 2 ? 'var(--green)' : gdp.value < 0 ? 'var(--red)' : 'var(--amber)');
    setSub('live-gdp-sub', fmtDate(gdp.date) + ' QoQ');
  }

  // ‚îÄ‚îÄ ECB Rate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var ecb = D.FF_ECB || D.ECB_RATE;
  if (ecb) {
    var ecbVal = typeof ecb.value === 'number' ? ecb.value.toFixed(2) + '%' : ecb.value;
    setV('live-ecb-rate', ecbVal, 'var(--blue)');
  }

  // ‚îÄ‚îÄ BoE Rate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var boe = D.FF_BOE || D.UK_RATE;
  if (boe) {
    var boeVal = typeof boe.value === 'number' ? boe.value.toFixed(2) + '%' : boe.value;
    setV('live-boe-rate', boeVal, 'var(--purple)');
  }

  // ‚îÄ‚îÄ Core CPI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var core = D.CPILFESL;
  if (core) {
    setV('live-core-cpi', core.value.toFixed(1) + '%', core.value > 3 ? 'var(--red)' : 'var(--amber)');
  }

  // ‚îÄ‚îÄ Last update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var luEl = el('macro-last-update');
  if (luEl) {
    var src = FRED_API_KEY ? 'FRED + ForexFactory' : 'ForexFactory';
    luEl.textContent = 'Live ¬∑ ' + src + ' ¬∑ ' + new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  }

  // ‚îÄ‚îÄ Upcoming events banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderMacroEventsBanner();

  // ‚îÄ‚îÄ Draw mini sparkline charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderMacroCharts();
}

function renderMacroEventsBanner() {
  var bannerEl = document.getElementById('macro-events-banner');
  if (!bannerEl || !_macroData.ff_events) return;
  var upcoming = _macroData.ff_events.filter(function(e) {
    return e.impact === 'High' && new Date(e.date) > new Date();
  }).slice(0, 6);
  if (!upcoming.length) { bannerEl.style.display = 'none'; return; }
  bannerEl.style.display = 'block';
  var inner = document.getElementById('macro-events-banner-inner');
  if (!inner) return;
  inner.innerHTML = upcoming.map(function(e) {
    var d  = new Date(e.date);
    var dy = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    var tm = isNaN(d) ? '' : d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    return '<div class="meb-item">'
      + '<span style="color:var(--red);font-weight:700;min-width:28px">' + (e.country||'') + '</span>'
      + '<span style="color:var(--text);flex:1">' + (e.title||'').slice(0,45) + '</span>'
      + '<span style="color:var(--muted2);font-size:.54rem">' + dy + ' ' + tm + '</span>'
      + (e.forecast ? '<span style="color:var(--green);font-size:.54rem">F:' + e.forecast + '</span>' : '')
      + (e.previous ? '<span style="color:var(--muted2);font-size:.54rem">P:' + e.previous + '</span>' : '')
      + '</div>';
  }).join('');
}

function renderMacroCharts() {
  // Mini sparkline for CPI trend (last 12 months from FRED)
  var cpiData = _macroData.CPIAUCSL;
  if (cpiData && cpiData.raw && cpiData.raw.length > 1) {
    // Compute YoY for each month
    var raw = cpiData.raw;
    var yoyData = [];
    for (var i = 12; i < raw.length; i++) {
      if (raw[i].value !== '.' && raw[i-12] && raw[i-12].value !== '.') {
        var yoy = ((parseFloat(raw[i].value) - parseFloat(raw[i-12].value)) / parseFloat(raw[i-12].value) * 100);
        yoyData.push({ v: parseFloat(yoy.toFixed(2)), d: raw[i].date });
      }
    }
    drawSparkline('macro-cpi-chart', yoyData.slice(-12), 'var(--amber)', 2.0);
  }

  // Mini sparkline for NFP (MoM change)
  var nfpData = _macroData.PAYEMS;
  if (nfpData && nfpData.raw && nfpData.raw.length > 1) {
    var raw2 = nfpData.raw;
    var moms = [];
    for (var j = 1; j < raw2.length; j++) {
      if (raw2[j].value !== '.' && raw2[j-1].value !== '.') {
        var mom = parseFloat(raw2[j].value) - parseFloat(raw2[j-1].value);
        moms.push({ v: parseFloat(mom.toFixed(0)), d: raw2[j].date });
      }
    }
    drawSparkline('macro-nfp-chart', moms.slice(-12), 'var(--green)', 150);
  }
}

function drawSparkline(canvasId, data, color, targetLine) {
  var canvas = document.getElementById(canvasId);
  if (!canvas || !data || !data.length) return;
  var ctx = canvas.getContext('2d');
  var W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);
  var vals = data.map(function(d){ return d.v; });
  var mn   = Math.min.apply(null, vals);
  var mx   = Math.max.apply(null, vals);
  var rng  = mx - mn || 1;
  var pad  = 8;
  var cW   = W - pad*2;
  var cH   = H - pad*2;
  var bW   = cW / vals.length - 1;

  // Target line
  if (targetLine !== undefined) {
    var ty = pad + cH - ((targetLine - mn) / rng * cH);
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(pad, ty); ctx.lineTo(W-pad, ty); ctx.stroke();
    ctx.setLineDash([]);
  }

  // Bars
  vals.forEach(function(v, i) {
    var x = pad + i * (cW / vals.length);
    var bH = Math.max((v - mn) / rng * cH, 2);
    var y  = pad + cH - bH;
    var clr = v >= 0 ? color : 'var(--red)';
    ctx.fillStyle = clr;
    ctx.globalAlpha = 0.8;
    ctx.fillRect(x, y, Math.max(bW, 2), bH);
  });
  ctx.globalAlpha = 1;
}



function setMacroTab(name) {
  ['overview','usd','eur','gbp','gold'].forEach(t => {
    var panel = document.getElementById('macro-' + t);
    var btn   = document.getElementById('mt-' + t);
    if (panel) panel.style.display = t === name ? 'block' : 'none';
    if (btn)   btn.classList.toggle('active', t === name);
  });
}


function updateMacroPrices() {
  function setEl(id, val, clr) { var e = document.getElementById(id); if(e){ e.textContent = val; if(clr) e.style.color = clr; } }
  if (_prices.DXY) {
    var dxy   = _prices.DXY;
    var isUp  = (dxy.change || 0) >= 0;
    var clrDXY = isUp ? 'var(--red)' : 'var(--green)'; // DXY up = bad for pairs
    setEl('mk-dxy-val', dxy.price.toFixed(3), clrDXY);
    setEl('mk-dxy-sub', isUp ? '‚¨Ü USD Strengthening' : '‚¨á USD Weakening');
    setEl('usd-dxy-live', dxy.price.toFixed(3), clrDXY);
  }
  if (_prices.EURUSD) {
    setEl('eurusd-live-price', _prices.EURUSD.price.toFixed(5), _prices.EURUSD.change >= 0 ? 'var(--green)' : 'var(--red)');
  }
  if (_prices.GBPUSD) {
    setEl('gbp-live-price', _prices.GBPUSD.price.toFixed(5), _prices.GBPUSD.change >= 0 ? 'var(--green)' : 'var(--red)');
  }
  if (_prices.XAUUSD) {
    setEl('gold-live-price', '$' + _prices.XAUUSD.price.toFixed(2), 'var(--amber)');
  }
}

// updateMacroPrices is called directly from within updateTickerUI below

window.addEventListener('load', async () => {
  await loadPlaybook();
  loadNews();
  loadMacroData();
  startPriceMonitor();
  await requestNotifications();
  if (!NOTION_TOKEN) showTokenScreen();
  else loadData();
});
</script>
</body>
</html>
