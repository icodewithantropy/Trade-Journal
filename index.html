<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS · Analytics</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob: https://*.amazonaws.com https://*.notion.so; connect-src 'self' https://notion-proxy.churan756.workers.dev https://api.anthropic.com; frame-ancestors 'none';">
<link rel="stylesheet" href="core/style.css">
<style>
.eq-ranges{display:flex;gap:4px;align-items:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:8px}
.cal-head{font-size:.42rem;color:var(--muted);text-align:center;padding:3px 0;letter-spacing:1px}
.cal-day{aspect-ratio:1;border-radius:4px;border:1px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:default;transition:border-color .1s;font-size:.38rem}
.cal-day.has-trades{cursor:pointer}.cal-day.has-trades:hover{border-color:var(--b3)}
.cal-day.win{background:rgba(0,212,122,.09);border-color:rgba(0,212,122,.25)}
.cal-day.loss{background:rgba(255,45,85,.08);border-color:rgba(255,45,85,.2)}
.cal-day.be{background:rgba(245,166,35,.07);border-color:rgba(245,166,35,.18)}
.cal-day.empty{border-color:transparent}
.cal-dn{font-size:.42rem;color:var(--m2)}
.cal-r{font-size:.44rem;font-weight:700}
.cal-nav{display:flex;align-items:center;gap:8px}
.cal-nav-btn{background:var(--s2);border:1px solid var(--b2);border-radius:3px;color:var(--m2);font-size:.58rem;padding:3px 10px;cursor:pointer;transition:all .1s;font-family:var(--ff)}
.cal-nav-btn:hover{border-color:var(--b3);color:var(--text)}
.cal-month-lbl{font-size:.56rem;font-weight:700;font-family:var(--fd)}
.dist-bar{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:.48rem}
.dist-label{width:30px;text-align:right;color:var(--m2);flex-shrink:0}
.dist-track{flex:1;height:6px;background:var(--s2);border-radius:3px;overflow:hidden}
.dist-fill{height:100%;border-radius:3px;background:var(--purple);transition:width .3s}
.dist-count{width:24px;color:var(--muted);flex-shrink:0}
.sessions-bar{display:flex;flex-direction:column;gap:5px}
.sess-row{display:flex;align-items:center;gap:8px;font-size:.5rem}
.sess-name{width:100px;color:var(--m2);flex-shrink:0;font-size:.46rem}
.sess-track{flex:1;height:7px;background:var(--s2);border-radius:3px;overflow:hidden}
.sess-fill{height:100%;border-radius:3px;transition:width .4s}
.sess-stat{width:60px;text-align:right;color:var(--muted);font-size:.44rem;flex-shrink:0}
.tf-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.tf-card{background:var(--s2);border:1px solid var(--b2);border-radius:6px;padding:8px;text-align:center}
.tf-name{font-size:.42rem;color:var(--muted);margin-bottom:4px;letter-spacing:1px}
.tf-wr{font-family:var(--fd);font-size:.85rem;font-weight:800}
.tf-n{font-size:.42rem;color:var(--muted);margin-top:2px}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.grade-c{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:12px;text-align:center}
.grade-lbl{font-family:var(--fd);font-size:1.4rem;font-weight:800;margin-bottom:4px}
.grade-stat{font-size:.48rem;color:var(--m2);margin-bottom:2px}
.grade-wr{font-size:.65rem;font-weight:700}
.loader-ov{display:none;position:fixed;inset:0;background:var(--bg);z-index:8000;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.loader-ov.show{display:flex}
.loader-logo{font-family:var(--fd);font-size:1.4rem;font-weight:800;letter-spacing:4px}.loader-logo span{color:var(--green)}
.loader-bar-wrap{width:240px;height:3px;background:var(--s2);border-radius:2px;overflow:hidden}
.loader-bar{height:100%;background:var(--green);border-radius:2px;width:0;transition:width .3s ease}
.loader-msg{font-size:.54rem;color:var(--m2)}
.trade-pair{font-weight:600;color:var(--text)}
.outcome-win{color:var(--green)}.outcome-loss{color:var(--red)}.outcome-be{color:var(--amber)}
.grade-aplus{color:var(--green)}.grade-b{color:var(--blue)}.grade-c-tag{color:var(--amber)}
.trade-img{width:28px;height:20px;border-radius:2px;object-fit:cover;cursor:pointer;opacity:.7;transition:opacity .1s;border:1px solid var(--b2)}
.trade-img:hover{opacity:1}
</style>
</head>
<body>

<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR —</div>
    <div class="nav-px" id="np-xau">XAU —</div>
    <div class="nav-px" id="np-dxy">DXY —</div>
    <div class="nav-dot" id="nav-dot"></div>
  </div>
</nav>

<div id="alert-bar"></div>

<!-- Token screen -->
<div id="token-screen">
  <div class="ts-logo">TRADE<span>OS</span></div>
  <div class="ts-box">
    <h2>Connect Notion</h2>
    <p>Enter your Notion integration token to load your trading journal.<br>Get one at <strong>notion.so/my-integrations</strong></p>
    <input class="ts-inp" id="ts-inp" type="password" placeholder="ntn_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" spellcheck="false" onkeydown="if(event.key==='Enter')doSaveToken()">
    <label class="ts-remember"><input type="checkbox" id="ts-remember"> Remember on this device</label>
    <button class="ts-btn" onclick="doSaveToken()">CONNECT →</button>
    <div class="ts-note">Token validated · Clears on tab close unless remembered · Never sent to third parties</div>
  </div>
</div>

<!-- Loader -->
<div class="loader-ov" id="loader">
  <div class="loader-logo">TRADE<span>OS</span></div>
  <div class="loader-bar-wrap"><div class="loader-bar" id="loader-bar"></div></div>
  <div class="loader-msg" id="loader-msg">Loading journal…</div>
</div>

<!-- Trade modal -->
<div class="modal-ov" id="trade-modal">
  <div class="modal-box">
    <div class="modal-hdr">
      <div class="modal-title" id="modal-title">Trade</div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div id="modal-body"></div>
  </div>
</div>

<!-- Calendar popup -->
<div class="modal-ov" id="cal-modal">
  <div class="modal-box" style="max-width:380px">
    <div class="modal-hdr">
      <div class="modal-title" id="cal-modal-title">Trades</div>
      <button class="modal-close" onclick="document.getElementById('cal-modal').classList.remove('open')">✕</button>
    </div>
    <div id="cal-modal-body"></div>
  </div>
</div>

<div class="wrap">

  <!-- KPI Row -->
  <div class="row5" id="kpi-row" style="margin-bottom:18px">
    <div class="kpi g"><div class="kpi-l">Total R</div><div class="kpi-v" id="k-totalr" style="color:var(--green)">—</div><div class="kpi-s" id="k-totalr-s"></div></div>
    <div class="kpi"><div class="kpi-l">Win Rate</div><div class="kpi-v" id="k-wr">—</div><div class="kpi-s" id="k-wr-s"></div></div>
    <div class="kpi"><div class="kpi-l">Avg Win R</div><div class="kpi-v" id="k-avgwin" style="color:var(--green)">—</div><div class="kpi-s" id="k-avgwin-s"></div></div>
    <div class="kpi"><div class="kpi-l">EV/Trade</div><div class="kpi-v" id="k-ev">—</div><div class="kpi-s" id="k-ev-s"></div></div>
    <div class="kpi"><div class="kpi-l">A+ Trades</div><div class="kpi-v" id="k-aplus">—</div><div class="kpi-s" id="k-aplus-s"></div></div>
  </div>

  <!-- Equity + Monthly R -->
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-bottom:10px">
    <div class="card g">
      <div class="chart-lbl">
        Equity Curve
        <div class="eq-ranges">
          <button class="rb on" onclick="setRange('all',this)">ALL</button>
          <button class="rb" onclick="setRange('3m',this)">3M</button>
          <button class="rb" onclick="setRange('1m',this)">1M</button>
        </div>
      </div>
      <svg id="equity-svg" viewBox="0 0 800 200" height="160"></svg>
    </div>
    <div class="card a">
      <div class="chart-lbl">Monthly R</div>
      <svg id="monthly-svg" viewBox="0 0 380 120" height="96"></svg>
    </div>
  </div>

  <!-- W/L + Sessions + Grade -->
  <div class="row3" style="margin-bottom:10px">
    <div class="card">
      <div class="chart-lbl">Win / Loss / BE</div>
      <svg id="donut-svg" viewBox="0 0 260 120" height="90"></svg>
    </div>
    <div class="card">
      <div class="chart-lbl">Sessions</div>
      <div class="sessions-bar" id="sessions-bar"></div>
    </div>
    <div class="card">
      <div class="chart-lbl">Setup Grade</div>
      <div class="grade-grid" id="grade-grid"></div>
    </div>
  </div>

  <!-- Calendar + Entry TF + R Dist -->
  <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;margin-bottom:10px">
    <div class="card">
      <div class="chart-lbl">
        <div class="cal-nav">
          <button class="cal-nav-btn" onclick="calNav(-1)">‹</button>
          <span class="cal-month-lbl" id="cal-month-lbl">—</span>
          <button class="cal-nav-btn" onclick="calNav(1)">›</button>
        </div>
        <span id="cal-stats" style="font-size:.44rem"></span>
      </div>
      <div class="cal-grid" id="cal-head-row">
        <div class="cal-head">MO</div><div class="cal-head">TU</div><div class="cal-head">WE</div>
        <div class="cal-head">TH</div><div class="cal-head">FR</div><div class="cal-head">SA</div><div class="cal-head">SU</div>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
    </div>
    <div class="card">
      <div class="chart-lbl">Entry Timeframe</div>
      <div class="tf-grid" id="tf-grid"></div>
    </div>
    <div class="card p">
      <div class="chart-lbl">R Distribution</div>
      <div id="rdist" style="margin-top:4px"></div>
    </div>
  </div>

  <!-- Trades Table -->
  <div class="shdr"><div class="shdr-title" style="font-size:.72rem">Trade Journal</div><div class="shdr-line"></div><div class="shdr-sub" id="trades-count"></div></div>
  <div class="card" style="padding:0;margin-bottom:8px">
    <div style="display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--border);flex-wrap:wrap">
      <input class="inp" id="search" placeholder="Search pair, comment…" style="width:200px;padding:6px 10px;font-size:.54rem" oninput="applyFilters()">
      <div class="filter-bar" style="margin-bottom:0">
        <button class="filter-btn on" onclick="setOutcomeFilter('all',this)">All</button>
        <button class="filter-btn" onclick="setOutcomeFilter('Win',this)">Win</button>
        <button class="filter-btn" onclick="setOutcomeFilter('Lose',this)">Loss</button>
        <button class="filter-btn" onclick="setOutcomeFilter('Breakeven',this)">BE</button>
      </div>
      <div class="filter-bar" style="margin-bottom:0">
        <button class="filter-btn on" onclick="setGradeFilter('all',this)">All</button>
        <button class="filter-btn" onclick="setGradeFilter('A+',this)">A+</button>
        <button class="filter-btn" onclick="setGradeFilter('B',this)">B</button>
        <button class="filter-btn" onclick="setGradeFilter('C',this)">C</button>
      </div>
      <button class="btn btn-ghost" style="font-size:.46rem;padding:5px 10px" onclick="TokenStore.clear();location.reload()">⏏ Disconnect</button>
    </div>
    <div style="overflow:auto">
      <table class="tbl">
        <thead><tr>
          <th>Date</th><th>Pair</th><th>Dir</th><th>Outcome</th>
          <th>R</th><th>Grade</th><th>Session</th><th>Confluences</th><th>Chart</th>
        </tr></thead>
        <tbody id="trades-tbody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

</div>

<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-dxy"><span class="ps-sym">DXY</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-xau"><span class="ps-sym">XAU/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">○ Loading</span>
  </div>
</div>

<script src="core/security.js"></script>
<script src="core/state.js"></script>
<script src="core/config.js"></script>
<script src="core/api.js"></script>
<script src="core/engines.js"></script>
<script>
'use strict';
const PAGE_ID = 'analytics';

// ── State ─────────────────────────────────────────────────
let _eq = 'all', _outcomeFilter = 'all', _gradeFilter = 'all', _page = 1, _calOffset = 0;
const PER_PAGE = 20;

// ── Token ─────────────────────────────────────────────────
function doSaveToken() {
  const val = document.getElementById('ts-inp').value.trim();
  const persist = document.getElementById('ts-remember').checked;
  if (!TokenStore.ok(val)) {
    const el = document.getElementById('ts-inp');
    el.style.borderColor = 'var(--red)';
    setTimeout(() => el.style.borderColor='', 1400);
    return;
  }
  TokenStore.set(val, persist);
  document.getElementById('token-screen').classList.remove('show');
  document.getElementById('ts-inp').value = '';
  loadJournal();
}

// ── Loader ────────────────────────────────────────────────
function ldSet(pct, msg) {
  document.getElementById('loader-bar').style.width = pct + '%';
  document.getElementById('loader-msg').textContent = msg;
}

// ── Load journal ──────────────────────────────────────────
async function loadJournal() {
  document.getElementById('loader').classList.add('show');
  ldSet(10, 'Connecting to Notion…');
  try {
    ldSet(30, 'Fetching trades…');
    await TradeEngine.load(n => ldSet(30 + Math.min(n/2, 50), `Loading… ${n} trades`));
    ldSet(90, 'Analyzing…');
    render();
    ldSet(100, 'Done');
    setTimeout(() => document.getElementById('loader').classList.remove('show'), 400);
  } catch(e) {
    document.getElementById('loader').classList.remove('show');
    if (e.message === 'NO_TOKEN') { document.getElementById('token-screen').classList.add('show'); return; }
    document.getElementById('trades-tbody').innerHTML =
      `<tr><td colspan="9" style="text-align:center;padding:20px;color:var(--red)">${esc(e.message)}</td></tr>`;
  }
}

// ── Render all ────────────────────────────────────────────
function render() {
  const stats = State.get('journalStats');
  if (!stats || !stats.valid) return;
  renderKPIs(stats);
  Charts.equity('equity-svg', stats, _eq);
  const months = stats.sortedMonths.slice(-12);
  Charts.barChart('monthly-svg', months.map(m => ({value:m.r,label:m.label})), (d,v)=>v>=0?'var(--green)':'var(--red)');
  Charts.donut('donut-svg',[
    {label:'Win', value:stats.wins.length, color:'var(--green)'},
    {label:'Loss',value:stats.losses.length,color:'var(--red)'},
    {label:'BE',  value:stats.bes.length,  color:'var(--amber)'},
  ]);
  renderSessions(stats);
  renderGrades(stats);
  renderCalendar(stats);
  renderTFs(stats);
  renderRDist(stats);
  applyFilters();
}

function renderKPIs(s) {
  const set = (id, v, subId, sv) => {
    const el=document.getElementById(id); if(el) el.textContent=v;
    const se=document.getElementById(subId); if(se) se.textContent=sv||'';
  };
  const rClr = s.curR >= 0 ? 'var(--green)' : 'var(--red)';
  document.getElementById('k-totalr').textContent = (s.curR>=0?'+':'')+s.curR.toFixed(2)+'R';
  document.getElementById('k-totalr').style.color = rClr;
  document.getElementById('k-totalr-s').textContent = `Peak: +${s.peakR.toFixed(1)}R · DD: ${s.drawdown}%`;
  set('k-wr', s.winRate+'%', 'k-wr-s', `${s.wins.length}W / ${s.losses.length}L / ${s.bes.length}BE`);
  set('k-avgwin', '+'+s.avgWin+'R', 'k-avgwin-s', 'Avg loss: −'+s.avgLoss+'R');
  const ev = s.ev;
  document.getElementById('k-ev').textContent = ev!=null ? (ev>=0?'+':'')+ev.toFixed(3)+'R' : '—';
  document.getElementById('k-ev').style.color = ev>0?'var(--green)':ev<0?'var(--red)':'var(--t2)';
  document.getElementById('k-ev-s').textContent = ev>0?'Positive edge':'Negative edge';
  const ap = s.grades['A+'] || {wins:0,total:0};
  set('k-aplus', ap.total, 'k-aplus-s', ap.total ? `${Math.round(ap.wins/ap.total*100)}% WR` : '');
}

function renderSessions(s) {
  const el = document.getElementById('sessions-bar'); if(!el) return;
  const colors = ['var(--green)','var(--blue)','var(--amber)','var(--cyan)','var(--purple)'];
  const entries = Object.entries(s.sessions).sort((a,b)=>b[1].total-a[1].total);
  el.innerHTML = entries.map(([name,d],i) => {
    const wr = d.total ? Math.round(d.wins/d.total*100) : 0;
    const pct = Math.min(wr, 100);
    return `<div class="sess-row">
      <span class="sess-name">${esc(name)}</span>
      <div class="sess-track"><div class="sess-fill" style="width:${pct}%;background:${colors[i%colors.length]}"></div></div>
      <span class="sess-stat">${wr}% · ${d.total}T</span>
    </div>`;
  }).join('');
}

function renderGrades(s) {
  const el = document.getElementById('grade-grid'); if(!el) return;
  const items = [
    {g:'A+',color:'var(--green)'},{g:'B',color:'var(--blue)'},{g:'C',color:'var(--amber)'}
  ];
  el.innerHTML = items.map(({g,color}) => {
    const d = s.grades[g] || {wins:0,total:0};
    const wr = d.total ? Math.round(d.wins/d.total*100) : 0;
    return `<div class="grade-c">
      <div class="grade-lbl" style="color:${color}">${esc(g)}</div>
      <div class="grade-wr" style="color:${color}">${wr}%</div>
      <div class="grade-stat">${d.total} trades</div>
    </div>`;
  }).join('');
}

function renderTFs(s) {
  const el = document.getElementById('tf-grid'); if(!el) return;
  const entries = Object.entries(s.tfs).sort((a,b)=>b[1].total-a[1].total).slice(0,8);
  el.innerHTML = entries.map(([tf,d]) => {
    const wr = d.total ? Math.round(d.wins/d.total*100) : 0;
    return `<div class="tf-card">
      <div class="tf-name">${esc(tf)}</div>
      <div class="tf-wr" style="color:${wr>=55?'var(--green)':wr>=45?'var(--amber)':'var(--red)'}">${wr}%</div>
      <div class="tf-n">${d.total}T</div>
    </div>`;
  }).join('');
}

function renderRDist(s) {
  const el = document.getElementById('rdist'); if(!el) return;
  const buckets = {};
  s.valid.forEach(t => {
    if(t.rMultiple==null) return;
    const b = Math.round(t.rMultiple*2)/2;
    buckets[b] = (buckets[b]||0)+1;
  });
  const sorted = Object.entries(buckets).sort((a,b)=>+a[0]-+b[0]);
  const max = Math.max(...Object.values(buckets),1);
  el.innerHTML = sorted.map(([r,n]) => {
    const pct = Math.round(n/max*100);
    const pos = +r >= 0;
    return `<div class="dist-bar">
      <span class="dist-label" style="color:${pos?'var(--green)':'var(--red)'}">${esc(r)}R</span>
      <div class="dist-track"><div class="dist-fill" style="width:${pct}%;background:${pos?'var(--green)':'var(--red)'}"></div></div>
      <span class="dist-count">${n}</span>
    </div>`;
  }).join('');
}

// ── Calendar ──────────────────────────────────────────────
function renderCalendar(stats) {
  const s = stats || State.get('journalStats'); if(!s) return;
  const now = new Date();
  const d   = new Date(now.getFullYear(), now.getMonth() + _calOffset, 1);
  document.getElementById('cal-month-lbl').textContent = d.toLocaleString('en-US',{month:'long',year:'numeric'});

  const year = d.getFullYear(), mon = d.getMonth();
  const days = new Date(year,mon+1,0).getDate();
  const startDow = (new Date(year,mon,1).getDay()+6)%7;

  const grid = document.getElementById('cal-grid'); if(!grid) return;
  let html = '<div class="cal-day empty"></div>'.repeat(startDow);

  let wCount=0,wWins=0;
  for(let day=1;day<=days;day++){
    const key = `${year}-${String(mon+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const trades = s.byDay[key] || [];
    const wins   = trades.filter(t=>t.outcome==='Win').length;
    const losses = trades.filter(t=>t.outcome==='Lose').length;
    const r      = trades.reduce((sum,t)=>sum+(t.rMultiple||0),0);
    wCount+=trades.length; wWins+=wins;
    let cls = '';
    if(trades.length) cls = wins>losses?'win':losses>wins?'loss':'be';
    const onclick = trades.length ? `onclick="openCalPopup('${esc(key)}')"` : '';
    html += `<div class="cal-day ${cls} ${trades.length?'has-trades':''}" ${onclick}>
      <span class="cal-dn">${day}</span>
      ${trades.length ? `<span class="cal-r" style="color:${r>=0?'var(--green)':'var(--red)'}">${r>=0?'+':''}${r.toFixed(1)}</span>` : ''}
    </div>`;
  }
  grid.innerHTML = html;
  document.getElementById('cal-stats').textContent = wCount ? `${wCount} trades · ${Math.round(wWins/wCount*100)}% WR` : '';
}

function calNav(dir) { _calOffset += dir; renderCalendar(); }

function openCalPopup(dateKey) {
  const s = State.get('journalStats'); if(!s) return;
  const trades = s.byDay[dateKey] || [];
  const d = new Date(dateKey);
  document.getElementById('cal-modal-title').textContent = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  document.getElementById('cal-modal-body').innerHTML = trades.map(t =>
    `<div style="display:flex;align-items:center;gap:8px;padding:9px 0;border-bottom:1px solid var(--border);font-size:.56rem">
      <span class="outcome-${t.outcome?.toLowerCase()}">${esc(t.outcome)}</span>
      <span style="color:var(--text);font-weight:600">${esc(t.pair||'—')}</span>
      <span class="grade-${t.grade?.toLowerCase().replace('+','aplus')}">${esc(t.grade)}</span>
      <span style="margin-left:auto;color:${(t.rMultiple||0)>=0?'var(--green)':'var(--red)'}">
        ${t.rMultiple!=null?(t.rMultiple>=0?'+':'')+t.rMultiple.toFixed(2)+'R':'—'}
      </span>
    </div>`
  ).join('');
  document.getElementById('cal-modal').classList.add('open');
}

function closeModal()  { document.getElementById('trade-modal').classList.remove('open'); }

// ── Equity range ──────────────────────────────────────────
function setRange(r, btn) {
  _eq = r;
  document.querySelectorAll('.rb').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  Charts.equity('equity-svg', State.get('journalStats'), _eq);
}

// ── Filters + table ───────────────────────────────────────
function setOutcomeFilter(v, btn) {
  _outcomeFilter = v; _page = 1;
  document.querySelectorAll('[onclick^="setOutcomeFilter"]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  applyFilters();
}
function setGradeFilter(v, btn) {
  _gradeFilter = v; _page = 1;
  document.querySelectorAll('[onclick^="setGradeFilter"]').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  applyFilters();
}

function applyFilters() {
  const s = State.get('journalStats'); if(!s) return;
  const q = (document.getElementById('search')?.value||'').toLowerCase();
  let filtered = s.valid;
  if(_outcomeFilter !== 'all') filtered = filtered.filter(t=>t.outcome===_outcomeFilter);
  if(_gradeFilter   !== 'all') filtered = filtered.filter(t=>t.grade===_gradeFilter);
  if(q) filtered = filtered.filter(t =>
    (t.pair||'').toLowerCase().includes(q) ||
    (t.comment||'').toLowerCase().includes(q) ||
    (t.session||'').toLowerCase().includes(q)
  );
  const total = filtered.length;
  document.getElementById('trades-count').textContent = `${total} trades`;
  const pages = Math.max(1,Math.ceil(total/PER_PAGE));
  _page = Math.min(_page, pages);
  const slice = filtered.slice((_page-1)*PER_PAGE, _page*PER_PAGE).reverse();
  renderTradesTable(slice);
  renderPagination(pages);
}

function renderTradesTable(trades) {
  const tbody = document.getElementById('trades-tbody');
  if(!trades.length){ tbody.innerHTML='<tr><td colspan="9" class="empty">No trades match filters</td></tr>'; return; }
  tbody.innerHTML = trades.map(t => {
    const rClr = (t.rMultiple||0)>=0?'var(--green)':'var(--red)';
    const imgHtml = (t.images||[]).slice(0,2).map(url => {
      const safe = escUrl(url);
      return safe ? `<img class="trade-img" src="${safe}" onclick="openTradeModal('${esc(t.id)}')" loading="lazy">` : '';
    }).join('');
    const conf = (t.confluences||[]).slice(0,3).map(c=>`<span class="badge bp" style="font-size:.38rem">${esc(c)}</span>`).join(' ');
    return `<tr onclick="openTradeModal('${esc(t.id)}')" style="cursor:pointer">
      <td style="color:var(--t2);white-space:nowrap">${esc(t.date?.slice(0,10)||'—')}</td>
      <td class="trade-pair">${esc(t.pair||'—')}</td>
      <td style="color:${t.direction==='Long'?'var(--green)':'var(--red)'}">${esc(t.direction||'—')}</td>
      <td class="outcome-${(t.outcome||'').toLowerCase()}">${esc(t.outcome||'—')}</td>
      <td style="color:${rClr};font-weight:700">${t.rMultiple!=null?(t.rMultiple>=0?'+':'')+t.rMultiple.toFixed(2)+'R':'—'}</td>
      <td class="grade-${(t.grade||'').toLowerCase().replace('+','aplus')}">${esc(t.grade||'—')}</td>
      <td style="color:var(--m2);font-size:.48rem">${esc(t.session||'—')}</td>
      <td>${conf}</td>
      <td>${imgHtml}</td>
    </tr>`;
  }).join('');
}

function renderPagination(pages) {
  if(pages<=1){ document.getElementById('pagination').innerHTML=''; return; }
  const btn = (label,pg,disabled,active) =>
    `<button class="pg-btn${active?' on':''}" onclick="_page=${pg};applyFilters()" ${disabled?'disabled':''}>${esc(String(label))}</button>`;
  let html = btn('‹', _page-1, _page===1, false);
  for(let i=Math.max(1,_page-2);i<=Math.min(pages,_page+2);i++) html += btn(i,i,false,i===_page);
  html += btn('›',_page+1,_page===pages,false);
  html += `<span class="pg-info">Page ${_page}/${pages}</span>`;
  document.getElementById('pagination').innerHTML = html;
}

function openTradeModal(id) {
  const s = State.get('journalStats'); if(!s) return;
  const t = s.valid.find(x => x.id===id); if(!t) return;
  document.getElementById('modal-title').textContent = `${t.pair||'—'} · ${t.date?.slice(0,10)||'—'}`;
  const rClr = (t.rMultiple||0)>=0?'var(--green)':'var(--red)';
  const imgs = (t.images||[]).map(url => {
    const safe = escUrl(url);
    return safe ? `<img src="${safe}" style="width:100%;border-radius:6px;margin-bottom:8px" loading="lazy">` : '';
  }).join('');
  document.getElementById('modal-body').innerHTML = `
    <div class="row2" style="margin-bottom:14px">
      <div class="kpi"><div class="kpi-l">Outcome</div><div class="kpi-v class="outcome-${(t.outcome||'').toLowerCase()}">${esc(t.outcome||'—')}</div></div>
      <div class="kpi"><div class="kpi-l">R Multiple</div><div class="kpi-v" style="color:${rClr}">${t.rMultiple!=null?(t.rMultiple>=0?'+':'')+t.rMultiple.toFixed(2)+'R':'—'}</div></div>
      <div class="kpi"><div class="kpi-l">Direction</div><div class="kpi-v" style="color:${t.direction==='Long'?'var(--green)':'var(--red)'}">${esc(t.direction||'—')}</div></div>
      <div class="kpi"><div class="kpi-l">Grade</div><div class="kpi-v">${esc(t.grade||'—')}</div></div>
    </div>
    ${t.confluences?.length ? `<div style="margin-bottom:12px">${t.confluences.map(c=>`<span class="badge bp" style="margin-right:4px;margin-bottom:4px">${esc(c)}</span>`).join('')}</div>` : ''}
    ${t.comment ? `<div style="font-size:.6rem;color:var(--t2);line-height:1.8;margin-bottom:14px;padding:10px;background:var(--s2);border-radius:6px;border:1px solid var(--border)">${esc(t.comment)}</div>` : ''}
    ${imgs}`;
  document.getElementById('trade-modal').classList.add('open');
}

// ── Boot ──────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', () => {
  NavEngine.init(PAGE_ID);
  PriceEngine.start();
  PriceEngine.requestNotifications();
  State.on('trades', () => render());
  if(!TokenStore.ok(TokenStore.get())) {
    document.getElementById('token-screen').classList.add('show');
  } else {
    loadJournal();
  }
});
</script>
</body>
</html>
