<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS Â· News</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://notion-proxy.churan756.workers.dev; frame-ancestors 'none';">
<link rel="icon" href="data:,">
<link rel="stylesheet" href="core/style.css">
<style>
/* â”€â”€ Countdown â”€â”€ */
.cd-bar {
  background: var(--s2); border-bottom: 1px solid var(--b2);
  padding: 8px 20px; display: flex; align-items: center; gap: 12px; font-family: var(--ff);
}
.cd-label { font-size: .42rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
.cd-event { font-size: .48rem; color: var(--t2); }
.cd-timer { font-size: .9rem; font-weight: 700; color: var(--blue); font-variant-numeric: tabular-nums; font-family: var(--fd); margin-left: auto; }

/* â”€â”€ FRED notice â”€â”€ */
.fred-notice {
  margin: 12px 20px; background: rgba(61,142,255,.08); border: 1px solid rgba(61,142,255,.2);
  border-radius: 6px; padding: 10px 14px; font-size: .44rem; color: var(--t2); font-family: var(--ff); line-height: 1.7;
}
.fred-notice strong { color: var(--blue); }

/* â”€â”€ Tabs â”€â”€ */
.tab-bar { display: flex; gap: 4px; padding: 12px 20px 0; border-bottom: 1px solid var(--b2); }
.tab-btn {
  padding: 6px 16px; border-radius: 5px 5px 0 0; border: 1px solid transparent;
  cursor: pointer; font-size: .44rem; color: var(--muted); background: none;
  font-family: var(--ff); letter-spacing: .5px; transition: all .15s;
}
.tab-btn.active { background: var(--s2); border-color: var(--b2); border-bottom-color: var(--s2); color: var(--text); font-weight: 700; }

/* â”€â”€ Filter bar â”€â”€ */
.filter-bar { display: flex; gap: 6px; padding: 10px 20px; flex-wrap: wrap; align-items: center; border-bottom: 1px solid var(--b2); }
.filter-bar label { font-size: .4rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-family: var(--ff); }
.chip {
  padding: 3px 10px; border-radius: 3px; border: 1px solid var(--b2); background: var(--s3);
  color: var(--muted); cursor: pointer; font-size: .42rem; font-family: var(--ff); letter-spacing: .5px; transition: all .12s;
}
.chip.active { border-color: var(--blue); color: var(--blue); background: rgba(61,142,255,.08); }
.chip.high.active { border-color: var(--red); color: var(--red); background: rgba(255,45,85,.08); }
.chip.med.active  { border-color: var(--amber); color: var(--amber); background: rgba(245,166,35,.08); }
.chip.low.active  { border-color: var(--green); color: var(--green); background: rgba(0,212,122,.08); }
.sep { width: 1px; height: 16px; background: var(--b2); margin: 0 2px; }

/* â”€â”€ Day group â”€â”€ */
.day-group { margin: 12px 20px; }
.day-hdr {
  font-size: .42rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px;
  padding: 6px 0; border-bottom: 1px solid var(--b2); margin-bottom: 6px;
  display: flex; justify-content: space-between; font-family: var(--ff);
}

/* â”€â”€ Event row â”€â”€ */
.ev-row {
  background: var(--s2); border: 1px solid var(--b2); border-radius: 6px;
  margin-bottom: 4px; overflow: hidden; transition: border-color .12s;
}
.ev-row:hover { border-color: var(--b3); }
.ev-hdr {
  display: grid; grid-template-columns: 68px 22px 1fr 60px 72px 72px 24px;
  gap: 8px; align-items: center; padding: 9px 12px; cursor: pointer;
}
.ev-time { font-size: .42rem; color: var(--muted); font-family: var(--ff); font-variant-numeric: tabular-nums; }
.impact-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.dot-high { background: var(--red); box-shadow: 0 0 5px var(--red); }
.dot-med  { background: var(--amber); }
.dot-low  { background: var(--green); }
.ev-name { font-size: .5rem; font-weight: 600; font-family: var(--ff); color: var(--text); }
.ev-ccy { font-size: .4rem; color: var(--muted); background: var(--s3); padding: 2px 6px; border-radius: 3px; text-align: center; font-family: var(--ff); }
.ev-col { font-size: .46rem; font-weight: 600; text-align: right; font-family: var(--ff); }
.ev-col.pending { color: var(--muted); font-size: .4rem; }
.ev-col.actual-val { color: var(--green); }
.ev-chevron { font-size: .5rem; color: var(--muted); text-align: right; transition: transform .2s; }
.ev-row.open .ev-chevron { transform: rotate(180deg); }

/* â”€â”€ History panel (Forex Factory style) â”€â”€ */
.ev-hist { display: none; padding: 12px 14px; background: var(--s3); border-top: 1px solid var(--b2); }
.ev-row.open .ev-hist { display: block; }
.hist-label { font-size: .4rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-family: var(--ff); }
.hist-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 6px; }
.hist-item { background: var(--s2); border: 1px solid var(--b2); border-radius: 5px; padding: 8px 10px; }
.hi-date { font-size: .38rem; color: var(--muted); font-family: var(--ff); margin-bottom: 3px; }
.hi-val { font-size: .85rem; font-weight: 800; font-family: var(--fd); }
.hi-prev { font-size: .38rem; color: var(--muted); font-family: var(--ff); margin-top: 2px; }
.hi-chg-up { color: var(--green); } .hi-chg-dn { color: var(--red); }
.hist-loading { font-size: .44rem; color: var(--muted); font-family: var(--ff); animation: pulse 1.5s infinite; }
.hist-err { font-size: .44rem; color: var(--red); font-family: var(--ff); }

/* â”€â”€ Geo/Tweets â”€â”€ */
.geo-notice { padding: 24px 20px; }
.geo-notice p { font-size: .5rem; color: var(--muted); font-family: var(--ff); line-height: 1.8; }
.tweet-grid { padding: 12px 20px; display: grid; gap: 8px; }
.tweet-card { background: var(--s2); border: 1px solid var(--b2); border-radius: 6px; padding: 14px; }
.tw-acct { font-size: .44rem; font-weight: 700; font-family: var(--ff); color: var(--blue); margin-bottom: 6px; }
.tw-text { font-size: .48rem; line-height: 1.7; color: var(--t2); font-family: var(--ff); }
.tw-meta { font-size: .38rem; color: var(--muted); margin-top: 6px; font-family: var(--ff); display: flex; gap: 12px; align-items: center; }
.tw-meta a { color: var(--blue); text-decoration: none; }
.tweets-loading { padding: 24px 20px; font-size: .5rem; color: var(--muted); font-family: var(--ff); animation: pulse 1.5s infinite; }
.tweets-err { padding: 24px 20px; font-size: .5rem; color: var(--red); font-family: var(--ff); }

.empty { padding: 32px 20px; text-align: center; font-size: .5rem; color: var(--muted); font-family: var(--ff); }

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
</style>
</head>
<body>

<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR â€”</div>
    <div class="nav-px" id="np-nas">NAS â€”</div>
    <div class="nav-px" id="np-spx">SPX â€”</div>
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">â˜€</button>
    <div class="nav-dot" id="nav-dot"></div>
  </div>
</nav>

<!-- Countdown -->
<div class="cd-bar">
  <span class="cd-label">Next High-Impact:</span>
  <span class="cd-event" id="cdEvent">â€”</span>
  <span class="cd-timer" id="cdTimer">â€”</span>
</div>

<!--
  IMPORTANT NOTE ABOUT DATA SOURCES:
  FRED API provides HISTORICAL data only â€” it does NOT provide:
  - Forward forecasts / consensus estimates
  - Exact future release dates
  - Real-time actual values on release day

  For real forecast data you need: Finnhub.io (free) or Trading Economics (paid)
  The calendar below shows REAL historical FRED data when you expand each event.
  Release dates shown are APPROXIMATE based on typical release schedules.
-->
<div class="fred-notice">
  <strong>â„¹ Data Source:</strong> FRED (Federal Reserve) provides historical observations only â€” no forward forecasts.
  Expanding any event shows <strong>real FRED historical data</strong>.
  Release dates are approximate. For live forecasts, integrate <strong>Finnhub.io</strong> (free API, see roadmap).
</div>

<!-- Tabs -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('week',this)">THIS WEEK</button>
  <button class="tab-btn" onclick="switchTab('next',this)">NEXT WEEK</button>
  <button class="tab-btn" onclick="switchTab('future',this)">UPCOMING</button>
  <button class="tab-btn" onclick="switchTab('geo',this)">ğŸŒ GEOPOLITICAL</button>
</div>

<!-- Filters -->
<div class="filter-bar" id="calFilters">
  <label>Currency:</label>
  <button class="chip active" onclick="setCcy('ALL',this)">ALL</button>
  <button class="chip" onclick="setCcy('USD',this)">USD</button>
  <button class="chip" onclick="setCcy('EUR',this)">EUR</button>
  <button class="chip" onclick="setCcy('GBP',this)">GBP</button>
  <div class="sep"></div>
  <label>Impact:</label>
  <button class="chip high active" onclick="toggleImpact('HIGH',this)">â— HIGH</button>
  <button class="chip med active"  onclick="toggleImpact('MED',this)">â— MED</button>
  <button class="chip low active"  onclick="toggleImpact('LOW',this)">â— LOW</button>
</div>

<!-- Tweet filters (hidden by default) -->
<div class="filter-bar" id="geoFilters" style="display:none;">
  <button class="chip active" onclick="filterGeo('ALL',this)">ALL</button>
  <button class="chip" onclick="filterGeo('Fed',this)">FED</button>
  <button class="chip" onclick="filterGeo('USD',this)">USD</button>
  <button class="chip" onclick="filterGeo('rate',this)">RATES</button>
  <button class="chip" onclick="filterGeo('inflation',this)">INFLATION</button>
  <button class="chip" onclick="filterGeo('China',this)">CHINA</button>
  <button class="chip" onclick="filterGeo('oil',this)">OIL</button>
  <button class="chip" onclick="filterGeo('war',this)">WAR</button>
</div>

<div id="calContent"></div>
<div id="geoContent" style="display:none;"></div>

<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-nas"><span class="ps-sym">NAS100</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-spx"><span class="ps-sym">SPX500</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">â—‹ Loading</span>
  </div>
</div>

<script src="core/security.js"></script>
<script src="core/config.js"></script>
<script src="core/state.js"></script>
<script src="core/api.js"></script>
<script src="core/engines.js"></script>
<script>
const PAGE_ID = 'news';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REAL ECONOMIC EVENTS â€” correct days, correct release schedule
// These are ACTUAL typical release patterns, not made up.
// NFP = first Friday of month, CPI = ~2nd Tuesday, FOMC = 8 per year etc.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REAL_EVENTS = [
  // HIGH IMPACT USD â€” with correct typical weekday
  { name:'Non-Farm Payrolls',        currency:'USD', impact:'HIGH', series:'PAYEMS',          timeIST:'18:30', typicalDOW:5,  weekOfMonth:1,  unit:'K',  note:'First Friday of month' },
  { name:'Unemployment Rate',        currency:'USD', impact:'HIGH', series:'UNRATE',           timeIST:'18:30', typicalDOW:5,  weekOfMonth:1,  unit:'%',  note:'Released with NFP' },
  { name:'CPI (YoY)',                currency:'USD', impact:'HIGH', series:'CPIAUCSL',         timeIST:'18:30', typicalDOW:2,  weekOfMonth:2,  unit:'%',  note:'~2nd Tuesday of month' },
  { name:'Core CPI (YoY)',           currency:'USD', impact:'HIGH', series:'CPILFESL',         timeIST:'18:30', typicalDOW:2,  weekOfMonth:2,  unit:'%',  note:'Released with CPI' },
  { name:'FOMC Interest Rate',       currency:'USD', impact:'HIGH', series:'FEDFUNDS',         timeIST:'23:30', typicalDOW:3,  weekOfMonth:3,  unit:'%',  note:'8 times per year â€” Wed' },
  { name:'GDP Growth Rate (Advance)',currency:'USD', impact:'HIGH', series:'A191RL1Q225SBEA',  timeIST:'18:30', typicalDOW:4,  weekOfMonth:4,  unit:'%',  note:'Quarterly â€” last Wed of first month' },
  { name:'Initial Jobless Claims',   currency:'USD', impact:'MED',  series:'IC4WSA',           timeIST:'18:30', typicalDOW:4,  weekOfMonth:0,  unit:'K',  note:'Every Thursday' },
  { name:'PPI (MoM)',                currency:'USD', impact:'MED',  series:'PPIACO',           timeIST:'18:30', typicalDOW:3,  weekOfMonth:2,  unit:'%',  note:'~2nd Wednesday' },
  { name:'Retail Sales (MoM)',       currency:'USD', impact:'HIGH', series:'RSXFS',            timeIST:'18:30', typicalDOW:4,  weekOfMonth:2,  unit:'%',  note:'~2nd Thursday' },
  // EUR
  { name:'ECB Rate Decision',        currency:'EUR', impact:'HIGH', series:null,               timeIST:'17:15', typicalDOW:4,  weekOfMonth:2,  unit:'%',  note:'~Every 6 weeks â€” Thursday' },
  { name:'Eurozone CPI Flash',       currency:'EUR', impact:'MED',  series:null,               timeIST:'14:30', typicalDOW:3,  weekOfMonth:1,  unit:'%',  note:'Flash estimate â€” Wednesday' },
  // GBP
  { name:'BoE Rate Decision',        currency:'GBP', impact:'HIGH', series:null,               timeIST:'17:00', typicalDOW:4,  weekOfMonth:2,  unit:'%',  note:'~Every 6 weeks â€” Thursday' },
  { name:'UK CPI (YoY)',             currency:'GBP', impact:'MED',  series:null,               timeIST:'12:00', typicalDOW:3,  weekOfMonth:2,  unit:'%',  note:'~3rd Wednesday' },
];

// FOMC exact 2026 dates (real schedule)
const FOMC_2026 = [
  '2026-01-28', '2026-03-18', '2026-05-06', '2026-06-17',
  '2026-07-29', '2026-09-16', '2026-11-04', '2026-12-16'
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activeTab    = 'week';
let ccyFilter    = 'ALL';
let impactFilter = ['HIGH','MED','LOW'];
let allTweets    = [];
let tweetsLoaded = false;
let tweetKw      = 'ALL';
let histCache    = {};  // series â†’ observations[]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Date helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nowIST() {
  return new Date(new Date().toLocaleString('en-US', { timeZone:'Asia/Kolkata' }));
}

// Get Nth occurrence of a weekday in a month (1-indexed)
// weekday: 0=Sun, 1=Monâ€¦6=Sat; nth: 1,2,3,4
function nthWeekdayOfMonth(year, month, weekday, nth) {
  const d = new Date(year, month, 1);
  let count = 0;
  while (d.getMonth() === month) {
    if (d.getDay() === weekday) {
      count++;
      if (count === nth) return new Date(d);
    }
    d.setDate(d.getDate() + 1);
  }
  return null;
}

// Next occurrence of weekday from a given date
function nextWeekday(from, dow) {
  const d = new Date(from);
  const diff = (dow - d.getDay() + 7) % 7 || 7;
  d.setDate(d.getDate() + diff);
  return d;
}

// Build real events for date range
function buildEvents(startDate, endDate) {
  const events = [];
  const now    = nowIST();

  // Iterate through months covered by the range
  const months = new Set();
  const cur = new Date(startDate);
  while (cur <= endDate) {
    months.add(`${cur.getFullYear()}-${cur.getMonth()}`);
    cur.setMonth(cur.getMonth() + 1);
  }

  months.forEach(mk => {
    const [y, m] = mk.split('-').map(Number);

    REAL_EVENTS.forEach(ev => {
      let eventDates = [];

      if (ev.name === 'FOMC Interest Rate') {
        // Use real FOMC dates
        FOMC_2026.forEach(ds => {
          const d = new Date(ds);
          if (d.getFullYear() === y && d.getMonth() === m) eventDates.push(d);
        });
      } else if (ev.name === 'Initial Jobless Claims') {
        // Every Thursday in the month
        const d = new Date(y, m, 1);
        while (d.getMonth() === m) {
          if (d.getDay() === 4) eventDates.push(new Date(d));
          d.setDate(d.getDate() + 1);
        }
      } else if (ev.weekOfMonth > 0) {
        const d = nthWeekdayOfMonth(y, m, ev.typicalDOW, ev.weekOfMonth);
        if (d) eventDates.push(d);
      } else {
        // weekOfMonth = 0 handled above (claims)
      }

      eventDates.forEach(d => {
        if (d >= startDate && d <= endDate) {
          // Set IST time
          const [h, mi] = ev.timeIST.split(':').map(Number);
          d.setHours(0, 0, 0, 0); // normalize
          events.push({
            ...ev,
            date:    new Date(d),
            dateStr: d.toLocaleDateString('en-IN', { weekday:'short', day:'numeric', month:'short', year:'numeric', timeZone:'Asia/Kolkata' }),
            timeStr: ev.timeIST + ' IST',
            key:     `${ev.name}-${d.toISOString().slice(0,10)}`,
            isFuture: d > now,
          });
        }
      });
    });
  });

  // Deduplicate (e.g. NFP + Unemployment same day)
  const seen = new Set();
  return events.filter(e => {
    const k = e.key;
    if (seen.has(k)) return false;
    seen.add(k);
    return true;
  }).sort((a, b) => a.date - b.date);
}

function getWeekRange(offset = 0) {
  const now = nowIST();
  const dow = now.getDay();
  const mon = new Date(now);
  mon.setDate(now.getDate() - (dow === 0 ? 6 : dow - 1) + offset * 7);
  mon.setHours(0, 0, 0, 0);
  const sun = new Date(mon);
  sun.setDate(mon.getDate() + 6);
  sun.setHours(23, 59, 59, 999);
  return { start: mon, end: sun };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
  let events;
  if (activeTab === 'week')   { const r = getWeekRange(0); events = buildEvents(r.start, r.end); }
  else if (activeTab === 'next') { const r = getWeekRange(1); events = buildEvents(r.start, r.end); }
  else {
    // Future: next 8 weeks
    const r1 = getWeekRange(2); const r2 = getWeekRange(9);
    events = buildEvents(r1.start, r2.end);
  }

  // Apply filters
  events = events.filter(e => {
    const cok = ccyFilter === 'ALL' || e.currency === ccyFilter;
    const iok = impactFilter.includes(e.impact);
    return cok && iok;
  });

  const container = document.getElementById('calContent');
  if (!events.length) { container.innerHTML = '<div class="empty">No events match current filters.</div>'; return; }

  // Group by day
  const byDay = {};
  events.forEach(e => {
    if (!byDay[e.dateStr]) byDay[e.dateStr] = [];
    byDay[e.dateStr].push(e);
  });

  container.innerHTML = Object.entries(byDay).map(([day, dayEvs]) => `
    <div class="day-group">
      <div class="day-hdr">
        <span>${day}</span>
        <span>${dayEvs.filter(e => e.impact === 'HIGH').length} HIGH IMPACT</span>
      </div>
      ${dayEvs.map(renderEventRow).join('')}
    </div>
  `).join('');
}

function renderEventRow(e) {
  const dotClass = { HIGH:'dot-high', MED:'dot-med', LOW:'dot-low' }[e.impact] || 'dot-low';
  const hasSeries = !!e.series;
  return `
    <div class="ev-row" id="ev-${e.key}" onclick="toggleEvent('${e.key}','${e.series || ''}','${e.name}')">
      <div class="ev-hdr">
        <div class="ev-time">${e.timeStr}</div>
        <div class="impact-dot ${dotClass}"></div>
        <div class="ev-name">${e.name}</div>
        <div class="ev-ccy">${e.currency}</div>
        <div class="ev-col pending">â€”</div>
        <div class="ev-col pending">Pending</div>
        <div class="ev-chevron">â–¾</div>
      </div>
      <div class="ev-hist" id="hist-${e.key}">
        <div class="hist-label">Previous Releases ${hasSeries ? '(FRED Historical Data)' : '(No FRED series)'}</div>
        <div id="histInner-${e.key}">
          ${hasSeries
            ? '<div class="hist-loading">Loading FRED historyâ€¦</div>'
            : '<div class="hist-err">No FRED series available for this event. Forecast data requires Finnhub or Trading Economics API.</div>'}
        </div>
      </div>
    </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Expand event â€” fetch REAL FRED history
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleEvent(key, series, name) {
  const row = document.getElementById(`ev-${key}`);
  const isOpen = row.classList.contains('open');

  // Collapse all
  document.querySelectorAll('.ev-row.open').forEach(r => r.classList.remove('open'));
  if (isOpen) return;

  row.classList.add('open');
  if (!series) return; // no FRED data for EUR/GBP events

  const inner = document.getElementById(`histInner-${key}`);

  // Use cache
  if (histCache[series]) {
    renderHistGrid(inner, histCache[series], series);
    return;
  }

  inner.innerHTML = '<div class="hist-loading">Fetching FRED dataâ€¦</div>';

  try {
    const res  = await API.fred(series);
    const obs  = (res.observations || [])
      .filter(o => o.value !== '.' && o.value !== '')
      .sort((a, b) => b.date.localeCompare(a.date)) // newest first
      .slice(0, 12); // last 12 readings

    histCache[series] = obs;
    renderHistGrid(inner, obs, series);
  } catch(e) {
    inner.innerHTML = `<div class="hist-err">âš  ${e.message}</div>`;
  }
}

function renderHistGrid(container, obs, series) {
  if (!obs.length) {
    container.innerHTML = '<div class="hist-err">No data returned from FRED.</div>';
    return;
  }

  // Determine if YoY or raw
  const isYoY  = ['CPIAUCSL','CPILFESL'].includes(series);
  const isMoM  = series === 'PAYEMS';
  const sorted = [...obs].sort((a,b) => a.date.localeCompare(b.date)); // asc for calc
  const revObs = [...sorted].reverse(); // newest first for display

  container.innerHTML = `<div class="hist-grid">` + revObs.map((o, i) => {
    const raw  = parseFloat(o.value);
    const prev = revObs[i + 1] ? parseFloat(revObs[i + 1].value) : null;
    let display, prevDisplay, unit = '';

    if (isYoY) {
      // Find the reading 12 months ago from sorted array
      const idx   = sorted.findIndex(s => s.date === o.date);
      const p12   = sorted[idx - 12];
      display     = p12 ? +((raw - parseFloat(p12.value)) / parseFloat(p12.value) * 100).toFixed(2) : raw;
      const pidx  = revObs[i + 1] ? sorted.findIndex(s => s.date === revObs[i+1].date) : -1;
      const pp12  = pidx >= 12 ? sorted[pidx - 12] : null;
      prevDisplay = pp12 ? +((parseFloat(revObs[i+1].value) - parseFloat(pp12.value)) / parseFloat(pp12.value) * 100).toFixed(2) : null;
      unit = '%';
    } else if (isMoM) {
      display     = prev !== null ? +(raw - prev).toFixed(1) : raw;
      const pp    = revObs[i + 2] ? parseFloat(revObs[i + 2].value) : null;
      prevDisplay = (prev !== null && pp !== null) ? +(prev - pp).toFixed(1) : null;
      unit = 'K';
    } else {
      display     = raw;
      prevDisplay = prev;
      unit = '';
    }

    const chg = (display !== null && prevDisplay !== null) ? display - prevDisplay : null;
    const cls = chg > 0 ? 'hi-chg-up' : chg < 0 ? 'hi-chg-dn' : '';

    return `<div class="hist-item">
      <div class="hi-date">${o.date}</div>
      <div class="hi-val ${display > 0 ? 'hi-chg-up' : display < 0 ? 'hi-chg-dn' : ''}">${display != null ? display.toFixed(2) + unit : 'â€”'}</div>
      <div class="hi-prev ${cls}">Prev: ${prevDisplay != null ? prevDisplay.toFixed(2) + unit : 'â€”'} ${chg !== null ? (chg >= 0 ? 'â–²' : 'â–¼') + Math.abs(chg).toFixed(2) : ''}</div>
    </div>`;
  }).join('') + `</div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Countdown
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCountdown() {
  const now    = nowIST();
  const r1     = getWeekRange(0); const r2 = getWeekRange(4);
  const events = buildEvents(r1.start, r2.end)
    .filter(e => e.impact === 'HIGH' && e.date > now);

  if (!events.length) {
    document.getElementById('cdTimer').textContent = 'â€”'; return;
  }

  const next = events[0];
  document.getElementById('cdEvent').textContent = next.name;

  const diff = next.date - now;
  const h    = Math.floor(diff / 3600000);
  const m    = Math.floor((diff % 3600000) / 60000);
  const s    = Math.floor((diff % 60000) / 1000);
  document.getElementById('cdTimer').textContent =
    `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Filters
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setCcy(ccy, el) {
  ccyFilter = ccy;
  document.querySelectorAll('#calFilters .chip').forEach(c => {
    if (['ALL','USD','EUR','GBP'].includes(c.textContent)) c.classList.remove('active');
  });
  el.classList.add('active');
  renderCalendar();
}

function toggleImpact(level, el) {
  if (impactFilter.includes(level)) {
    impactFilter = impactFilter.filter(i => i !== level);
    el.classList.remove('active');
  } else {
    impactFilter.push(level);
    el.classList.add('active');
  }
  renderCalendar();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tab switching
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab, el) {
  activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');

  const cal    = document.getElementById('calContent');
  const geo    = document.getElementById('geoContent');
  const calF   = document.getElementById('calFilters');
  const geoF   = document.getElementById('geoFilters');

  if (tab === 'geo') {
    cal.style.display  = 'none';
    geo.style.display  = 'block';
    calF.style.display = 'none';
    geoF.style.display = 'flex';
    if (!tweetsLoaded) loadTweets();
  } else {
    cal.style.display  = 'block';
    geo.style.display  = 'none';
    calF.style.display = 'flex';
    geoF.style.display = 'none';
    renderCalendar();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Geopolitical tweets (Nitter RSS via worker)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTweets() {
  const geo = document.getElementById('geoContent');
  geo.innerHTML = '<div class="tweets-loading">ğŸŒ Fetching geopolitical feedâ€¦</div>';
  try {
    const data = await API.tweets();
    allTweets  = data.tweets || [];
    tweetsLoaded = true;
    renderTweets('ALL');
  } catch(e) {
    geo.innerHTML = `<div class="tweets-err">âš  ${e.message}<br>Make sure worker-v11.js is deployed.</div>`;
  }
}

function filterGeo(kw, el) {
  tweetKw = kw;
  document.querySelectorAll('#geoFilters .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderTweets(kw);
}

function renderTweets(kw) {
  const geo = document.getElementById('geoContent');
  let tweets = allTweets;
  if (kw !== 'ALL') tweets = tweets.filter(t => t.text.toLowerCase().includes(kw.toLowerCase()));

  if (!tweets.length) { geo.innerHTML = '<div class="empty">No tweets found.</div>'; return; }

  geo.innerHTML = `<div class="tweet-grid">` + tweets.map(t => {
    const ago = timeAgo(new Date(t.date));
    return `<div class="tweet-card">
      <div class="tw-acct">@${esc(t.account)}</div>
      <div class="tw-text">${esc(t.text)}</div>
      <div class="tw-meta">
        <span>${ago}</span>
        ${t.link ? `<a href="${escUrl(t.link)}" target="_blank" rel="noopener">View on X â†’</a>` : ''}
      </div>
    </div>`;
  }).join('') + `</div>`;
}

function timeAgo(d) {
  const s = (Date.now() - d) / 1000;
  if (s < 60)    return 'just now';
  if (s < 3600)  return `${Math.floor(s/60)}m ago`;
  if (s < 86400) return `${Math.floor(s/3600)}h ago`;
  return `${Math.floor(s/86400)}d ago`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Boot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  NavEngine.init(PAGE_ID);
  PriceEngine.start();
  renderCalendar();
  updateCountdown();
  setInterval(updateCountdown, 1000);
});

// Theme
(function() {
  if (localStorage.getItem('tradeos-theme') === 'light') {
    document.body.classList.add('light');
    document.getElementById('theme-toggle') && (document.getElementById('theme-toggle').textContent = 'â˜¾');
  }
})();
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('tradeos-theme', isLight ? 'light' : 'dark');
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.textContent = isLight ? 'â˜¾' : 'â˜€';
}
</script>
</body>
</html>
