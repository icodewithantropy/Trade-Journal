<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS · News</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://notion-proxy.churan756.workers.dev; frame-ancestors 'none';">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#04060a;--s1:#07090f;--s2:#0a0e17;--border:#182030;--b2:#1d2838;--b3:#243344;--text:#d2d8e6;--t2:#9aaabb;--muted:#374a60;--m2:#546880;--green:#00d47a;--red:#ff2d55;--amber:#f5a623;--blue:#3d8eff;--purple:#9b6bff;--cyan:#00c4f5;--nav-h:46px;--strip-h:32px;--ff:'JetBrains Mono',monospace;--fd:'Syne',sans-serif}
html{font-size:16px}
body{background:var(--bg);color:var(--text);font-family:var(--ff);min-height:100vh;overflow-x:hidden;padding-top:var(--nav-h);padding-bottom:var(--strip-h);opacity:0;transition:opacity 220ms ease;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.05) 2px,rgba(0,0,0,.05) 4px)}
#nav{position:fixed;top:0;left:0;right:0;height:var(--nav-h);background:rgba(4,6,10,.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;z-index:1000}
.nav-brand{font-family:var(--fd);font-size:.68rem;font-weight:800;letter-spacing:3px;color:var(--text);white-space:nowrap;margin-right:24px;flex-shrink:0}.nav-brand span{color:var(--green)}
.nav-links{display:flex;gap:2px;flex:1}
.nav-link{padding:5px 12px;font-size:.5rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--m2);border-radius:3px;border:1px solid transparent;cursor:pointer;transition:all .12s;user-select:none;white-space:nowrap}
.nav-link:hover{color:var(--t2);background:rgba(255,255,255,.03);border-color:var(--border)}.nav-link.active{color:var(--text);background:rgba(255,255,255,.04);border-color:var(--b2);position:relative}.nav-link.active::after{content:'';position:absolute;bottom:-1px;left:25%;right:25%;height:1px;background:var(--green)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0}
.nav-px{font-size:.46rem;color:var(--m2);background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:3px 7px;transition:color .4s;white-space:nowrap}
.nav-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);flex-shrink:0}.nav-dot.on{background:var(--green);box-shadow:0 0 5px var(--green);animation:pulse 2.5s infinite}.nav-dot.err{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.6)}}
#price-strip{position:fixed;bottom:0;left:0;right:0;height:var(--strip-h);background:rgba(4,6,10,.97);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 16px;z-index:900}
.ps-pair{display:flex;align-items:center;gap:7px;padding:0 14px;border-right:1px solid var(--border);height:100%}.ps-pair:first-child{padding-left:0}
.ps-sym{font-size:.44rem;color:var(--m2)}.ps-price{font-size:.6rem;font-weight:700;color:var(--text)}.ps-chg{font-size:.46rem}
.strip-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.strip-ts{font-size:.42rem;color:var(--muted)}.strip-src{font-size:.42rem;color:var(--green);letter-spacing:1px}
.wrap{max-width:1140px;margin:0 auto;padding:22px 20px}
.shdr{display:flex;align-items:baseline;gap:10px;margin-bottom:14px}
.shdr-title{font-family:var(--fd);font-size:.8rem;font-weight:700}
.shdr-sub{font-size:.48rem;color:var(--m2);letter-spacing:2px;text-transform:uppercase}
.shdr-line{flex:1;height:1px;background:var(--border)}

/* Week toggle */
.week-toggle{display:flex;gap:6px;margin-bottom:18px}
.wtb{padding:6px 14px;font-size:.5rem;letter-spacing:1.5px;text-transform:uppercase;border:1px solid var(--border);border-radius:4px;background:transparent;color:var(--m2);cursor:pointer;font-family:var(--ff);transition:all .12s}
.wtb.on,.wtb:hover{border-color:var(--b3);color:var(--text);background:rgba(255,255,255,.03)}

/* Impact filter */
.impact-filter{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.ifb{padding:4px 10px;font-size:.46rem;letter-spacing:1.5px;text-transform:uppercase;border:1px solid;border-radius:10px;cursor:pointer;font-family:var(--ff);transition:all .12s;background:transparent}
.ifb-red{color:var(--red);border-color:rgba(255,45,85,.3)}.ifb-red.on,.ifb-red:hover{background:rgba(255,45,85,.1)}
.ifb-amber{color:var(--amber);border-color:rgba(245,166,35,.3)}.ifb-amber.on,.ifb-amber:hover{background:rgba(245,166,35,.1)}
.ifb-blue{color:var(--blue);border-color:rgba(61,142,255,.3)}.ifb-blue.on,.ifb-blue:hover{background:rgba(61,142,255,.1)}
.ifb-all{color:var(--t2);border-color:var(--b2)}.ifb-all.on,.ifb-all:hover{background:rgba(255,255,255,.04);border-color:var(--b3)}

/* Day section */
.day-section{margin-bottom:18px}
.day-hdr{font-size:.5rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:6px 0;border-bottom:1px solid var(--border);margin-bottom:8px;display:flex;align-items:center;gap:10px}
.day-hdr-date{font-family:var(--fd);font-size:.7rem;font-weight:700;color:var(--t2)}
.day-hdr-today{font-size:.44rem;background:rgba(0,212,122,.1);color:var(--green);border:1px solid rgba(0,212,122,.2);border-radius:10px;padding:2px 7px}

/* Event card */
.event{display:flex;align-items:stretch;gap:0;background:var(--s1);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;overflow:hidden;transition:border-color .12s}
.event:hover{border-color:var(--b2)}
.event-impact{width:4px;flex-shrink:0}
.ev-red{background:var(--red)}.ev-amber{background:var(--amber)}.ev-blue{background:var(--blue)}.ev-gray{background:var(--muted)}
.event-body{padding:10px 12px;flex:1;min-width:0}
.event-top{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}
.event-time{font-size:.5rem;color:var(--m2);min-width:48px;flex-shrink:0}
.event-country{font-size:.44rem;background:var(--s2);border:1px solid var(--b2);border-radius:3px;padding:2px 6px;color:var(--t2);flex-shrink:0}
.event-title{font-size:.6rem;color:var(--text);font-weight:600;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.event-impact-tag{font-size:.42rem;letter-spacing:1px;text-transform:uppercase;flex-shrink:0}
.event-vals{display:flex;gap:16px;font-size:.5rem}
.ev-val-lbl{color:var(--muted);display:block;font-size:.4rem;margin-bottom:1px;letter-spacing:1px;text-transform:uppercase}
.ev-val{font-weight:600}
.ev-forecast{color:var(--blue)}.ev-previous{color:var(--m2)}.ev-actual{color:var(--text)}
.ev-actual.beat{color:var(--green)}.ev-actual.miss{color:var(--red)}

/* Countdown */
.countdown{background:rgba(0,212,122,.06);border:1px solid rgba(0,212,122,.15);border-radius:8px;padding:12px 16px;margin-bottom:18px;display:none}
.countdown.show{display:block}
.cd-label{font-size:.46rem;color:var(--m2);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.cd-event{font-size:.7rem;font-weight:700;color:var(--text);margin-bottom:4px}
.cd-timer{font-family:var(--fd);font-size:1.4rem;font-weight:800;color:var(--green)}
.cd-sub{font-size:.48rem;color:var(--m2);margin-top:2px}

/* Empty */
.empty{text-align:center;padding:40px;color:var(--muted);font-size:.6rem;line-height:2}
.empty strong{display:block;font-size:.75rem;color:var(--t2);margin-bottom:6px}
</style>
</head>
<body>

<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR —</div>
    <div class="nav-px" id="np-xau">XAU —</div>
    <div class="nav-px" id="np-dxy">DXY —</div>
    <div class="nav-dot" id="nav-dot"></div>
  </div>
</nav>

<div class="wrap">

  <div class="shdr" style="margin-bottom:16px">
    <div class="shdr-title">Economic Calendar</div>
    <div class="shdr-line"></div>
    <div class="shdr-sub" id="news-source">ForexFactory</div>
  </div>

  <!-- Next high-impact countdown -->
  <div class="countdown" id="countdown">
    <div class="cd-label">Next High-Impact Event</div>
    <div class="cd-event" id="cd-event">—</div>
    <div class="cd-timer" id="cd-timer">—</div>
    <div class="cd-sub" id="cd-sub">—</div>
  </div>

  <!-- Week toggle -->
  <div class="week-toggle">
    <button class="wtb on" id="wtb-this" onclick="switchWeek('this',this)">This Week</button>
    <button class="wtb" id="wtb-next" onclick="switchWeek('next',this)">Next Week</button>
  </div>

  <!-- Impact filter -->
  <div class="impact-filter">
    <button class="ifb ifb-all on" onclick="setImpact('all',this)">All</button>
    <button class="ifb ifb-red" onclick="setImpact('High',this)">● High</button>
    <button class="ifb ifb-amber" onclick="setImpact('Medium',this)">● Medium</button>
    <button class="ifb ifb-blue" onclick="setImpact('Low',this)">● Low</button>
  </div>

  <!-- Calendar feed -->
  <div id="calendar-feed">
    <div class="empty"><strong>Loading…</strong>Fetching ForexFactory calendar</div>
  </div>

</div>

<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-dxy"><span class="ps-sym">DXY</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-xau"><span class="ps-sym">XAU/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">○ Loading</span>
  </div>
</div>

<script>
'use strict';
function esc(s){if(s==null)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;').replace(/\//g,'&#x2F;')}
function escUrl(u){if(!u)return '';const s=String(u).trim();return /^(javascript|data|vbscript):/i.test(s)?'':s}
const ApiKeyStore={_s:'to_ak',get(){try{return JSON.parse(sessionStorage.getItem(this._s)||'{}')}catch{return{}}},td(){return this.get().td||''},fred(){return this.get().fred||''}};
const WORKER='https://notion-proxy.churan756.workers.dev/';
const CURRENT_PAGE='news';
const PAGES=[{id:'analytics',label:'Analytics',file:'index.html'},{id:'macro',label:'Macro',file:'macro.html'},{id:'playbook',label:'Playbook',file:'playbook.html'},{id:'news',label:'News',file:'news.html'},{id:'simulator',label:'Simulator',file:'simulator.html'}];

function initNav(){
  document.getElementById('nav-links').innerHTML=PAGES.map(p=>{
    const active=p.id===CURRENT_PAGE?' active':'';
    const click=p.id!==CURRENT_PAGE?`onclick="navGo('${esc(p.file)}')"` :'';
    return `<div class="nav-link${active}" ${click}>${esc(p.label)}</div>`;
  }).join('');
  document.body.style.opacity='1';
}
function navGo(f){document.body.style.transition='opacity 130ms ease';document.body.style.opacity='0';setTimeout(()=>{window.location.href=f},140)}

async function wFetch(action,params={}){
  const u=new URL(WORKER);u.searchParams.set('action',action);
  for(const[k,v]of Object.entries(params))u.searchParams.set(k,v);
  const keys=ApiKeyStore.get();const hdrs={'Content-Type':'application/json'};
  if(keys.td||keys.fred)hdrs['X-Api-Keys']=JSON.stringify({td:keys.td,fred:keys.fred});
  const res=await fetch(u.toString(),{headers:hdrs,signal:AbortSignal.timeout(12000)});
  const data=await res.json();
  if(!res.ok||data.error)throw new Error(data.error||`HTTP ${res.status}`);
  return data;
}

// Price engine
let _prices={};
async function fetchPrices(){
  try{
    const data=await wFetch('prices',{source:'exchangerate'});
    ['EURUSD','GBPUSD','DXY','XAUUSD'].forEach(sym=>{
      if(!data[sym])return;const prev=_prices[sym]?.price??null;const price=parseFloat(data[sym]);
      if(isNaN(price))return;_prices[sym]={price,prev,change:prev!==null?+(price-prev).toFixed(6):0};
    });
    updatePriceUI(data.source);
  }catch(e){}
}
function updatePriceUI(source){
  [{elId:'ps-eur',sym:'EURUSD',dec:5},{elId:'ps-gbp',sym:'GBPUSD',dec:5},{elId:'ps-dxy',sym:'DXY',dec:3},{elId:'ps-xau',sym:'XAUUSD',dec:2}].forEach(({elId,sym,dec})=>{
    const d=_prices[sym];if(!d)return;const el=document.getElementById(elId);if(!el)return;
    const up=d.change>=0;el.querySelector('.ps-price').textContent=d.price.toFixed(dec);
    el.querySelector('.ps-chg').textContent=(up?'▲':'▼')+' '+Math.abs(d.change).toFixed(dec);
    el.querySelector('.ps-chg').style.color=up?'var(--green)':'var(--red)';
  });
  const np=_prices;
  if(np.EURUSD){const el=document.getElementById('np-eur');el.textContent=`EUR ${np.EURUSD.price.toFixed(5)}`;el.style.color=np.EURUSD.change>=0?'var(--green)':'var(--red)'}
  if(np.XAUUSD){const el=document.getElementById('np-xau');el.textContent=`XAU $${np.XAUUSD.price.toFixed(0)}`;el.style.color=np.XAUUSD.change>=0?'var(--green)':'var(--red)'}
  if(np.DXY){document.getElementById('np-dxy').textContent=`DXY ${np.DXY.price.toFixed(3)}`}
  document.getElementById('strip-ts').textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('strip-src').textContent=source==='twelvedata'?'● Live':'● Hourly';
  document.getElementById('strip-src').style.color='var(--green)';
}

// ── NEWS STATE ────────────────────────────────────────────
let _events=[], _week='this', _impact='all';

async function loadNews(){
  document.getElementById('news-source').textContent='Loading…';
  try{
    const data=await wFetch('news');
    _events = Array.isArray(data) ? data : [];
    document.getElementById('news-source').textContent=`ForexFactory · ${_events.length} events`;
    document.getElementById('nav-dot').className='nav-dot on';
    renderCalendar();
    startCountdown();
  }catch(e){
    document.getElementById('news-source').textContent='Error: '+e.message.slice(0,40);
    document.getElementById('nav-dot').className='nav-dot err';
    document.getElementById('calendar-feed').innerHTML=`<div class="empty"><strong>Could not load calendar</strong>ForexFactory may be unavailable · Try refreshing<br><span style="color:var(--muted);font-size:.5rem">${esc(e.message)}</span></div>`;
  }
}

function switchWeek(w,btn){
  _week=w;
  document.querySelectorAll('.wtb').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderCalendar();
}

function setImpact(imp,btn){
  _impact=imp;
  document.querySelectorAll('.ifb').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderCalendar();
}

function impactColor(impact){
  const i=(impact||'').toLowerCase();
  if(i==='high')   return {cls:'ev-red',   color:'var(--red)',   tag:'High'};
  if(i==='medium') return {cls:'ev-amber',  color:'var(--amber)', tag:'Med'};
  if(i==='low')    return {cls:'ev-blue',   color:'var(--blue)',  tag:'Low'};
  return {cls:'ev-gray', color:'var(--muted)', tag:'—'};
}

function renderCalendar(){
  const feed = document.getElementById('calendar-feed');
  if(!_events.length){ feed.innerHTML='<div class="empty"><strong>No events</strong>Calendar data not available</div>'; return; }

  // Filter by week
  const now = new Date();
  const filtered = _events.filter(ev => {
    if(!ev.date) return false;
    const d = new Date(ev.date);
    if(isNaN(d)) return false;
    const dow = d.getDay();
    const thisMonday = new Date(now); thisMonday.setDate(now.getDate()-(now.getDay()===0?6:now.getDay()-1)); thisMonday.setHours(0,0,0,0);
    const thisSunday = new Date(thisMonday); thisSunday.setDate(thisMonday.getDate()+6); thisSunday.setHours(23,59,59,999);
    const nextMonday = new Date(thisMonday); nextMonday.setDate(thisMonday.getDate()+7);
    const nextSunday = new Date(nextMonday); nextSunday.setDate(nextMonday.getDate()+6); nextSunday.setHours(23,59,59,999);
    if(_week==='this') return d>=thisMonday && d<=thisSunday;
    return d>=nextMonday && d<=nextSunday;
  }).filter(ev => {
    if(_impact==='all') return true;
    return (ev.impact||'').toLowerCase()===_impact.toLowerCase();
  });

  if(!filtered.length){
    feed.innerHTML='<div class="empty"><strong>No events</strong>No events match the selected filters</div>';
    return;
  }

  // Group by day
  const byDay={};
  filtered.forEach(ev=>{
    const d=new Date(ev.date);
    const key=d.toISOString().slice(0,10);
    if(!byDay[key]) byDay[key]={date:d,events:[]};
    byDay[key].events.push(ev);
  });

  const todayKey=now.toISOString().slice(0,10);
  let html='';

  Object.entries(byDay).sort(([a],[b])=>a.localeCompare(b)).forEach(([key,{date,events}])=>{
    const isToday=key===todayKey;
    const dayLbl=date.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
    html+=`<div class="day-section">
      <div class="day-hdr">
        <span class="day-hdr-date">${esc(dayLbl)}</span>
        ${isToday?'<span class="day-hdr-today">TODAY</span>':''}
        <span style="margin-left:auto;font-size:.44rem">${events.length} event${events.length!==1?'s':''}</span>
      </div>`;

    events.forEach(ev=>{
      const imp=impactColor(ev.impact);
      // Time formatting — FF uses various formats
      let timeStr='—';
      try{
        if(ev.date){
          const d=new Date(ev.date);
          if(!isNaN(d)) timeStr=d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true});
        }
      }catch{}

      // Beat/miss detection
      let actualClass='ev-actual';
      if(ev.actual && ev.forecast){
        const a=parseFloat(ev.actual), f=parseFloat(ev.forecast);
        if(!isNaN(a)&&!isNaN(f)){ actualClass='ev-actual '+(a>=f?'beat':'miss'); }
      }

      html+=`<div class="event">
        <div class="event-impact ${imp.cls}"></div>
        <div class="event-body">
          <div class="event-top">
            <span class="event-time">${esc(timeStr)}</span>
            <span class="event-country">${esc(ev.country||'—')}</span>
            <span class="event-title">${esc(ev.title||ev.name||'—')}</span>
            <span class="event-impact-tag" style="color:${imp.color}">${esc(imp.tag)}</span>
          </div>
          <div class="event-vals">
            <div><span class="ev-val-lbl">Forecast</span><span class="ev-val ev-forecast">${esc(ev.forecast||'—')}</span></div>
            <div><span class="ev-val-lbl">Previous</span><span class="ev-val ev-previous">${esc(ev.previous||'—')}</span></div>
            <div><span class="ev-val-lbl">Actual</span><span class="ev-val ${actualClass}">${esc(ev.actual||'Pending')}</span></div>
          </div>
        </div>
      </div>`;
    });
    html+='</div>';
  });

  feed.innerHTML=html;
}

// ── COUNTDOWN to next high-impact event ──────────────────
function startCountdown(){
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

function updateCountdown(){
  const now=new Date();
  const upcoming=_events.filter(ev=>{
    const d=new Date(ev.date);
    return !isNaN(d) && d>now && (ev.impact||'').toLowerCase()==='high';
  }).sort((a,b)=>new Date(a.date)-new Date(b.date));

  if(!upcoming.length){ document.getElementById('countdown').classList.remove('show'); return; }

  const next=upcoming[0];
  const d=new Date(next.date);
  const diff=d-now;
  const h=Math.floor(diff/3600000);
  const m=Math.floor((diff%3600000)/60000);
  const s=Math.floor((diff%60000)/1000);

  document.getElementById('countdown').classList.add('show');
  document.getElementById('cd-event').textContent=next.title||next.name||'—';
  document.getElementById('cd-timer').textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  document.getElementById('cd-sub').textContent=`${next.country||''} · ${d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})} ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}`;
}

// ── BOOT ─────────────────────────────────────────────────
window.addEventListener('load',()=>{
  initNav();
  fetchPrices();
  setInterval(fetchPrices,300_000);
  loadNews();
  setInterval(loadNews,1_800_000); // refresh every 30min
});
</script>
</body>
</html>
