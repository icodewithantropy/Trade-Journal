<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS · Macro</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://notion-proxy.churan756.workers.dev ; frame-ancestors 'none';">
<link rel="icon" href="data:,">
<link rel="stylesheet" href="core/style.css">
<style>
/* ── Macro mobile-first grid ─────────────────────────────── */
.macro-kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px}
@media(min-width:640px){.macro-kpi-grid{grid-template-columns:repeat(4,1fr)}}

/* Central banks — horizontal scroll on small screens */
.cb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
@media(max-width:520px){
  .cb-grid{grid-template-columns:1fr;gap:8px}
  .cb-card{display:flex;align-items:center;gap:14px;text-align:left;padding:12px 14px}
  .cb-rate{font-size:1.4rem;margin-bottom:0}
  .cb-name{margin-bottom:2px}
}
.cb-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;position:relative;overflow:hidden;transition:border-color .15s}
.cb-card:hover{border-color:var(--b3)}
.cb-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.cb-fed::before{background:linear-gradient(90deg,transparent,var(--amber),transparent)}
.cb-ecb::before{background:linear-gradient(90deg,transparent,var(--blue),transparent)}
.cb-boe::before{background:linear-gradient(90deg,transparent,var(--cyan),transparent)}
.cb-name{font-size:.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.cb-rate{font-family:var(--fd);font-size:1.6rem;font-weight:800;margin-bottom:3px}
.cb-date{font-size:.44rem;color:var(--m2);margin-bottom:6px}
.cb-bias{font-size:.44rem;display:inline-block;padding:2px 9px;border-radius:10px}

/* Sparklines — stack on mobile */
.spark-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
@media(max-width:640px){.spark-row{grid-template-columns:1fr}}
.spark-card{background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:12px}

/* AI panel mobile */
.ai-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.ai-chip{font-size:.5rem;padding:5px 10px;border-radius:20px;background:var(--s2);border:1px solid var(--border);color:var(--t2);cursor:pointer;transition:all .15s;white-space:nowrap}
.ai-chip:hover{background:var(--s3);color:var(--text);border-color:var(--b3)}
.ai-inp-row{display:flex;gap:8px;align-items:center}
@media(max-width:500px){.ai-inp-row{flex-direction:column}}
@media(max-width:500px){#ai-send-btn{width:100%;justify-content:center}}

/* History table — scrollable on mobile */
.hist-tbl-wrap{overflow-x:auto;margin-bottom:24px;-webkit-overflow-scrolling:touch}
.hist-tbl-wrap table{min-width:480px}

/* Retry button */
.retry-btn{font-size:.5rem;padding:5px 12px;border-radius:6px;border:1px solid var(--border);background:var(--s2);color:var(--t2);cursor:pointer;margin-left:8px}
.retry-btn:hover{background:var(--s3);color:var(--text)}

.nokey-msg{background:rgba(245,166,35,.06);border:1px solid rgba(245,166,35,.18);border-radius:8px;padding:18px;font-size:.6rem;color:var(--t2);line-height:1.8;margin-bottom:18px}
.nokey-msg strong{color:var(--amber)}

/* Loading skeleton */
.macro-loading{text-align:center;padding:32px;color:var(--muted);font-size:.55rem;letter-spacing:2px}
.macro-loading::after{content:'';animation:dots 1.2s infinite}
@keyframes dots{0%{content:''} 33%{content:'.'} 66%{content:'..'} 100%{content:'...'}}
</style>
</head>
<body>

<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR —</div>
    <div class="nav-px" id="np-nas">NAS —</div>
    <div class="nav-px" id="np-spx">SPX —</div>
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">☀</button>
    <div class="nav-dot" id="nav-dot"></div>
  </div>
</nav>
<div id="alert-bar"></div>

<div class="wrap">

  <div class="shdr" style="margin-bottom:20px">
    <div class="shdr-title">Macro Intelligence</div>
    <div class="shdr-line"></div>
    <div class="shdr-sub" id="macro-status">Loading…</div>
    <button class="retry-btn" onclick="MacroEngine.fetch()" title="Reload macro data">↺ Retry</button>
  </div>

  <!-- Central Banks -->
  <div class="shdr"><div class="shdr-title" style="font-size:.65rem">Central Banks</div><div class="shdr-line"></div></div>
  <div class="cb-grid">
    <div class="cb-card cb-fed">
      <div class="cb-name">Fed Funds Rate</div>
      <div class="cb-rate" id="cb-fed" style="color:var(--amber)">—</div>
      <div class="cb-date" id="cb-fed-d">—</div>
      <div class="cb-bias" id="cb-fed-b">—</div>
    </div>
    <div class="cb-card cb-ecb">
      <div class="cb-name">ECB Rate</div>
      <div class="cb-rate" id="cb-ecb" style="color:var(--blue)">—</div>
      <div class="cb-date" id="cb-ecb-d">—</div>
      <div class="cb-bias" id="cb-ecb-b">—</div>
    </div>
    <div class="cb-card cb-boe">
      <div class="cb-name">BoE Base Rate</div>
      <div class="cb-rate" id="cb-boe" style="color:var(--cyan)">—</div>
      <div class="cb-date" id="cb-boe-d">—</div>
      <div class="cb-bias" id="cb-boe-b">—</div>
    </div>
  </div>

  <!-- US Macro KPIs -->
  <div class="shdr"><div class="shdr-title" style="font-size:.65rem">US Macro</div><div class="shdr-line"></div><div class="shdr-sub" id="fred-status">FRED</div></div>
  <div id="nokey-msg" class="nokey-msg" style="display:none">
    <strong>FRED API key not set.</strong> Add your free key to see live macro data.<br>
    Get one free at <strong>api.stlouisfed.org/api/requestAPIKey.html</strong><br>
    Then open your browser console and run: <code style="color:var(--green);font-family:monospace">ApiKeyStore.set({fred:'YOUR_KEY_HERE'})</code>
  </div>
  <div class="macro-kpi-grid" style="margin-bottom:14px">
    <div class="kpi g"><div class="kpi-l">CPI YoY %</div><div class="kpi-v" id="m-cpi">—</div><div class="kpi-s">Core: <span id="m-core">—</span></div></div>
    <div class="kpi a"><div class="kpi-l">NFP MoM</div><div class="kpi-v" id="m-nfp">—</div><div class="kpi-s" id="m-nfp-s">Non-farm payrolls</div></div>
    <div class="kpi b"><div class="kpi-l">Unemployment</div><div class="kpi-v" id="m-unemp">—</div><div class="kpi-s" id="m-unemp-s">U3 Rate</div></div>
    <div class="kpi p"><div class="kpi-l">GDP QoQ %</div><div class="kpi-v" id="m-gdp">—</div><div class="kpi-s" id="m-gdp-s">Real growth</div></div>
  </div>

  <!-- Sparklines -->
  <div class="spark-row">
    <div class="spark-card">
      <div class="chart-lbl">CPI YoY Trend <span id="sp-cpi-v" style="color:var(--text)"></span></div>
      <svg id="sp-cpi" viewBox="0 0 300 60" height="60"></svg>
    </div>
    <div class="spark-card">
      <div class="chart-lbl">NFP MoM Trend <span id="sp-nfp-v" style="color:var(--text)"></span></div>
      <svg id="sp-nfp" viewBox="0 0 300 60" height="60"></svg>
    </div>
    <div class="spark-card">
      <div class="chart-lbl">Unemployment <span id="sp-u-v" style="color:var(--text)"></span></div>
      <svg id="sp-unemp" viewBox="0 0 300 60" height="60"></svg>
    </div>
  </div>

  <!-- AI Macro Explainer -->
  <div class="shdr"><div class="shdr-title" style="font-size:.65rem">AI Macro Explainer</div><div class="shdr-line"></div></div>
  <div class="ai-panel" style="margin-bottom:18px">
    <div class="ai-hdr">◈ Mistral AI · Macro Analyst</div>
    <div class="ai-chips">
      <span class="ai-chip" onclick="askMacro('What is the current macro regime and what does it mean for EUR/USD?')">Regime → EUR/USD</span>
      <span class="ai-chip" onclick="askMacro('Is the current CPI environment bullish or bearish for gold?')">CPI → Gold</span>
      <span class="ai-chip" onclick="askMacro('What are the key macro risks for the next 4 weeks?')">Key risks</span>
      <span class="ai-chip" onclick="askMacro('Should I be risk-on or risk-off this week based on the macro data?')">Risk-on / off</span>
      <span class="ai-chip" onclick="fullSummary()">Full summary ↗</span>
    </div>
    <div class="ai-response loading" id="ai-response">Tap a question above or type your own below.</div>
    <div class="ai-row">
      <input class="ai-inp" id="ai-inp" placeholder="Ask anything about the macro data…" onkeydown="if(event.key==='Enter')sendAI()">
      <button class="ai-send" id="ai-send-btn" onclick="sendAI()">Ask →</button>
    </div>
  </div>

  <!-- History Table -->
  <div class="shdr"><div class="shdr-title" style="font-size:.65rem">Historical Data</div><div class="shdr-line"></div><div class="shdr-sub">24 Months</div></div>
  <div class="card hist-tbl-wrap" style="padding:0">
    <table class="tbl">
      <thead><tr>
        <th>Month</th><th>CPI YoY%</th><th>Core CPI%</th><th>NFP MoM</th><th>Unemployment</th><th>Fed Rate</th>
      </tr></thead>
      <tbody id="hist-tbody"><tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">Loading…</td></tr></tbody>
    </table>
  </div>

</div>

<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-nas"><span class="ps-sym">NAS100</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-spx"><span class="ps-sym">SPX500</span><span class="ps-price">—</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">○ Loading</span>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="core/config.js"></script>
<script src="core/security.js"></script>
<script src="core/state.js"></script>
<script src="core/api.js"></script>
<script src="core/engines.js"></script>
<script>
'use strict';
const PAGE_ID = 'macro';

// ── Subscribe to state changes ────────────────────────────
State.on('macro', macro => {
  if (macro._noKey) { document.getElementById('nokey-msg').style.display='block'; document.getElementById('fred-status').textContent='No key'; return; }
  if (macro._error) { document.getElementById('fred-status').textContent='Error'; return; }
  renderMacroKPIs(macro);
  renderSparklines(macro);
  renderHistTable(macro);
  renderCentralBanks(macro);
  document.getElementById('fred-status').textContent = 'FRED · Live · ' + new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('nav-dot').className='nav-dot on';
});

function renderCentralBanks(macro) {
  // Fed — from FRED FEDFUNDS series
  const fed = macro.FEDFUNDS;
  if (fed?.length) {
    const l = fed[fed.length-1];
    document.getElementById('cb-fed').textContent = l.value.toFixed(2)+'%';
    document.getElementById('cb-fed-d').textContent = new Date(l.date).toLocaleDateString('en-US',{month:'short',year:'numeric'});
    const bias = l.value>4.5?'Restrictive':l.value>3?'Neutral':'Accommodative';
    const el = document.getElementById('cb-fed-b');
    el.textContent = bias;
    el.style.cssText = 'background:rgba(245,166,35,.1);color:var(--amber);border:1px solid rgba(245,166,35,.2);padding:2px 9px;border-radius:10px;font-size:.46rem;display:inline-block';
  }

  // ECB — hardcoded current rate (ECB not on FRED, update manually when changes)
  // Current ECB deposit facility rate as of Feb 2026: 2.75%
  const ecbRate = 2.75;
  const ecbDate = 'Jan 2026';
  document.getElementById('cb-ecb').textContent = ecbRate.toFixed(2)+'%';
  document.getElementById('cb-ecb-d').textContent = ecbDate;
  const ecbBias = ecbRate>3?'Restrictive':ecbRate>1.5?'Easing':'Accommodative';
  const ecbEl = document.getElementById('cb-ecb-b');
  ecbEl.textContent = ecbBias;
  ecbEl.style.cssText = 'background:rgba(61,142,255,.1);color:var(--blue);border:1px solid rgba(61,142,255,.2);padding:2px 9px;border-radius:10px;font-size:.46rem;display:inline-block';

  // BoE — hardcoded current rate (BoE not on FRED, update manually when changes)
  // Current BoE base rate as of Feb 2026: 4.50%
  const boeRate = 4.50;
  const boeDate = 'Feb 2026';
  document.getElementById('cb-boe').textContent = boeRate.toFixed(2)+'%';
  document.getElementById('cb-boe-d').textContent = boeDate;
  const boeBias = boeRate>4?'Restrictive':boeRate>2?'Neutral':'Accommodative';
  const boeEl = document.getElementById('cb-boe-b');
  boeEl.textContent = boeBias;
  boeEl.style.cssText = 'background:rgba(0,210,210,.1);color:var(--cyan);border:1px solid rgba(0,210,210,.2);padding:2px 9px;border-radius:10px;font-size:.46rem;display:inline-block';
}

function renderMacroKPIs(macro) {
  const last = arr => arr?.length ? arr[arr.length-1] : null;
  const lc=last(macro.CPIAUCSL), lcore=last(macro.CPILFESL), lu=last(macro.UNRATE), ln=last(macro.PAYEMS), lg=last(macro.A191RL1Q225SBEA);

  if (lc?.yoyPct!=null) {
    document.getElementById('m-cpi').textContent = lc.yoyPct.toFixed(1)+'%';
    const up = lc.yoyPct > (macro.CPIAUCSL[macro.CPIAUCSL.length-2]?.yoyPct??lc.yoyPct);
    document.getElementById('m-cpi').style.color = up?'var(--red)':'var(--green)'; // rising CPI = bad
  }
  if (lcore?.yoyPct!=null) document.getElementById('m-core').textContent = lcore.yoyPct.toFixed(1)+'%';
  if (ln?.mom!=null) {
    const k=Math.round(ln.mom);
    document.getElementById('m-nfp').textContent = (k>=0?'+':'')+k+'K';
    document.getElementById('m-nfp').style.color = k>=0?'var(--green)':'var(--red)';
    document.getElementById('m-nfp-s').textContent = new Date(ln.date).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  }
  if (lu) {
    document.getElementById('m-unemp').textContent = lu.value.toFixed(1)+'%';
    document.getElementById('m-unemp-s').textContent = new Date(lu.date).toLocaleDateString('en-US',{month:'short',year:'numeric'});
  }
  if (lg) {
    document.getElementById('m-gdp').textContent = (lg.value>=0?'+':'')+lg.value.toFixed(1)+'%';
    document.getElementById('m-gdp').style.color = lg.value>=2?'var(--green)':lg.value>=0?'var(--amber)':'var(--red)';
    document.getElementById('m-gdp-s').textContent = new Date(lg.date).toLocaleDateString('en-US',{month:'short',year:'numeric'});
  }
}

function renderSparklines(macro) {
  const cpi=macro.CPIAUCSL||[], nfp=macro.PAYEMS||[], unemp=macro.UNRATE||[];
  if (cpi.length) {
    document.getElementById('sp-cpi-v').textContent = cpi[cpi.length-1].yoyPct?.toFixed(1)+'%'||'';
    Charts.sparkline('sp-cpi', cpi.slice(-24), '#00d47a', 'yoyPct');
  }
  if (nfp.length) {
    document.getElementById('sp-nfp-v').textContent = nfp[nfp.length-1].mom!=null ? (nfp[nfp.length-1].mom>=0?'+':'')+Math.round(nfp[nfp.length-1].mom)+'K' : '';
    Charts.sparkline('sp-nfp', nfp.slice(-12), '#f5a623', 'mom');
  }
  if (unemp.length) {
    document.getElementById('sp-u-v').textContent = unemp[unemp.length-1].value.toFixed(1)+'%';
    Charts.sparkline('sp-unemp', unemp.slice(-24), '#3d8eff', 'value');
  }
}
function renderHistTable(macro) {
  const cpi=macro.CPIAUCSL||[], core=macro.CPILFESL||[], nfp=macro.PAYEMS||[], unemp=macro.UNRATE||[], fed=macro.FEDFUNDS||[];
  const byMonth={};
  const add=(arr,key,fn)=>arr.slice(-24).forEach(d=>{const mk=d.date.slice(0,7);if(!byMonth[mk])byMonth[mk]={month:mk};byMonth[mk][key]=fn(d);});
  add(cpi,  'cpi',   d=>d.yoyPct!=null?d.yoyPct.toFixed(1)+'%':'—');
  add(core, 'core',  d=>d.yoyPct!=null?d.yoyPct.toFixed(1)+'%':'—');
  add(nfp,  'nfp',   d=>d.mom!=null?(d.mom>=0?'+':'')+Math.round(d.mom)+'K':'—');
  add(unemp,'unemp', d=>d.value.toFixed(1)+'%');
  add(fed,  'fed',   d=>d.value.toFixed(2)+'%');
  const months=Object.values(byMonth).sort((a,b)=>b.month.localeCompare(a.month)).slice(0,24);
  document.getElementById('hist-tbody').innerHTML = months.map(m=>{
    const lbl=new Date(m.month+'-01').toLocaleDateString('en-US',{month:'short',year:'numeric'});
    return `<tr><td style="color:var(--text)">${esc(lbl)}</td><td>${esc(m.cpi||'—')}</td><td>${esc(m.core||'—')}</td><td>${esc(m.nfp||'—')}</td><td>${esc(m.unemp||'—')}</td><td style="color:var(--amber)">${esc(m.fed||'—')}</td></tr>`;
  }).join('')||'<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">No data</td></tr>';
}

// ── AI ────────────────────────────────────────────────────
async function askMacro(question) {
  const el  = document.getElementById('ai-response');
  const btn = document.getElementById('ai-send-btn');
  el.className = 'ai-response loading'; el.textContent = 'Analysing…'; btn.disabled = true;
  try {
    const answer = await AIEngine.ask(question, 'analyst');
    el.className = 'ai-response';
    el.textContent = '';
    let i = 0;
    const iv = setInterval(() => { el.textContent += answer[i++]||''; if(i>=answer.length) clearInterval(iv); }, 8);
  } catch(e) {
    el.className='ai-response'; el.textContent='Error: '+e.message;
  }
  btn.disabled=false;
  document.getElementById('ai-inp').value='';
}
function sendAI()    { askMacro(document.getElementById('ai-inp').value.trim()); }
function fullSummary(){ askMacro('Give me a complete macro summary: current regime, inflation trajectory, labor market, growth outlook, and what it all means for EUR/USD, GBP/USD, XAU/USD and DXY this week.'); }

// ── Mistral test — run in console: testMistral() ─────────
window.testMistral = async () => {
  console.log('[Mistral Test] Sending test prompt...');
  try {
    const res = await API.ai('Say "Mistral AI is connected and working." in exactly those words.');
    console.log('[Mistral Test] Response:', res);
    if (res.error) console.error('[Mistral Test] ERROR:', res.error);
    else console.log('[Mistral Test] ✅ SUCCESS:', res.reply);
  } catch(e) {
    console.error('[Mistral Test] FAILED:', e.message);
  }
};

// ── Boot ──────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', () => {
  NavEngine.init(PAGE_ID);
  PriceEngine.start();
  MacroEngine.start();
  document.getElementById('macro-status').textContent = 'Updated '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
});
</script>
<script>
// ── Theme toggle ──────────────────────────────────────────
(function() {
  const saved = localStorage.getItem('tradeos-theme');
  if (saved === 'light') {
    document.body.classList.add('light');
    document.getElementById('theme-toggle') && (document.getElementById('theme-toggle').textContent = '☾');
  }
})();
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('tradeos-theme', isLight ? 'light' : 'dark');
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.textContent = isLight ? '☾' : '☀';
  // Redraw any Chart.js charts after theme change
  setTimeout(() => { if (window.render) render(); }, 50);
}
</script>
</body>
</html>
