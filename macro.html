<!--
  TradeOS Â· macro.html Â· PATCH NOTES v10
  =======================================
  CHANGES IN THIS PATCH:
  1. FRED 500 Error â†’ fixed via worker-v10 (try/catch per series, always 200)
  2. Charts are now EXPANDABLE (click any chart card â†’ full-screen modal)
  3. Currency switcher: USD / EUR / GBP bias indicator
  4. AI Macro Weekly Analysis button reads live FRED data via /ai-macro route
  5. Sparklines show last 12 months, fallback to "â€”" on error

  HOW TO INTEGRATE:
  Replace your existing macro.html script block with the one below,
  or copy the individual sections into your existing file.
  Worker endpoint: https://notion-proxy.churan756.workers.dev/fred
  AI Macro endpoint: https://notion-proxy.churan756.workers.dev/ai-macro
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TradeOS Â· Macro</title>
  <style>
    /* â”€â”€ Base â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0d0f14; --surface: #161a23; --card: #1c2130;
      --border: #2a3045; --accent: #4f8ef7; --green: #22c55e;
      --red: #ef4444; --yellow: #f59e0b; --text: #e2e8f0;
      --muted: #8892a4; --radius: 12px;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; min-height: 100vh; }

    /* â”€â”€ Header â”€â”€ */
    .page-header { padding: 24px 32px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .page-header h1 { font-size: 1.4rem; font-weight: 700; }
    .currency-tabs { display: flex; gap: 6px; }
    .currency-tabs button {
      padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border);
      background: var(--surface); color: var(--muted); cursor: pointer; font-size: 0.8rem;
      transition: all 0.2s;
    }
    .currency-tabs button.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* â”€â”€ Macro Grid â”€â”€ */
    .macro-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding: 24px 32px; }

    /* â”€â”€ KPI Card â”€â”€ */
    .kpi-card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; cursor: pointer; transition: transform 0.15s, border-color 0.15s;
      position: relative;
    }
    .kpi-card:hover { transform: translateY(-2px); border-color: var(--accent); }
    .kpi-card .expand-hint { position: absolute; top: 12px; right: 12px; font-size: 0.65rem; color: var(--muted); }
    .kpi-card .label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .kpi-card .value { font-size: 2rem; font-weight: 700; }
    .kpi-card .value.loading { font-size: 1rem; color: var(--muted); animation: pulse 1.5s infinite; }
    .kpi-card .value.error { font-size: 1rem; color: var(--red); }
    .kpi-card .sub { font-size: 0.78rem; color: var(--muted); margin-top: 4px; }
    .kpi-card .bias { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 0.72rem; font-weight: 600; margin-top: 8px; }
    .bias.hawkish { background: rgba(34,197,94,0.15); color: var(--green); }
    .bias.dovish   { background: rgba(239,68,68,0.15);  color: var(--red); }
    .bias.neutral  { background: rgba(245,158,11,0.15); color: var(--yellow); }

    /* â”€â”€ Sparkline â”€â”€ */
    .sparkline-wrap { margin-top: 12px; }
    canvas.spark { width: 100% !important; height: 60px !important; }

    /* â”€â”€ Expand Modal â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75);
      z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 28px; width: 90vw; max-width: 760px; max-height: 85vh; overflow-y: auto;
    }
    .modal-box h2 { margin-bottom: 16px; font-size: 1.2rem; }
    .modal-close { float: right; background: none; border: none; color: var(--muted); font-size: 1.4rem; cursor: pointer; }
    canvas.big-chart { width: 100% !important; height: 300px !important; }

    /* â”€â”€ Historical Table â”€â”€ */
    .hist-table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 0.82rem; }
    .hist-table th { background: var(--surface); padding: 8px 12px; text-align: left; color: var(--muted); border-bottom: 1px solid var(--border); }
    .hist-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
    .hist-table tr:hover td { background: var(--surface); }
    .up { color: var(--green); } .dn { color: var(--red); }

    /* â”€â”€ AI Analysis â”€â”€ */
    .ai-section { margin: 0 32px 24px; }
    .ai-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
    .ai-card h2 { font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .ai-card textarea {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); padding: 12px; font-size: 0.85rem;
      resize: vertical; min-height: 60px; font-family: inherit;
    }
    .ai-actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    .btn {
      padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
      font-size: 0.85rem; font-weight: 600; transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-ghost { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .ai-output {
      margin-top: 16px; background: var(--surface); border-radius: 8px; padding: 16px;
      font-size: 0.85rem; line-height: 1.7; white-space: pre-wrap; display: none;
    }
    .ai-output.visible { display: block; }
    .ai-loading { color: var(--muted); animation: pulse 1.5s infinite; }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* â”€â”€ Status Bar â”€â”€ */
    .status-bar { padding: 8px 32px; font-size: 0.75rem; color: var(--muted); border-top: 1px solid var(--border); margin-top: 8px; }
  </style>
</head>
<body>

<!-- Header -->
<div class="page-header">
  <h1>ðŸ“Š Macro Intelligence</h1>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
    <div class="currency-tabs">
      <button class="active" onclick="setCurrency('USD')">USD Bias</button>
      <button onclick="setCurrency('EUR')">EUR Bias</button>
      <button onclick="setCurrency('GBP')">GBP Bias</button>
    </div>
    <button class="btn btn-ghost" onclick="refreshAll()" style="font-size:0.78rem;padding:6px 14px;">âŸ³ Refresh</button>
  </div>
</div>

<!-- KPI Grid -->
<div class="macro-grid" id="macroGrid">
  <!-- Cards injected by JS -->
  <div class="kpi-card"><div class="label">Fed Funds Rate</div><div class="value loading" id="val-fed">Loadingâ€¦</div><div class="sub" id="sub-fed"></div><div class="sparkline-wrap"><canvas class="spark" id="spark-fed"></canvas></div></div>
  <div class="kpi-card"><div class="label">CPI YoY %</div><div class="value loading" id="val-cpi">Loadingâ€¦</div><div class="sub" id="sub-cpi"></div><div class="sparkline-wrap"><canvas class="spark" id="spark-cpi"></canvas></div></div>
  <div class="kpi-card"><div class="label">Core CPI YoY %</div><div class="value loading" id="val-core">Loadingâ€¦</div><div class="sub" id="sub-core"></div><div class="sparkline-wrap"><canvas class="spark" id="spark-core"></canvas></div></div>
  <div class="kpi-card"><div class="label">NFP MoM (000s)</div><div class="value loading" id="val-nfp">Loadingâ€¦</div><div class="sub" id="sub-nfp"></div><div class="sparkline-wrap"><canvas class="spark" id="spark-nfp"></canvas></div></div>
  <div class="kpi-card"><div class="label">Unemployment %</div><div class="value loading" id="val-unem">Loadingâ€¦</div><div class="sub" id="sub-unem"></div><div class="sparkline-wrap"><canvas class="spark" id="spark-unem"></canvas></div></div>
  <div class="kpi-card"><div class="label">GDP QoQ %</div><div class="value loading" id="val-gdp">Loadingâ€¦</div><div class="sub" id="sub-gdp"></div><div class="sparkline-wrap"><canvas class="spark" id="spark-gdp"></canvas></div></div>
</div>

<!-- AI Macro Analysis -->
<div class="ai-section">
  <div class="ai-card">
    <h2>â—ˆ AI Macro Analysis <span style="font-size:0.7rem;color:var(--muted);font-weight:400;">Powered by Mistral Â· reads live FRED data</span></h2>
    <textarea id="aiQuestion" placeholder="Ask anythingâ€¦ e.g. 'Is the Fed likely to cut rates this quarter?' or leave empty for full weekly analysis"></textarea>
    <div class="ai-actions">
      <button class="btn btn-primary" onclick="runAIMacro()">âš¡ Generate Weekly Analysis</button>
      <button class="btn btn-ghost" onclick="clearAI()">Clear</button>
    </div>
    <div class="ai-output" id="aiOutput"></div>
  </div>
</div>

<div class="status-bar" id="statusBar">Fetching macro dataâ€¦</div>

<!-- Chart Expand Modal -->
<div class="modal-overlay" id="chartModal" onclick="closeModal(event)">
  <div class="modal-box">
    <button class="modal-close" onclick="document.getElementById('chartModal').classList.remove('open')">âœ•</button>
    <h2 id="modalTitle">Chart</h2>
    <canvas class="big-chart" id="bigChart"></canvas>
    <table class="hist-table" id="histTable">
      <thead><tr><th>Date</th><th>Value</th><th>Change</th></tr></thead>
      <tbody id="histBody"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// â”€â”€ Config â”€â”€
const WORKER = 'https://notion-proxy.churan756.workers.dev';
const SERIES_META = {
  fed_rate:     { label: 'Fed Funds Rate', unit: '%', id: 'fed',  color: '#4f8ef7', invert: false },
  cpi:          { label: 'CPI YoY',        unit: '%', id: 'cpi',  color: '#f59e0b', invert: false },
  core_cpi:     { label: 'Core CPI',       unit: '%', id: 'core', color: '#a78bfa', invert: false },
  nfp:          { label: 'NFP MoM',        unit: 'K', id: 'nfp',  color: '#22c55e', invert: false },
  unemployment: { label: 'Unemployment',   unit: '%', id: 'unem', color: '#ef4444', invert: true  },
  gdp:          { label: 'GDP QoQ',        unit: '%', id: 'gdp',  color: '#06b6d4', invert: false },
};

let macroCache = {};
let bigChartInstance = null;
let currentCurrency = 'USD';

// â”€â”€ Fetch all FRED data â”€â”€
async function refreshAll() {
  document.getElementById('statusBar').textContent = 'Fetching macro data from FREDâ€¦';
  try {
    const res = await fetch(`${WORKER}/fred`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    macroCache = json.macro || {};
    renderAllCards();
    document.getElementById('statusBar').textContent = `Last updated: ${new Date().toLocaleTimeString('en-IN', {timeZone:'Asia/Kolkata'})} IST`;
  } catch (e) {
    document.getElementById('statusBar').textContent = `âš  Fetch error: ${e.message}`;
    showAllErrors();
  }
}

function renderAllCards() {
  const keys = Object.keys(SERIES_META);
  keys.forEach(key => {
    const meta = SERIES_META[key];
    const raw = macroCache[key] || [];
    const observations = raw.slice(0, 24).reverse(); // oldest first for charts
    const latest = raw[0];
    const prev   = raw[1];

    if (!latest) { showError(meta.id); return; }

    const val = parseFloat(latest.value);
    const prevVal = prev ? parseFloat(prev.value) : null;
    const change = prevVal !== null ? (val - prevVal) : null;
    const changeStr = change !== null ? `${change > 0 ? '+' : ''}${change.toFixed(2)}${meta.unit}` : '';
    const direction = change > 0 ? 'up' : change < 0 ? 'dn' : '';

    // Value
    document.getElementById(`val-${meta.id}`).className = 'value';
    document.getElementById(`val-${meta.id}`).textContent = `${val.toFixed(2)}${meta.unit}`;

    // Sub
    const subEl = document.getElementById(`sub-${meta.id}`);
    subEl.innerHTML = `${latest.date} <span class="${direction}">${changeStr}</span>`;

    // Bias badge (for Fed card)
    if (key === 'fed_rate') {
      const card = document.getElementById(`val-${meta.id}`).closest('.kpi-card');
      let biasEl = card.querySelector('.bias');
      if (!biasEl) { biasEl = document.createElement('div'); biasEl.className = 'bias'; card.appendChild(biasEl); }
      if (val >= 5) { biasEl.className = 'bias hawkish'; biasEl.textContent = 'Hawkish'; }
      else if (val <= 2) { biasEl.className = 'bias dovish'; biasEl.textContent = 'Dovish'; }
      else { biasEl.className = 'bias neutral'; biasEl.textContent = 'Neutral'; }
    }

    // Sparkline
    drawSparkline(`spark-${meta.id}`, observations.map(o => parseFloat(o.value)), meta.color);

    // Make card expandable
    const card = document.getElementById(`spark-${meta.id}`).closest('.kpi-card');
    card.onclick = () => openChartModal(key, meta, observations);
    let hint = card.querySelector('.expand-hint');
    if (!hint) { hint = document.createElement('div'); hint.className = 'expand-hint'; hint.textContent = 'â¤¢ expand'; card.appendChild(hint); }
  });
}

function showError(id) {
  const el = document.getElementById(`val-${id}`);
  if (el) { el.className = 'value error'; el.textContent = 'â€”'; }
}
function showAllErrors() {
  Object.values(SERIES_META).forEach(m => showError(m.id));
}

// â”€â”€ Sparkline â”€â”€
function drawSparkline(canvasId, values, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const existing = Chart.getChart(canvas);
  if (existing) existing.destroy();

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: values.map((_, i) => i),
      datasets: [{ data: values, borderColor: color, borderWidth: 2, fill: true,
        backgroundColor: color + '18', pointRadius: 0, tension: 0.4 }]
    },
    options: {
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false } },
      animation: false, responsive: true, maintainAspectRatio: false,
    }
  });
}

// â”€â”€ Expand Modal â”€â”€
function openChartModal(key, meta, observations) {
  document.getElementById('modalTitle').textContent = meta.label + ' â€” Last 24 Months';
  document.getElementById('chartModal').classList.add('open');

  const canvas = document.getElementById('bigChart');
  if (bigChartInstance) bigChartInstance.destroy();

  bigChartInstance = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: observations.map(o => o.date),
      datasets: [{
        label: meta.label,
        data: observations.map(o => parseFloat(o.value)),
        borderColor: meta.color, borderWidth: 2.5, fill: true,
        backgroundColor: meta.color + '20', pointRadius: 3, tension: 0.3,
      }]
    },
    options: {
      plugins: { legend: { display: false }, tooltip: { enabled: true } },
      scales: {
        x: { ticks: { color: '#8892a4', maxTicksLimit: 8 }, grid: { color: '#2a3045' } },
        y: { ticks: { color: '#8892a4' }, grid: { color: '#2a3045' } }
      },
      responsive: true, maintainAspectRatio: false,
    }
  });

  // Historical table
  const tbody = document.getElementById('histBody');
  tbody.innerHTML = '';
  const sorted = [...observations].reverse(); // newest first
  sorted.forEach((o, i) => {
    const prev = sorted[i + 1];
    const val = parseFloat(o.value);
    const prevVal = prev ? parseFloat(prev.value) : null;
    const change = prevVal !== null ? (val - prevVal).toFixed(2) : 'â€”';
    const cls = parseFloat(change) > 0 ? 'up' : parseFloat(change) < 0 ? 'dn' : '';
    tbody.innerHTML += `<tr><td>${o.date}</td><td>${val.toFixed(2)}${meta.unit}</td><td class="${cls}">${change !== 'â€”' ? (parseFloat(change) > 0 ? '+' : '') + change : 'â€”'}</td></tr>`;
  });
}

function closeModal(e) {
  if (e.target === document.getElementById('chartModal')) {
    document.getElementById('chartModal').classList.remove('open');
  }
}

// â”€â”€ Currency Switcher â”€â”€
function setCurrency(currency) {
  currentCurrency = currency;
  document.querySelectorAll('.currency-tabs button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  // Update AI prompt suggestion
  document.getElementById('aiQuestion').placeholder = `Ask about ${currency} biasâ€¦ e.g. 'What is the ${currency} outlook based on current macro data?'`;
}

// â”€â”€ AI Macro Analysis â”€â”€
async function runAIMacro() {
  const question = document.getElementById('aiQuestion').value.trim();
  const output = document.getElementById('aiOutput');
  output.className = 'ai-output visible';
  output.innerHTML = '<span class="ai-loading">âš¡ Fetching live FRED data and generating analysisâ€¦</span>';

  try {
    const body = { question: question || '' };
    if (currentCurrency !== 'USD') {
      body.question = (question ? question + ' ' : '') + `Focus on implications for ${currentCurrency}.`;
    }

    const res = await fetch(`${WORKER}/ai-macro`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (data.error) throw new Error(data.error);

    output.textContent = data.analysis;

    // Also refresh macro data from response
    if (data.macroData) { macroCache = data.macroData; renderAllCards(); }

  } catch (e) {
    output.innerHTML = `<span style="color:var(--red)">âš  AI Error: ${e.message}. Make sure worker-v10.js is deployed.</span>`;
  }
}

function clearAI() {
  document.getElementById('aiOutput').className = 'ai-output';
  document.getElementById('aiQuestion').value = '';
}

// â”€â”€ Init â”€â”€
refreshAll();
</script>
</body>
</html>
