<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeOS Â· Simulator</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' https://notion-proxy.churan756.workers.dev; frame-ancestors 'none';">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#04060a;--s1:#07090f;--s2:#0a0e17;--s3:#0e141f;--border:#182030;--b2:#1d2838;--b3:#243344;--text:#d2d8e6;--t2:#9aaabb;--muted:#374a60;--m2:#546880;--green:#00d47a;--red:#ff2d55;--amber:#f5a623;--blue:#3d8eff;--purple:#9b6bff;--nav-h:46px;--strip-h:32px;--ff:'JetBrains Mono',monospace;--fd:'Syne',sans-serif}
html{font-size:16px}
body{background:var(--bg);color:var(--text);font-family:var(--ff);min-height:100vh;overflow-x:hidden;padding-top:var(--nav-h);padding-bottom:var(--strip-h);opacity:0;transition:opacity 220ms ease;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.05) 2px,rgba(0,0,0,.05) 4px)}
#nav{position:fixed;top:0;left:0;right:0;height:var(--nav-h);background:rgba(4,6,10,.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;z-index:1000}
.nav-brand{font-family:var(--fd);font-size:.68rem;font-weight:800;letter-spacing:3px;color:var(--text);white-space:nowrap;margin-right:24px;flex-shrink:0}.nav-brand span{color:var(--green)}
.nav-links{display:flex;gap:2px;flex:1}
.nav-link{padding:5px 12px;font-size:.5rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--m2);border-radius:3px;border:1px solid transparent;cursor:pointer;transition:all .12s;user-select:none;white-space:nowrap}
.nav-link:hover{color:var(--t2);background:rgba(255,255,255,.03);border-color:var(--border)}.nav-link.active{color:var(--text);background:rgba(255,255,255,.04);border-color:var(--b2);position:relative}.nav-link.active::after{content:'';position:absolute;bottom:-1px;left:25%;right:25%;height:1px;background:var(--green)}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-shrink:0}
.nav-px{font-size:.46rem;color:var(--m2);background:var(--s2);border:1px solid var(--border);border-radius:3px;padding:3px 7px;transition:color .4s;white-space:nowrap}
.nav-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);flex-shrink:0}.nav-dot.on{background:var(--green);box-shadow:0 0 5px var(--green)}.nav-dot.err{background:var(--red)}
#price-strip{position:fixed;bottom:0;left:0;right:0;height:var(--strip-h);background:rgba(4,6,10,.97);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 16px;z-index:900}
.ps-pair{display:flex;align-items:center;gap:7px;padding:0 14px;border-right:1px solid var(--border);height:100%}.ps-pair:first-child{padding-left:0}
.ps-sym{font-size:.44rem;color:var(--m2)}.ps-price{font-size:.6rem;font-weight:700;color:var(--text)}.ps-chg{font-size:.46rem}
.strip-right{margin-left:auto;display:flex;align-items:center;gap:10px}
.strip-ts{font-size:.42rem;color:var(--muted)}.strip-src{font-size:.42rem;color:var(--green);letter-spacing:1px}
.wrap{max-width:1140px;margin:0 auto;padding:22px 20px}
.shdr{display:flex;align-items:baseline;gap:10px;margin-bottom:16px}
.shdr-title{font-family:var(--fd);font-size:.8rem;font-weight:700}
.shdr-sub{font-size:.48rem;color:var(--m2);letter-spacing:2px;text-transform:uppercase}
.shdr-line{flex:1;height:1px;background:var(--border)}
.card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px}
.card.g::before{background:linear-gradient(90deg,transparent,var(--green),transparent)}
.card.b::before{background:linear-gradient(90deg,transparent,var(--blue),transparent)}
.card.a::before{background:linear-gradient(90deg,transparent,var(--amber),transparent)}
.card.p::before{background:linear-gradient(90deg,transparent,var(--purple),transparent)}

/* Two-col layout */
.layout{display:grid;grid-template-columns:340px 1fr;gap:14px;margin-bottom:14px}
@media(max-width:900px){.layout{grid-template-columns:1fr}}

/* Section label */
.sec-lbl{font-size:.44rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:10px}

/* Inputs */
.field{margin-bottom:12px}
.field-label{display:block;font-size:.44rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--m2);margin-bottom:5px}
.field-inp{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:4px;color:var(--text);font-family:var(--ff);font-size:.62rem;padding:8px 12px;outline:none;transition:border-color .15s}
.field-inp:focus{border-color:var(--blue)}.field-inp::placeholder{color:var(--muted)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* Slider */
.slider-wrap{margin-bottom:14px}
.slider{width:100%;accent-color:var(--green);cursor:pointer}
.slider-vals{display:flex;justify-content:space-between;font-size:.44rem;color:var(--muted);margin-top:2px}

/* Calc button */
.calc-btn{width:100%;padding:13px;background:rgba(0,212,122,.1);border:1px solid rgba(0,212,122,.3);border-radius:6px;color:var(--green);font-family:var(--fd);font-size:.72rem;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all .15s;margin-top:4px}
.calc-btn:hover{background:rgba(0,212,122,.18)}.calc-btn:active{transform:scale(.98)}

/* Result card */
.result-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
.r-kpi{background:var(--s2);border:1px solid var(--b2);border-radius:6px;padding:12px;text-align:center}
.r-kpi-l{font-size:.42rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.r-kpi-v{font-family:var(--fd);font-size:1.2rem;font-weight:800;line-height:1}

/* Grade comparison */
.grade-compare{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:18px}
@media(max-width:640px){.grade-compare{grid-template-columns:1fr}}
.grade-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;position:relative;overflow:hidden}
.grade-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.gc-aplus::before{background:var(--green)}.gc-b::before{background:var(--blue)}.gc-c::before{background:var(--amber)}
.gc-grade{font-family:var(--fd);font-size:1.8rem;font-weight:800;margin-bottom:4px}
.gc-wr{font-size:.52rem;color:var(--m2);margin-bottom:12px}
.gc-stat{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:.52rem}
.gc-stat:last-child{border-bottom:none}
.gc-stat-l{color:var(--muted)}.gc-stat-v{font-weight:700}

/* Monte Carlo chart */
.mc-chart{margin-bottom:12px}
svg{display:block;width:100%;overflow:visible}

/* Projection table */
.proj-tbl{width:100%;border-collapse:collapse;font-size:.54rem}
.proj-tbl th{font-size:.42rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding:7px 9px;border-bottom:1px solid var(--border);font-weight:400;text-align:left}
.proj-tbl td{padding:8px 9px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--t2)}
.proj-tbl tr:last-child td{border-bottom:none}

/* Badge */
.badge{display:inline-block;font-size:.42rem;letter-spacing:1.5px;text-transform:uppercase;padding:2px 7px;border-radius:10px}
.bg{background:rgba(0,212,122,.1);color:var(--green);border:1px solid rgba(0,212,122,.2)}
.br{background:rgba(255,45,85,.1);color:var(--red);border:1px solid rgba(255,45,85,.2)}
.ba{background:rgba(245,166,35,.1);color:var(--amber);border:1px solid rgba(245,166,35,.2)}
</style>
</head>
<body>

<nav id="nav">
  <div class="nav-brand">TRADE<span>OS</span></div>
  <div class="nav-links" id="nav-links"></div>
  <div class="nav-right">
    <div class="nav-px" id="np-eur">EUR â€”</div>
    <div class="nav-px" id="np-xau">XAU â€”</div>
    <div class="nav-px" id="np-dxy">DXY â€”</div>
    <div class="nav-dot on" id="nav-dot"></div>
  </div>
</nav>

<div class="wrap">

  <div class="shdr" style="margin-bottom:20px">
    <div class="shdr-title">Trade Simulator</div>
    <div class="shdr-line"></div>
    <div class="shdr-sub">Risk Â· R-Multiple Â· Monte Carlo</div>
  </div>

  <div class="layout">

    <!-- LEFT: Inputs -->
    <div>
      <div class="card g" style="margin-bottom:10px">
        <div class="sec-lbl">Account Settings</div>
        <div class="field">
          <label class="field-label">Account Balance ($)</label>
          <input class="field-inp" id="s-balance" type="number" value="10000" min="100" oninput="recalc()">
        </div>
        <div class="slider-wrap">
          <label class="field-label">Risk Per Trade: <span id="s-risk-lbl" style="color:var(--green)">1.0%</span></label>
          <input class="slider" id="s-risk" type="range" min="0.1" max="5" step="0.1" value="1" oninput="updateRiskLbl();recalc()">
          <div class="slider-vals"><span>0.1%</span><span>1%</span><span>2%</span><span>5%</span></div>
        </div>
      </div>

      <div class="card b" style="margin-bottom:10px">
        <div class="sec-lbl">Trade Parameters</div>
        <div class="field-row" style="margin-bottom:10px">
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Entry Price</label>
            <input class="field-inp" id="s-entry" type="number" placeholder="1.08500" step="0.00001" oninput="recalc()">
          </div>
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Stop Loss</label>
            <input class="field-inp" id="s-sl" type="number" placeholder="1.08200" step="0.00001" oninput="recalc()">
          </div>
        </div>
        <div class="field-row" style="margin-bottom:10px">
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Take Profit 1</label>
            <input class="field-inp" id="s-tp1" type="number" placeholder="1.09000" step="0.00001" oninput="recalc()">
          </div>
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Take Profit 2</label>
            <input class="field-inp" id="s-tp2" type="number" placeholder="1.09500" step="0.00001" oninput="recalc()">
          </div>
        </div>
        <div class="field">
          <label class="field-label">Pair / Pip Value ($)</label>
          <select class="field-inp" id="s-pip" oninput="recalc()">
            <option value="10">EUR/USD Â· $10/pip (standard)</option>
            <option value="10">GBP/USD Â· $10/pip (standard)</option>
            <option value="10">AUD/USD Â· $10/pip (standard)</option>
            <option value="0.073">USD/JPY Â· $0.073/pip (standard)</option>
            <option value="10">XAU/USD (Gold) Â· $10/pip</option>
            <option value="1" selected>Custom â€” enter pip value below</option>
          </select>
        </div>
      </div>

      <div class="card a" style="margin-bottom:10px">
        <div class="sec-lbl">Monte Carlo Projection</div>
        <div class="field-row" style="margin-bottom:10px">
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Win Rate (%)</label>
            <input class="field-inp" id="mc-wr" type="number" value="55" min="1" max="99" oninput="runMonteCarlo()">
          </div>
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Trades to simulate</label>
            <input class="field-inp" id="mc-trades" type="number" value="100" min="10" max="500" oninput="runMonteCarlo()">
          </div>
        </div>
        <div class="field-row">
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Avg Win (R)</label>
            <input class="field-inp" id="mc-win" type="number" value="2" step="0.1" min="0.1" oninput="runMonteCarlo()">
          </div>
          <div class="field" style="margin-bottom:0">
            <label class="field-label">Avg Loss (R)</label>
            <input class="field-inp" id="mc-loss" type="number" value="1" step="0.1" min="0.1" oninput="runMonteCarlo()">
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Results -->
    <div>

      <!-- Position size output -->
      <div class="card g" style="margin-bottom:10px">
        <div class="sec-lbl">Position Size Calculator</div>
        <div class="result-grid">
          <div class="r-kpi"><div class="r-kpi-l">$ Risk Amount</div><div class="r-kpi-v" id="r-dollarrisk" style="color:var(--red)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">Lot Size</div><div class="r-kpi-v" id="r-lots" style="color:var(--green)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">R:R Ratio (TP1)</div><div class="r-kpi-v" id="r-rr1" style="color:var(--blue)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">R:R Ratio (TP2)</div><div class="r-kpi-v" id="r-rr2" style="color:var(--purple)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">Pips to SL</div><div class="r-kpi-v" id="r-slpips" style="color:var(--amber)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">Profit at TP1 ($)</div><div class="r-kpi-v" id="r-profit1" style="color:var(--green)">â€”</div></div>
        </div>
        <div style="padding:10px;background:var(--s2);border-radius:6px;border:1px solid var(--b2);font-size:.56rem;color:var(--t2);line-height:1.7" id="trade-verdict">Enter entry and stop loss to calculate.</div>
      </div>

      <!-- Monte Carlo chart -->
      <div class="card p" style="margin-bottom:10px">
        <div class="sec-lbl" style="display:flex;justify-content:space-between">
          <span>Monte Carlo Equity Projection</span>
          <span id="mc-runs-lbl" style="color:var(--muted)">1000 runs</span>
        </div>
        <div class="mc-chart">
          <svg id="mc-svg" viewBox="0 0 600 180" height="180"></svg>
        </div>
        <div class="result-grid">
          <div class="r-kpi"><div class="r-kpi-l">Median outcome</div><div class="r-kpi-v" id="mc-median" style="color:var(--green)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">Best 10%</div><div class="r-kpi-v" id="mc-p90" style="color:var(--green)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">Worst 10%</div><div class="r-kpi-v" id="mc-p10" style="color:var(--red)">â€”</div></div>
          <div class="r-kpi"><div class="r-kpi-l">Ruin probability</div><div class="r-kpi-v" id="mc-ruin" style="color:var(--red)">â€”</div></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Grade Comparison -->
  <div class="shdr"><div class="shdr-title" style="font-size:.72rem">A+ / B / C Grade Expected Value</div><div class="shdr-line"></div></div>
  <div class="grade-compare" style="margin-bottom:18px">
    <div class="grade-card gc-aplus">
      <div class="gc-grade" style="color:var(--green)">A+</div>
      <div class="gc-wr">Your A+ setup profile</div>
      <div class="gc-stat"><span class="gc-stat-l">Win Rate</span><span class="gc-stat-v" id="gc-aplus-wr" style="color:var(--green)">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">Avg R</span><span class="gc-stat-v" id="gc-aplus-r">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">EV/trade</span><span class="gc-stat-v" id="gc-aplus-ev">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">100 trades</span><span class="gc-stat-v" id="gc-aplus-100">â€”</span></div>
    </div>
    <div class="grade-card gc-b">
      <div class="gc-grade" style="color:var(--blue)">B</div>
      <div class="gc-wr">Your B setup profile</div>
      <div class="gc-stat"><span class="gc-stat-l">Win Rate</span><span class="gc-stat-v" id="gc-b-wr" style="color:var(--blue)">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">Avg R</span><span class="gc-stat-v" id="gc-b-r">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">EV/trade</span><span class="gc-stat-v" id="gc-b-ev">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">100 trades</span><span class="gc-stat-v" id="gc-b-100">â€”</span></div>
    </div>
    <div class="grade-card gc-c">
      <div class="gc-grade" style="color:var(--amber)">C</div>
      <div class="gc-wr">Your C setup profile</div>
      <div class="gc-stat"><span class="gc-stat-l">Win Rate</span><span class="gc-stat-v" id="gc-c-wr" style="color:var(--amber)">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">Avg R</span><span class="gc-stat-v" id="gc-c-r">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">EV/trade</span><span class="gc-stat-v" id="gc-c-ev">â€”</span></div>
      <div class="gc-stat"><span class="gc-stat-l">100 trades</span><span class="gc-stat-v" id="gc-c-100">â€”</span></div>
    </div>
  </div>

  <!-- Projection table -->
  <div class="shdr"><div class="shdr-title" style="font-size:.72rem">Account Growth Projection</div><div class="shdr-line"></div></div>
  <div class="card" style="padding:0;margin-bottom:24px;overflow:auto">
    <table class="proj-tbl">
      <thead><tr><th>Trades</th><th>Conservative (âˆ’1Ïƒ)</th><th>Expected</th><th>Optimistic (+1Ïƒ)</th><th>Account Value</th></tr></thead>
      <tbody id="proj-tbody"></tbody>
    </table>
  </div>

</div>

<div id="price-strip">
  <div class="ps-pair" id="ps-eur"><span class="ps-sym">EUR/USD</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-gbp"><span class="ps-sym">GBP/USD</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-dxy"><span class="ps-sym">DXY</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="ps-pair" id="ps-xau"><span class="ps-sym">XAU/USD</span><span class="ps-price">â€”</span><span class="ps-chg"></span></div>
  <div class="strip-right">
    <span class="strip-ts" id="strip-ts"></span>
    <span class="strip-src" id="strip-src">â—‹ Loading</span>
  </div>
</div>

<script>
'use strict';
function esc(s){if(s==null)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;').replace(/\//g,'&#x2F;')}
function escUrl(u){if(!u)return '';const s=String(u).trim();return /^(javascript|data|vbscript):/i.test(s)?'':s}
const ApiKeyStore={_s:'to_ak',get(){try{return JSON.parse(sessionStorage.getItem(this._s)||'{}')}catch{return{}}},td(){return this.get().td||''}};
const WORKER='https://notion-proxy.churan756.workers.dev/';
const CURRENT_PAGE='simulator';
const PAGES=[{id:'analytics',label:'Analytics',file:'index.html'},{id:'macro',label:'Macro',file:'macro.html'},{id:'playbook',label:'Playbook',file:'playbook.html'},{id:'news',label:'News',file:'news.html'},{id:'simulator',label:'Simulator',file:'simulator.html'}];

function initNav(){
  document.getElementById('nav-links').innerHTML=PAGES.map(p=>{
    const active=p.id===CURRENT_PAGE?' active':'';
    const click=p.id!==CURRENT_PAGE?`onclick="navGo('${esc(p.file)}')"` :'';
    return `<div class="nav-link${active}" ${click}>${esc(p.label)}</div>`;
  }).join('');
  document.body.style.opacity='1';
}
function navGo(f){document.body.style.transition='opacity 130ms ease';document.body.style.opacity='0';setTimeout(()=>{window.location.href=f},140)}

// Prices
let _prices={};
async function fetchPrices(){
  try{
    const u=new URL(WORKER);u.searchParams.set('action','prices');u.searchParams.set('source','exchangerate');
    const keys=ApiKeyStore.get();const hdrs={'Content-Type':'application/json'};
    if(keys.td||keys.fred)hdrs['X-Api-Keys']=JSON.stringify({td:keys.td,fred:keys.fred});
    const res=await fetch(u.toString(),{headers:hdrs,signal:AbortSignal.timeout(10000)});
    const data=await res.json();
    ['EURUSD','GBPUSD','DXY','XAUUSD'].forEach(sym=>{
      if(!data[sym])return;const prev=_prices[sym]?.price??null;const price=parseFloat(data[sym]);
      if(isNaN(price))return;_prices[sym]={price,prev,change:prev!==null?+(price-prev).toFixed(6):0};
    });
    updatePriceUI(data.source);
  }catch(e){}
}
function updatePriceUI(source){
  [{elId:'ps-eur',sym:'EURUSD',dec:5},{elId:'ps-gbp',sym:'GBPUSD',dec:5},{elId:'ps-dxy',sym:'DXY',dec:3},{elId:'ps-xau',sym:'XAUUSD',dec:2}].forEach(({elId,sym,dec})=>{
    const d=_prices[sym];if(!d)return;const el=document.getElementById(elId);if(!el)return;
    const up=d.change>=0;el.querySelector('.ps-price').textContent=d.price.toFixed(dec);
    el.querySelector('.ps-chg').textContent=(up?'â–²':'â–¼')+' '+Math.abs(d.change).toFixed(dec);
    el.querySelector('.ps-chg').style.color=up?'var(--green)':'var(--red)';
  });
  const np=_prices;
  if(np.EURUSD){const el=document.getElementById('np-eur');el.textContent=`EUR ${np.EURUSD.price.toFixed(5)}`;el.style.color=np.EURUSD.change>=0?'var(--green)':'var(--red)'}
  if(np.XAUUSD){const el=document.getElementById('np-xau');el.textContent=`XAU $${np.XAUUSD.price.toFixed(0)}`;el.style.color=np.XAUUSD.change>=0?'var(--green)':'var(--red)'}
  if(np.DXY){document.getElementById('np-dxy').textContent=`DXY ${np.DXY.price.toFixed(3)}`}
  document.getElementById('strip-ts').textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById('strip-src').textContent=source==='twelvedata'?'â— Live':'â— Hourly';
  document.getElementById('strip-src').style.color='var(--green)';
}

// â”€â”€ RISK CALCULATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRiskLbl(){
  document.getElementById('s-risk-lbl').textContent=parseFloat(document.getElementById('s-risk').value).toFixed(1)+'%';
}

function recalc(){
  const balance  = parseFloat(document.getElementById('s-balance').value)||10000;
  const riskPct  = parseFloat(document.getElementById('s-risk').value)||1;
  const entry    = parseFloat(document.getElementById('s-entry').value);
  const sl       = parseFloat(document.getElementById('s-sl').value);
  const tp1      = parseFloat(document.getElementById('s-tp1').value);
  const tp2      = parseFloat(document.getElementById('s-tp2').value);
  const pipVal   = parseFloat(document.getElementById('s-pip').value)||10;

  const dollarRisk = balance * riskPct / 100;
  document.getElementById('r-dollarrisk').textContent = '$'+dollarRisk.toFixed(2);

  if(entry && sl){
    const slPips = Math.abs(entry - sl) * 10000; // for 4-decimal pairs
    document.getElementById('r-slpips').textContent = slPips.toFixed(1)+' pips';

    // Lot size = dollarRisk / (slPips Ã— pipValue)
    const lots = dollarRisk / (slPips * pipVal);
    document.getElementById('r-lots').textContent = lots.toFixed(2)+' lots';

    if(tp1){
      const tp1Pips = Math.abs(tp1 - entry) * 10000;
      const rr1 = tp1Pips / slPips;
      document.getElementById('r-rr1').textContent = '1:'+rr1.toFixed(2);
      const profit1 = (tp1Pips * pipVal * lots);
      document.getElementById('r-profit1').textContent = '$'+profit1.toFixed(2);
    }
    if(tp2){
      const tp2Pips = Math.abs(tp2 - entry) * 10000;
      const rr2 = tp2Pips / slPips;
      document.getElementById('r-rr2').textContent = '1:'+rr2.toFixed(2);
    }

    // Verdict
    const rr1val = tp1 ? Math.abs(tp1-entry)/Math.abs(entry-sl) : 0;
    let verdict='';
    if(rr1val >= 3)      verdict='ðŸŸ¢ <strong>Excellent R:R</strong> â€” minimum confluence to consider this setup: A+ only';
    else if(rr1val >= 2) verdict='ðŸŸ¡ <strong>Acceptable R:R</strong> â€” this is minimum for a B-grade setup';
    else if(rr1val >= 1) verdict='ðŸŸ  <strong>Low R:R</strong> â€” only take this if confluence is exceptional (A+ with displacement)';
    else if(rr1val > 0)  verdict='ðŸ”´ <strong>Do not take this trade</strong> â€” R:R below 1:1 destroys your edge over time';
    else                  verdict='Enter TP1 to evaluate R:R quality';
    document.getElementById('trade-verdict').innerHTML = verdict;
  }
}

// â”€â”€ MONTE CARLO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runMonteCarlo(){
  const wr     = parseFloat(document.getElementById('mc-wr').value)/100 || 0.55;
  const trades = Math.min(parseInt(document.getElementById('mc-trades').value)||100, 500);
  const avgWin = parseFloat(document.getElementById('mc-win').value)||2;
  const avgLoss= parseFloat(document.getElementById('mc-loss').value)||1;
  const balance= parseFloat(document.getElementById('s-balance').value)||10000;
  const riskPct= parseFloat(document.getElementById('s-risk').value)||1;
  const RUNS   = 500;

  // Run simulations
  const endResults = [];
  const allPaths   = [];
  let ruinCount    = 0;

  for(let r=0;r<RUNS;r++){
    let eq=0;
    const path=[0];
    let ruined=false;
    for(let t=0;t<trades;t++){
      const win = Math.random()<wr;
      eq += win ? avgWin : -avgLoss;
      if(eq <= -balance/riskPct*100) { ruined=true; break; } // ruin if account wiped
      path.push(+(eq).toFixed(2));
    }
    if(ruined) ruinCount++;
    endResults.push(eq);
    if(r<50) allPaths.push(path); // only draw 50 paths for perf
  }

  endResults.sort((a,b)=>a-b);
  const p10    = endResults[Math.floor(RUNS*0.1)];
  const p50    = endResults[Math.floor(RUNS*0.5)];
  const p90    = endResults[Math.floor(RUNS*0.9)];
  const ruinPct= (ruinCount/RUNS*100).toFixed(1);

  // Update KPIs
  const fmt = r => (r>=0?'+':'')+r.toFixed(1)+'R';
  document.getElementById('mc-median').textContent = fmt(p50);
  document.getElementById('mc-median').style.color = p50>=0?'var(--green)':'var(--red)';
  document.getElementById('mc-p90').textContent    = fmt(p90);
  document.getElementById('mc-p10').textContent    = fmt(p10);
  document.getElementById('mc-p10').style.color    = p10>=0?'var(--green)':'var(--red)';
  document.getElementById('mc-ruin').textContent   = ruinPct+'%';
  document.getElementById('mc-ruin').style.color   = parseFloat(ruinPct)>5?'var(--red)':'var(--green)';
  document.getElementById('mc-runs-lbl').textContent = RUNS+' runs Â· '+trades+' trades each';

  drawMC(allPaths, trades, p10, p50, p90);
  renderProjectionTable(p10, p50, p90, balance, riskPct, avgWin, wr, trades);
  renderGradeComparison();
}

function drawMC(paths, trades, p10, p50, p90){
  const svg = document.getElementById('mc-svg');
  const W=600,H=180,pL=40,pR=8,pT=10,pB=22;
  const w=W-pL-pR, h=H-pT-pB;
  const allVals = paths.flat();
  const minV=Math.min(...allVals,p10)-1, maxV=Math.max(...allVals,p90)+1;
  const px=i=>pL+(i/trades)*w;
  const py=v=>pT+h-((v-minV)/(maxV-minV||1))*h;
  const zY=py(0);

  let out=`<line x1="${pL}" x2="${W-pR}" y1="${zY}" y2="${zY}" stroke="rgba(255,255,255,.08)" stroke-width="1" stroke-dasharray="4 3"/>`;

  // Draw paths (faint)
  paths.forEach(path=>{
    const pts=path.map((v,i)=>`${i===0?'M':'L'}${px(i).toFixed(1)},${py(v).toFixed(1)}`).join(' ');
    out+=`<path d="${pts}" fill="none" stroke="rgba(155,107,255,.12)" stroke-width=".8"/>`;
  });

  // Draw percentile bands as reference lines
  const refLines=[{v:p90,c:'var(--green)',lbl:'P90'},{v:p50,c:'#ffffff',lbl:'P50'},{v:p10,c:'var(--red)',lbl:'P10'}];
  refLines.forEach(({v,c,lbl})=>{
    out+=`<line x1="${pL}" x2="${W-pR}" y1="${py(v)}" y2="${py(v)}" stroke="${c}" stroke-width="1" stroke-dasharray="6 4" opacity=".5"/>`;
    out+=`<text x="${pL-4}" y="${py(v)+4}" fill="${c}" font-size="8" font-family="JetBrains Mono" text-anchor="end" opacity=".7">${(v>=0?'+':'')+v.toFixed(0)}R</text>`;
  });

  // X axis labels
  [0,Math.floor(trades/4),Math.floor(trades/2),Math.floor(3*trades/4),trades].forEach(t=>{
    out+=`<text x="${px(t)}" y="${H-4}" fill="var(--muted)" font-size="8" font-family="JetBrains Mono" text-anchor="middle">${t}</text>`;
  });

  svg.innerHTML=out;
}

function renderProjectionTable(p10,p50,p90,balance,riskPct,avgWin,wr,totalTrades){
  const riskAmt = balance*riskPct/100;
  const ev = wr*avgWin - (1-wr)*1; // simplified EV
  const rows=[25,50,100,200,500].filter(n=>n<=totalTrades*5);
  document.getElementById('proj-tbody').innerHTML=rows.map(n=>{
    const std   = Math.sqrt(n*wr*(1-wr))*(avgWin+1);
    const exp   = ev*n;
    const cons  = exp - std;
    const opt   = exp + std;
    const accExp= balance + exp*riskAmt;
    const c     = exp>=0?'var(--green)':'var(--red)';
    return `<tr>
      <td style="color:var(--t2)">${n}</td>
      <td style="color:var(--red)">${cons.toFixed(1)}R</td>
      <td style="color:${c};font-weight:700">${exp.toFixed(1)}R</td>
      <td style="color:var(--green)">${opt.toFixed(1)}R</td>
      <td style="color:var(--t2)">$${accExp.toLocaleString('en-US',{maximumFractionDigits:0})}</td>
    </tr>`;
  }).join('');
}

function renderGradeComparison(){
  // Preset profiles â€” A+ is your best setup, B is average, C is marginal
  const profiles = [
    {id:'aplus', wr:65, avgWin:2.5, avgLoss:1, color:'var(--green)'},
    {id:'b',     wr:55, avgWin:2.0, avgLoss:1, color:'var(--blue)'},
    {id:'c',     wr:45, avgWin:1.5, avgLoss:1, color:'var(--amber)'},
  ];
  profiles.forEach(p=>{
    const ev = p.wr/100*p.avgWin - (1-p.wr/100)*p.avgLoss;
    const ev100 = ev*100;
    document.getElementById(`gc-${p.id}-wr`).textContent = p.wr+'%';
    document.getElementById(`gc-${p.id}-r`).textContent  = p.avgWin+'R avg';
    document.getElementById(`gc-${p.id}-ev`).textContent = (ev>=0?'+':'')+ev.toFixed(3)+'R';
    document.getElementById(`gc-${p.id}-ev`).style.color = ev>=0?'var(--green)':'var(--red)';
    document.getElementById(`gc-${p.id}-100`).textContent= (ev100>=0?'+':'')+ev100.toFixed(1)+'R';
    document.getElementById(`gc-${p.id}-100`).style.color= ev100>=0?'var(--green)':'var(--red)';
  });
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load',()=>{
  initNav();
  fetchPrices();
  setInterval(fetchPrices,300_000);
  recalc();
  runMonteCarlo();
  renderGradeComparison();
  document.getElementById('nav-dot').className='nav-dot on';
});
</script>
</body>
</html>
